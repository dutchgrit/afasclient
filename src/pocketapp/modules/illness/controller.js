angular.module("illness.controller",[]).controller("IllnessController",["$scope","$q","$state","$ionicPopup","$timeout","SearchService","ModalSearchService","IllnessServiceFactory","UserService","DatePickerService","EmployeeServiceFactory","ConfigService","$ionicHistory","PlacementServiceFactory","$ionicActionSheet","$ionicPosition","$ionicScrollDelegate","maxListTake",function(e,t,n,r,i,o,a,l,s,f,c,d,m,u,h,p,g,v){function y(t){var n=fromGMTDate(e.form.enddate);n.setHours(t.split(":")[0]),n.setMinutes(t.split(":")[1]),e.form.enddate=getGMTDate(n)}function w(){e.fieldsAlg=[],e.isPregnant?e.fieldsAlg.push("DaBe","DMeB","DaEn","DaEs","TPBe","TPEn","ViIr"):e.fieldsAlg.push("DaBe","DMeB","DaEn","DaEs","TPBe","TPEn","ViIt","ViIr"),e.isMss&&e.fieldsAlg.push("PtVz"),e.fieldsAlg.push("RuAb"),e.isBelgie||e.fieldsAlg.push("SfNt")}function D(t){if(e.placements&&e.placements.length>0){e.form.allplacements=!0;e.manager?e.form.employeeMan.id:t.employee_id;e.form.PlacementSelection={};for(var n=0;n<e.placements.length;n++)e.form.PlacementSelection[e.placements[n].placement_code]=!0}}function P(e,t){for(var n=[],r=0;r<e.length;r++)n.push({text:"<i class='icon iconHide'></i>"+e[r].Name,id:e[r].ProfileId});b(n,t)}function b(t,r){i(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),e.hidesheet=h.show({buttons:t,titleText:atrans("chooseprofile","Kies profiel"),cancelText:atrans("cancel","Annuleren"),cancel:function(){e.profile||m.goBack()},buttonClicked:function(t){e.profile=e.profiles[t],s.getUser().then(function(t){e.hidesheet(),r?ne.reportRecovery(illness,e.multipledvb,!1,e.profile).then(function(){n.go("menu.home",{},{reload:!1})}):M(t)})}})}function T(){s.getUser().then(function(t){ne.getIllnesses().then(function(n){if(e.illnesses=n,n.length>0&&!e.manager){e.canrecover=!1;for(var r=0;r<n.length;r++)n[r].end_datetime||(e.canrecover=!0,"undefined"==typeof e.form.wholeday&&(e.form.wholeday=!0));var i;i=e.form.enddate?e.form.enddate:getGMTDate(new Date),2==t.illness_mode&&i.setDate(i.getDate()-1),e.illness=n[0],ne.getTimetable(getJSONDate(i,!0)+"T00H00",e.illness.employeeid).then(function(n){if(n[0]){var r=1==t.illness_mode?n[0].start_time:n[n.length-1].end_time,o=fromGMTDate(i);o.setHours(r.split(":")[0]),o.setMinutes(r.split(":")[1]),o=getGMTDate(o),o>parseDateString(e.illnesses[0].start_datetime)?(e.form.enddate=o,y(r)):e.form.enddate=getGMTDate(new Date)}else{var o=fromGMTDate(i);2==t.illness_mode?(o.setHours(23),o.setMinutes(59)):(o.setHours(0),o.setMinutes(0)),o=getGMTDate(o),o>parseDateString(e.illnesses[0].start_datetime)?(e.form.enddate=o,y(2==t.illness_mode?"23:59":"00:00")):e.form.enddate=getGMTDate(new Date)}e.form.DaEn=e.form.enddate}),e.hasIllness=!e.manager,e.loadedScreen=!0}else e.hasIllness=!1,e.loadedScreen=!0,d.getConfig().then(function(n){isVersionOrHigher(n,"Profit15")?e.showattachments=!0:e.showattachments=!1,e.withProfile?e.profile?M(t):P(e.profiles):("BE"==t.hrm_country&&(e.show_attachment_form=!0),("AN"==t.hrm_country||"NA"==t.hrm_country||"CW"==t.hrm_country||"AW"==t.hrm_country||"BQ"==t.hrm_country)&&(e.reasonallowed=!0),e.replacementallowed=!t.paycloud_emp,t.replacement&&!e.manager&&e.validateEntry(1,t.replacement),ne.getReasons().then(function(t){e.reasonTypes=t}),S("startdate"))})})})}function M(t){(e.manager&&e.form.employeeMan||!e.manager)&&e.profile&&e.profile.ProfileId?(e.isMss=-12==e.profile.ProfileId||-4==e.profile.ProfileId,e.isPregnant=-12==e.profile.ProfileId||-13==e.profile.ProfileId,e.isBelgie=e.manager?"BE"==e.form.employeeMan.hrm_country:"BE"==t.hrm_country,e.form.attachments=[],ne.getNewScreenWithProfile(e.isMss,e.manager?e.form.employeeMan.id:t.employee_id,e.profile.ProfileId).then(function(n){e.infoInit=n,H(n,["customZ12","customZ13"]),parseInfo(e,n,t,!1,"validateEntry2"),e.isBelgie?n.attachment=n.FiId:(n.attachment=n.Atta,e.multipleattach=!0),e.infoLoaded=!0,w(),e.isMss?(e.form.allplacements=!0,e.placements=n.placementsMss,D(t)):(ie.getPlacements(-1,-1,0,e.form.DaBe).then(function(n){e.placements=n,D(t)}),S("DaBe"))})["finally"](function(){e.loading=!1,E(),e.screenview()})):(e.chooseEmployee=!0,e.loading=!1)}function I(e,t){var n="0000"+e;return n.substr(n.length-t)}function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(e[r]){e.custom||(e.custom={});var i;for(var o in e[r])if("eob"!=o){i=e.custom[o]?I(parseInt(o)+1,4):o,e.custom[i]={};for(var a in e[r][o])e.custom[i][a]=e[r][o][a]}}}}function S(t){e.getEmpId().then(function(n){e.form[t]||(e.form[t]=new Date),ne.getTimetable(getJSONDate(e.form[t],!0)+"T00H00",n).then(function(n){if(n&&n[0]){var r=new Date;r.setHours(n[0].start_time.split(":")[0]),r.setMinutes(n[0].start_time.split(":")[1]),r=getGMTDate(r),e.form[t].setHours(r.getHours()),e.form[t].setMinutes(r.getMinutes())}})})}function _(t){if(e.withProfile){var n=e.form[t];e.getEmpId().then(function(t){ne.getTimetable(getJSONDate(n,!0)+"T00H00",t).then(function(t){if(t&&t[0]){var r=new Date(n);r.setHours(t[0].start_time.split(":")[0]),r.setMinutes(t[0].start_time.split(":")[1]),r=getGMTDate(r);var i=new Date(n);i.setHours(n.getHours()-r.getHours()),i.setMinutes(n.getMinutes()-r.getMinutes()),e.form.TPBe=60*i.getHours()+i.getMinutes()}})})}}function E(){if(e.alldvbs){for(var t,n=e.profile?e.form.DaBe:e.form.startdate,r=[],i=0;i<e.alldvbs.length;i++){var o=parseDateString(e.alldvbs[i].start_date);if(e.alldvbs[i].end_date)var t=parseDateString(e.alldvbs[i].end_date);n>o&&(t&&t>n||!t)&&r.push(e.alldvbs[i]),t=null}if(e.dvbs=r,r.length>1){if(e.multipledvbshow=!0,e.form.dvbsel){for(var a=!1,i=0;i<r.length;i++)if(r[i].employment==e.form.dvbsel.employment){a=!0;break}a||(e.form.dvbsel=null)}}else e.multipledvbshow=!1,e.dvbsel=null}}function k(t){s.getUser().then(function(n){d.getConfig().then(function(r){if(isVersionOrHigher(r,"Profit15")&&(e.prevCountry&&e.prevCountry!=t.CoId_entry||!e.prevCountry||e.prevZipcode&&e.prevZipcode!=t.SearchHelpZc||!e.prevZipcode||e.prevHousenumber&&e.prevHousenumber!=t.SearchHelpHn||!e.prevHousenumber)){var i=t.SearchHelpZc.replace(/\s+/g,"");i.match(/\d{4}[A-z]{2}/g)?(e.prevCountry=t.CoId_entry,e.prevZipcode=i,e.prevHousenumber=t.SearchHelpHn,ne.getAddress(e.isMss,e.manager?e.form.employeeMan.id:n.employee_id,e.profile.ProfileId,t.CoId_entry,i,t.SearchHelpHn).then(function(n){if(n){t.errorfld.SearchHelpHn="",t.errorfld.SearchHelpZc="";for(field in n){switch(field){case"HmNr":t[field]=parseFloat(n[field].extvalue?n[field].extvalue:n[field].value);break;case"Rs":n[field].value&&""!=n[field].value&&(t[field]={id:n[field].value,name:n[field].description,idext:n[field].extvalue},t[field+"_entry"]=n[field].extvalue?n[field].extvalue:n[field].value);break;default:t[field]=n[field].extvalue?n[field].extvalue:n[field].value}e.info[field]=n[field]}}else t.errorfld.SearchHelpHn=atrans("addressnotfound","Het adres kon niet worden gevonden. Voer het adres handmatig in of wijzig het land, postcode, of huisnummer."),Q(e.info,!0,["StAd","Ad","HmNr","HmAd","ZpCd","Rs"])})):t.errorfld.SearchHelpZc=atrans("invalidpostalcode","Ongeldige postcode")}})})}function A(e,t){if(t&&t[e])return t[e];if(t.custom)for(var n in t.custom)if(t.custom[n]&&t.custom[n][e])return t.custom[n][e]}function V(){return e.error=[],e.manager&&!e.form.employeeMan?(e.error[2]=atrans("noemp","Geen medewerker gekozen!"),!1):!0}function B(e,t){ee(t,e.PtVz,["PsPc","PsHr","PsPa","PsHa"]),e.PtVz||(e.PsPc=0,e.PsHr=0,e.PsPa=0,e.PsHa=0)}function R(e,t){e.AlAb&&1==e.AlAb&&(ee(t,!1,["TPEn","ThAb"]),X(t,!1,["TPEn","ThAb"]),e.TPEn=null,e.ThAb=null)}function x(e,t){ee(t,isNotEmpty(e.DaEn),["DMeE","ViRs"]),X(t,isNotEmpty(e.DaEn),["DMeE","ViRs"])}function C(e,t){t.TPBe.enabled=!(e.Gespecificeerd&&!e.IsEducation)}function G(e,t){isNotEmpty(e.DaBe)||isNotEmpty(e.EPgS)&&isNotEmpty(e.ViPg_entry)&&(date=new Date(e.EPgS),date.setDate(date.getDate()-7*parseInt(e.ViPg_entry)+1),e.DaBe=date)}function Z(e,t){if(!isNotEmpty(e.DaEs)&&isNotEmpty(e.EPgS)){var n=F(e.ViPg_entry);if(n>0){var r=new Date(e.EPgS);r.setDate(r.getDate()+n),e.DaEs=r}}}function N(e,t){if(e.EPgR)e.DaEc="";else{var n=F(e.ViPg_entry);n>0&&(date=new Date(e.EPgR),date.setDate(date.getDate()+n),e.DaEc=date)}}function F(e){switch(e){case"08":return 84;case"09":return 77;case"10":return 70;default:return 0}}function O(e,t){if("undefined"!=typeof e.ViIt&&"undefined"!=typeof e.SfNt)switch(e.ViIt.id){case"ZW":case"A":case"P":case"ZZW":case"ZB":case"ZOD":e.SfNt=!0;break;default:e.SfNt=!1}}function $(e,t){ee(t,e.RtDa,["RtDs","RtHr","RtDl"]),X(t,e.RtDa,["RtDs","RtHr","RtDl"])}function W(e,t){ee(t,e.RtDl,["ViAt"]),X(t,e.RtDl,["ViAt"])}function U(e,t){e.DaBe&&""==e.DaBe&&(ee(t,!1,["TPEn","ThAb"]),X(t,!1,["TPEn","ThAb"]))}function z(t,n){e.multipledvb?ee(n,!0,["PtVz"]):t.MeerdereDVB&&1==t.MeerdereDVB?(ee(n,!1,["PtVz"]),t.PtVz=!1):ee(n,!0,["PtVz"])}function j(e,t){if(fieldsHours=["HrMo","HrTu","HrWe","HrTh","HrFr","HrSa","HrSu"],fieldsATHours=["AhMo","AhTu","AhWe","AhTh","AhFr","AhSa","AhSu"],fieldsTime=["TbMo","TbTu","TbWe","TbTh","TbFr","TbSa","TbSu","TeMo","TeTu","TeWe","TeTh","TeFr","TeSa","TeSu"],fieldsATTime=["AbMo","AbTu","AbWe","AbTh","AbFr","AbSa","AbSu","AeMo","AeTu","AeWe","AeTh","AeFr","AeSa","AeSu"],e.PsSp&&1==e.PsSp)var n=!0,r=0==e.PsHa,i=0==e.PsHr;else var n=!1,r=!1,i=!1;ee(t,i,fieldsHours.concat(fieldsTime)),ee(t,r,fieldsATHours.concat(fieldsATTime)),X(t,!1,fieldsHours.concat(fieldsATHours.concat(fieldsTime.concat(fieldsATTime)))),L(e,!n,n,fieldsHours.concat(fieldsTime)),L(e,!n,!1,fieldsTime.concat(fieldsATTime))}function J(e,t){if(e.ViIt){var n;switch(e.ViIt){case"B":n=4;break;case"O":n=5;break;case"Z":n=0;break;case"ZW":n=1;break;case"D":n=6;break;case"P":n=12;break;case"ZZW":n=2;break;case"ZB":n=9;break;case"ZOD":n=7}e.AdId=n}}function Y(e,t,n){"ZW"==e.ViIt||"ZW"==e.ViIt_entry?(ee(t,!e.Afsluiten&&n.MuBi.enabled,["MuBi"]),ee(t,!e.Afsluiten&&n.EPgS.enabled,["EPgS"]),ee(t,!e.Afsluiten&&n.ViPg.enabled,["ViPg"]),ee(t,n.EPgR.enabled,["EPgR"]),Q(t,n.MuBi.visible,["MuBi"]),Q(t,n.EPgS.visible,["EPgS"]),Q(t,n.ViPg.visible,["ViPg"]),Q(t,n.EPgR.visible,["EPgR"]),X(t,n.EPgS.mandatory,["EPgS"]),X(t,n.EPgR.mandatory,["EPgR"])):(ee(t,!1,["MuBi","EPgS","ViPg","EPgR"]),Q(t,!1,["MuBi","EPgS","ViPg","EPgR"]),X(t,!1,["EPgS","EPgR"]))}function q(e,t){X(t,!0,["RtDa"]),ee(t,e.Wachtdagen&&!e.RuAb,["RtDa"])}function K(e,t){t.CoId&&1==t.CoId.visible&&t.SearchHelpZc&&1==t.SearchHelpZc.visible&&t.SearchHelpHn&&1==t.SearchHelpHn.visible&&Q(t,!1,["StAd","Ad","HmNr","HmAd","ZpCd","Rs"])}function L(e,t,n,r){for(var i=0;i<r.length;i++)e[r[i]]&&(t?e[r[i]]=null:n&&(isNotEmpty(e[r[i]])||(e[r[i]]=0)))}function Q(e,t,n){for(var r=0;r<n.length;r++)e[n[r]]&&(e[n[r]].visible=t)}function X(e,t,n){for(var r=0;r<n.length;r++)e[n[r]]&&(e[n[r]].mandatory=t)}function ee(e,t,n){for(var r=0;r<n.length;r++)e[n[r]]&&(e[n[r]].enabled=t)}var te,ne=l.getInstance(),re=c.getInstance(),ie=u.getInstance(),oe={IllnessService:ne,fields:{}};e.form={},e.reasonallowed=!1,e.form.errorfld={},e.error=[],e.form.startdate=getGMTDate(new Date),e.form.expenddate=new Date(e.form.startdate.valueOf()+864e5),e.form.datebetter=getGMTDate(new Date),e.form.start_attest=getGMTDate(new Date),e.form.end_attest=getGMTDate(new Date),e.form.mayleavehome=!0,e.form_modal={},e.loadedScreen=!1,e.canrecover=!1,e.manager=n.params.manager,e.hasIllness=!e.manager,e.employeePlaceholder=atrans("choosereplacementemployee","Vul hier een medewerkerscode in"),e.setupFile=function(t){document.getElementById("fileBrowser").onchange=function(n){e.filePickedGeneric(n,t,e)}},e.$on("$ionicView.enter",function(){d.getConfig().then(function(t){s.getUser().then(function(n){e.manager?ne.getDvbs():e.multipledvb=n.multiple_employment&&isVersionOrHigher(t,"Profit6")}),isVersionOrHigher(t,"Profit6")&&ne.getIllnessTypes().then(function(t){for(var n=0;n<t.length;n++)"Z"==t[n].int_code&&(e.form.illtype=t[n]);e.illtypes=t}),isVersionOrHigher(t,"Profit12")?ne.getProfiles(e.manager).then(function(t){t.length>0&&(e.loading=!0,e.withProfile=!0,e.profiles=t,1==t.length&&(e.profile=t[0]))})["finally"](function(){T()}):T()})}),e.screenview=function(t){(e.manager&&e.form.employeeMan||!e.manager)&&e.profile&&e.profile.ProfileId&&e.canrecover===!1&&(B(e.form,e.info),R(e.form,e.info),x(e.form,e.info),G(e.form,e.info),Z(e.form,e.info),N(e.form,e.info),O(e.form,e.info),$(e.form,e.info),W(e.form,e.info),U(e.form,e.info),z(e.form,e.info),j(e.form,e.info),J(e.form,e.info),C(e.form,e.info),Y(e.form,e.info,e.infoInit),q(e.form,e.info),K(e.form,e.info))},e.toggleAllPlacements=function(){if(e.form.allplacements)for(var t in e.form.PlacementSelection)e.form.PlacementSelection[t]=!0},e.pickStartDate=function(){f.pickDate(e.form.startdate).then(function(t){e.form.startdate.setYear(fromGMTDate(t).getFullYear()),e.form.startdate.setMonth(fromGMTDate(t).getMonth()),e.form.startdate.setDate(fromGMTDate(t).getDate()),E(),e.screenview("startdate")})},e.pickStartTime=function(){f.pickTime(e.form.startdate).then(function(t){e.form.startdate.setHours(t.getHours()),e.form.startdate.setMinutes(t.getMinutes()),e.screenview("startdate"),_("startdate")})},e.pickEndDate=function(){var t=new Date(e.form.datebetter);f.pickDate(e.form.datebetter).then(function(n){e.form.enddate=new Date(n),e.form.datebetter=new Date(n),e.form.datebetter.setHours(t.getHours()),e.form.datebetter.setMinutes(t.getMinutes()),T(),e.screenview("enddate")})},e.pickExpEndDate=function(){f.pickDate(e.form.expenddate).then(function(t){e.form.expenddate=t,e.screenview("expenddate")})},e.pickEndTime=function(){f.pickTime(e.form.datebetter).then(function(t){e.form.enddate.setHours(t.getHours()),e.form.enddate.setMinutes(t.getMinutes()),e.form.datebetter.setHours(t.getHours()),e.form.datebetter.setMinutes(t.getMinutes()),e.screenview("enddate")})},e.pickStartAttest=function(){f.pickDate(e.form.start_attest).then(function(t){e.form.start_attest=t})},e.pickEndAttest=function(){f.pickDate(e.form.end_attest).then(function(t){e.form.end_attest=t})},e.pickDate=function(t,n){t[n]||(t[n]=getGMTDate(new Date)),f.pickDate(t[n]).then(function(r){switch(t[n].setYear(r.getFullYear()),t[n].setMonth(r.getMonth()),t[n].setDate(r.getDate()),n){case"DaBe":ie.getPlacements(-1,-1,0,t.DaBe).then(function(t){e.placements=t,s.getUser().then(function(e){D(e)}),E(),S(n)})}e.screenview(n)})},e.pickTime=function(t,n){t[n]||(t[n]=getGMTDate(new Date)),f.pickTime(t[n]).then(function(r){switch(t[n].setHours(r.getHours()),t[n].setMinutes(r.getMinutes()),e.screenview(n),n){case"DaBe":_(n)}})},e.change=function(e,t,n){switch(n){case"CoId":case"SearchHelpZc":case"SearchHelpHn":e.CoId_entry&&e.SearchHelpZc&&e.SearchHelpHn&&k(e)}},e.validateEntry2=function(t,n){if(e.form[n]=null,"string"!=typeof t&&(t=String(t)),t.length>0){if(e.form[n]={id:t},oe.fieldId=n,e.info[n])oe.searchview=e.info[n].searchview,isNotEmpty(oe.searchview.fieldId2)&&(oe.searchview.fromfieldId1?oe.searchview.fieldValue2=formvalue(e.form[oe.searchview.fromfieldId1],e.info[oe.searchview.fromfieldId1]):e.form[oe.searchview.fieldId2]&&(oe.searchview.fieldValue2=formvalue(e.form[oe.searchview.fieldId2],e.info[oe.searchview.fieldId2]))),isNotEmpty(oe.searchview.fieldId3)&&(oe.searchview.fromfieldId2?oe.searchview.fieldValue3=formvalue(e.form[oe.searchview.fromfieldId2],e.info[oe.searchview.fromfieldId2]):e.form[oe.searchview.fieldId3]&&(oe.searchview.fieldValue3=formvalue(e.form[oe.searchview.fieldId3],e.info[oe.searchview.fieldId3])));else for(var r in e.info.custom)if(e.info.custom.hasOwnProperty(r)&&e.info.custom[r][n]){oe.searchview=e.info.custom[r][n].searchview;break}oe.onlyId=!0,ne.searchForField(oe,t,0,v,!0).then(function(n){for(var r=n.rows,i=0;i<r.length;i++)if(r[i]._id==t)return void e.selectItem(r[i]);r&&r.length>0&&e.selectItem(r[0])}),e.screenview(n)}},e.validateEntry=function(t,n){te&&i.cancel(te),te=i(function(){switch(t){case 1:e.form.employee=null,n.length>=1&&e.getEmpId().then(function(t){re.validateEntry(1,t,n).then(function(t){e.selectEmployee(t)})}),te=null;break;case 2:e.form.employeeMan=null,n.length>=1&&re.validateEntry(2,"",n).then(function(t){e.selectEmployeeMan(t)}),te=null}},500)},e.show=function(t){e.showType=t},e.showFileActions=function(t){e.showFileActionsGeneric(t,e)},e.selectItem=function(t,n){e.extraParam&&(e.extraParam=null),e.form[t.fieldId]||(e.form[t.fieldId]={}),e.form[t.fieldId]={id:t._id,name:t._name},e.form[t.fieldId+"_entry"]=t._id,o.setRecentlySelected(t,"recent_illness_"+t.fieldId),e.form.errorfld[t.fieldId]="";for(var r in t)t.hasOwnProperty(r)&&-1!=r.indexOf("_fixed_")&&(e.form[t.fieldId][r]=t[r]);e.screenview(),n&&e.modal&&e.modal.hide()},e.getEmpId=function(){var n=t.defer();return e.manager?e.form.employeeMan?n.resolve(e.form.employeeMan.id):n.resolve():s.getUser().then(function(e){e?n.resolve(e.employee_id):n.resolve()}),n.promise},e.showAttachment=function(t){t?"img"==t.type&&e.showImage(t.src):e.file_attached&&"img"==e.attachment_type&&e.showImage(document.getElementById("illness_attachment").src)},e.deleteAttachment=function(t){if(t){if(""!=t.src&&e.file_attached){var n=e.form.attachments.indexOf(t);-1!=n&&e.form.attachments.splice(n,1)}}else""!=document.getElementById("illness_attachment").src&&e.file_attached&&confirm(atrans("deletedeclarationphoto","Wil je deze foto verwijderen?"))&&(e.file_attached=!1,e.form.fileURI=void 0,e.form.fileDataUrl=void 0,document.getElementById("fileBrowser").form.reset(),document.getElementById("illness_attachment").src="")},e.addAttachment=function(t){e.showFileActionsGeneric(t,e)},e.openModal=function(t){e.getEmpId().then(function(n){e.extraParam?a.openModal(e,t,e.extraParam):a.openModal(e,t,n)})},e.closeModal=function(){e.modal.hide()},e.showhide=function(){e.hidden=!e.hidden},e.search=function(t){e.getEmpId().then(function(n){e.extraParam?a.search(e,t,e.extraParam):a.search(e,t,n)})},e.loadMore=function(){e.getEmpId().then(function(t){e.extraParam?a.loadMore(e,e.extraParam):a.loadMore(e,t)})},e.clearSearch=function(t){a.clearSearch(e)},e.clickRecent=function(t){e.modal.query=t,e.getEmpId().then(function(n){e.extraParam?a.search(e,t,e.extraParam):a.search(e,t,n)})},e.ShowRecentSearches=function(){a.ShowRecentSearches(e)},e.HideRecentSearches=function(){a.HideRecentSearches(e)},e.selectTab=function(t){e.modal&&!e.modal.loading&&(e.modal.showType=t)},e.openModalforField=function(t){oe.fieldId=t,oe.info=e.info,oe.form=e.form;var n=A(t,e.info);if(n){if(oe.searchview=n.searchview,oe.searchview.filter=n.filter,isNotEmpty(oe.searchview.fieldId2))if(oe.searchview.fromfieldId1){var r=A(oe.searchview.fromfieldId1,e.info);r&&(oe.searchview.fieldValue2=formvalue(r))}else A(oe.searchview.fieldId2,e.info)&&(oe.searchview.fieldValue2=formvalue(A(oe.searchview.fieldId2,e.info)));isNotEmpty(oe.searchview.fieldId3)&&(oe.searchview.fromfieldId2?oe.searchview.fieldValue3=formvalue(A(oe.searchview.fromfieldId2,e.info)):e.form[oe.searchview.fieldId3]&&(oe.searchview.fieldValue3=formvalue(A(oe.searchview.fieldId3,e.info))))}oe.IllnessService=ne,e.extraParam=oe,a.openModal(e,"Pocket_IllnessFields",oe)},e.selectEmployee=function(t){e.form.employee=t,e.form.employee_entry=t.employee_id,o.setRecentlySelected(t,"recent_employees"),e.modal&&e.modal.hide(),e.screenview(t)},e.selectEmployeeMan=function(t){e.form.employeeMan=t,e.form.employeeMan_entry=t.id,o.setRecentlySelected(t,"recent_employees_manager"),e.modal&&e.modal.hide(),ne.getDvbs(e.form.employeeMan_entry).then(function(t){e.alldvbs=t,E()}),e.withProfile&&(e.loading=!0,T())},e.illnessSend=function(t){if(V()){var r=e.form.expenddate,i=null;e.form.reason&&-1!=e.form.reason.id&&(i=e.form.reason.id),s.getUser().then(function(t){var o;o=e.form.fileDataUrl?e.form.fileDataUrl:e.form.fileURI,ne.sendIllness(e.form.startdate,r,i,t,e.form.employee,e.form.mayleavehome,o,e.form.start_attest,e.form.end_attest,e.form.dvbsel,e.form.illtype,e.multipledvb,e.form.employeeMan).then(function(){e.manager?e.previousPage():n.go("menu.home",{},{reload:!1})})})}},e.illnessSendWithProfile=function(){var t=!1;s.getUser().then(function(o){for(key in e.info)e.info.hasOwnProperty(key)&&"FiId"!=key&&"attachments"!=key&&"placementsMss"!=key&&"Atta"!=key&&"attachment"!=key&&(t|=checkFormField(e.form,e.info,key,o));for(ckey in e.info.custom)if(e.info.custom.hasOwnProperty(ckey))for(key in e.info.custom[ckey])e.info.custom[ckey].hasOwnProperty(key)&&(t|=checkFormField(e.form,e.info.custom[ckey],key,o));if(e.info.attachment&&e.info.attachment.mandatory&&0==e.form.attachments.length&&(e.error[3]=atrans("noattachmentadded","Voeg een bijlage toe"),i(function(){var e=document.getElementById("errorfile");if(null!=e){var t=p.position(angular.element(e));g.$getByHandle("main").scrollTo(0,t.top,!1)}},10),t=!0),e.info.HasPlaatsingen&&1==e.info.HasPlaatsingen.value){var a=!1;for(var l in e.form.PlacementSelection)if(1==e.form.PlacementSelection[l]){a=!0,e.form.errorfld.HasPlaatsingen=null,e.error[4]=null;break}a||(t=!0,e.form.errorfld.HasPlaatsingen=atrans("noplacementselected","De medewerker is een flex medewerker. Voor het ziekmelden is een plaatsing verplicht."),e.error[4]=atrans("noplacementselected","De medewerker is een flex medewerker. Voor het ziekmelden is een plaatsing verplicht."))}t?showErrors(e.form,e.info,"main",i,r,p,g):d.getConfig().then(function(t){ne.sendIllnessWithProfile(t,e.form,e.info,o,e.form.employeeMan,e.form.dvbsel,e.isBelgie,e.placements).then(function(t){e.manager?e.previousPage():n.go("menu.home",{},{reload:!1})})})})},e.reportRecovery=function(t){if(e.canrecover){var i=r.confirm({title:atrans("betteragain","Beter melden"),template:atrans("confirmbetteragain","Weet je zeker dat je je beter wilt melden?"),cancelText:atrans("no","Nee"),okText:atrans("yes","Ja")});i.then(function(r){1==r&&(e.form.wholeday?t.end_datetime=e.form.enddate:t.end_datetime=new Date(e.form.datebetter),ne.getProfiles(!1,!0).then(function(r){e.wellnessprofiles=r,e.wellnessprofiles&&e.wellnessprofiles.length>0?1==e.wellnessprofiles.length?(e.wellnessprofile=e.wellnessprofiles[0],ne.reportRecovery(t,e.multipledvb,!1,e.wellnessprofile).then(function(){n.go("menu.home",{},{reload:!1})})):P(e.wellnessprofiles,!0):ne.reportRecovery(t,e.multipledvb,!1).then(function(){n.go("menu.home",{},{reload:!1})})}))})}}}]).controller("IllnessManagerController",["$scope","IllnessServiceFactory",function(e,t){var n=t.getInstance();e.pageTitle=atrans("illnessmanager","Ziekte manager"),e.newIllness=function(){e.gotoPage("menu.illness.overview",{manager:!0})},e.gotoDetails=function(t){e.gotoPage("menu.illnessmanagerdetails",{illness:t})},e.$on("$ionicView.enter",function(){e.refresh()}),e.refresh=function(){n.getIllnessesManager().then(function(t){e.illnesses=t})["finally"](function(){e.$broadcast("scroll.refreshComplete")})}}]).controller("IllnessDetailsController",["$scope","$state","$ionicPopup","DatePickerService","IllnessServiceFactory","UserService","$q","ConfigService","$timeout","$ionicActionSheet",function(e,t,n,r,i,o,a,l,s,f){function c(){o.getUser().then(function(t){var n;n=e.form.enddate?e.form.enddate:getGMTDate(new Date),2==t.illness_mode&&n.setDate(n.getDate()-1),h.getTimetable(getJSONDate(n,!0)+"T00H00",e.illness.employeeid).then(function(r){if(r[0]){var i=1==t.illness_mode?r[0].start_time:r[r.length-1].end_time,o=fromGMTDate(n);o.setHours(i.split(":")[0]),o.setMinutes(i.split(":")[1]),o=getGMTDate(o),o>parseDateString(e.illness.date_time_begin)?(e.form.enddate=o,u(i)):e.form.enddate=getGMTDate(new Date)}else{var o=fromGMTDate(n);2==t.illness_mode?(o.setHours(23),o.setMinutes(59)):(o.setHours(0),o.setMinutes(0)),o=getGMTDate(o),o>parseDateString(e.illness.date_time_begin)?(e.form.enddate=o,u(2==t.illness_mode?"23:59":"00:00")):e.form.enddate=getGMTDate(new Date)}})})}function d(){for(var t=[],n=0;n<e.profiles.length;n++)t.push({text:"<i class='icon iconHide'></i>"+e.profiles[n].Name,id:e.profiles[n].ProfileId});return m(t)}function m(t){s(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),e.hidesheet=f.show({buttons:t,titleText:atrans("chooseprofile","Kies profiel"),cancelText:atrans("cancel","Annuleren"),buttonClicked:function(t){e.profile=e.profiles[t],e.hidesheet(),h.reportRecovery(e.illness,e.multipledvb,!0,e.profile).then(function(){e.previousPage()})}})}function u(t){var n=fromGMTDate(e.form.enddate);n.setHours(t.split(":")[0]),n.setMinutes(t.split(":")[1]),e.form.enddate=getGMTDate(n)}var h=i.getInstance();e.pageTitle=atrans("illnessdet","Ziektemelding"),e.illness=t.params.illness,e.illness&&(e.illnessheader=atrans("illnessemp","Ziektemelding {0} ({1})",e.illness.first_last_name,e.illness.employeeid)),e.pickEndTime=function(){r.pickTime(e.form.datebetter).then(function(t){e.form.enddate.setHours(t.getHours()),e.form.enddate.setMinutes(t.getMinutes()),e.form.datebetter.setHours(t.getHours()),e.form.datebetter.setMinutes(t.getMinutes())})},e.pickEndDate=function(){var t=new Date(e.form.datebetter);r.pickDate(t).then(function(n){e.form.enddate=new Date(n),e.form.datebetter=new Date(n),e.form.datebetter.setHours(t.getHours()),e.form.datebetter.setMinutes(t.getMinutes()),c()})},e.recover=function(){var t=e.illness,r=n.confirm({title:atrans("betteragain","Beter melden"),template:atrans("confirmbetteragainemp","Weet je zeker dat je {0} beter wilt melden?",t.first_last_name),cancelText:atrans("no","Nee"),okText:atrans("yes","Ja")});r.then(function(t){1==t&&l.getConfig().then(function(t){e.form.wholeday?e.illness.end_datetime=e.form.enddate:e.illness.end_datetime=new Date(e.form.datebetter),isVersionOrHigher(t,"Profit15")?h.getProfiles(!0,!0).then(function(t){t&&t.length>0?(e.profiles=t,1===e.profiles.length?(e.profile=e.profiles[0],h.reportRecovery(e.illness,e.multipledvb,!0,e.profile).then(function(){e.previousPage()})):d()):h.reportRecovery(e.illness,e.multipledvb,!0).then(function(){e.previousPage()})}):h.reportRecovery(e.illness,e.multipledvb,!0).then(function(){e.previousPage()})})})},e.form={},e.form.enddate=getGMTDate(new Date),"undefined"==typeof e.form.wholeday&&(e.form.wholeday=!0),e.form.datebetter=getGMTDate(new Date),c()}]);