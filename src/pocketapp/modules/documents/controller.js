angular.module("documents.controller",["AfasServices"]).factory("SharedDocumentsService",["DocumentsServiceFactory",function(e){var t=e.getInstance();return{getDocumentsService:function(){return t}}}]).controller("DocumentsController",["$scope","$state","$timeout","$ionicActionSheet","MultipleViewsManager","SharedDocumentsService","maxListTake","ConnectorService","$ionicScrollDelegate","$ionicTabsDelegate","SearchService",function(e,t,n,o,c,a,r,s,l,d,u){function m(){return h.getDocuments(1,g,r).then(function(t){e.showmore=t.length-g>=r,g=t.length,e.documents=t,e.searched=!0,SessionStorage.setItem("lastDocumentChanged",""),e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){e.loadingMore=!1,e.$broadcast("scroll.refreshComplete"),n(function(){l.$getByHandle("documents").resize()},10)})}function f(){h.getDocuments(0,p,r,e.fetchData.query).then(function(t){e.showmoreAll=t.length-p>=r,p=t.length,e.documentsAll=t,e.searchedAll=!0,SessionStorage.setItem("lastDocumentChanged",""),e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){e.loadingMoreAll=!1,e.$broadcast("scroll.refreshComplete"),n(function(){l.$getByHandle("documents").resize()},10)})}var h=a.getDocumentsService();e.pageTitle=atrans("news","Nieuws"),e.searched=!1,e.searchedAll=!1,e.fetchData={},e.showMore=!1,e.loadingMore=!1,e.loadingMoreAll=!1;var g,p;e.searchplaceholder=atrans("docSearchplaceholder","Zoek op titel of auteur"),e.tabTitle0=atrans("personaldocs","Persoonlijk"),e.tabTitle1=atrans("alldoc","Alle"),e.$on("$ionicSlides.sliderInitialized",function(t,n){e.slider=n.slider,e.slider.lockSwipes()}),e.$on("$ionicSlides.slideChangeStart",function(e,t){n(function(){d.$getByHandle("tabsdocuments").select(t.slider.activeIndex)},1)}),e.$on("$ionicView.unloaded",function(){e.slider=void 0}),e.$on("$ionicView.beforeEnter",function(){("undefined"==typeof e.documents||0==e.documents.length)&&(g=0,m().then(function(){if(c.isActive()&&(!e.slider||0==e.slider.activeIndex)){var t=!1;if(e.documents)for(var n=0;n<e.documents.length;n++)if(e.documents[n].Id){c.updateView("documents-detail",{id:e.documents[n].Id,personal:1}),t=!0;break}t||c.updateView("documents-detail",{})}})),("undefined"==typeof e.documentsAll||0==e.documentsAll.length)&&(p=0,f());var t=null;if(c.isActive()&&(e.slider&&(t=n(function(){e.slider&&e.slider.onResize(!0)},400)),null!=SessionStorage.getItem("lastDocumentReactionAdded"))){var o=JSON.parse(SessionStorage.getItem("lastDocumentReactionAdded"));SessionStorage.removeItem("lastDocumentReactionAdded"),c.updateView("documents-detail",{id:o.id,personal:o.personal,fromReaction:!0})}if(""!=SessionStorage.getItem("lastDocumentChanged")&&null!=SessionStorage.getItem("lastDocumentChanged")){var i,a=!1;if(null!=e.documents)for(i=0;i<e.documents.length;i++)if(e.documents[i].Id==SessionStorage.getItem("lastDocumentChanged")){e.documents.splice(i,1),a=!0;break}if(a?0==e.documents.length&&(null!=t&&n.cancel(t),e.gotoPage("menu.home"),e.refreshHomeBullets()):(g=0,d.$getByHandle("tabsdocuments").select(0),m()),c.isActive()&&(!e.slider||0==e.slider.activeIndex)){if(a=!1,e.documents)for(i=0;i<e.documents.length;i++)if(e.documents[i].Id){c.updateView("documents-detail",{id:e.documents[i].Id,personal:1}),a=!0;break}a||c.updateView("documents-detail",{})}}}),e.selectTab=function(t){switch(t){case 0:e.showType="personal";break;case 1:e.showType="all"}e.slider&&e.slider.activeIndex!=t&&(e.slider.unlockSwipes(),e.slider.slideTo(t),e.slider.lockSwipes())},e.scrollTop=function(){n(function(){l.$getByHandle("documents").scrollTop(!0)},10)},e.refresh=function(){g=0,m()},e.refreshAll=function(){p=0,f()},e.searchDocuments=function(){p=0,f(),hideKeyboard(),e.HideRecentSearches()},e.loadMore=function(){e.loadingMore||(e.loadingMore=!0,m())},e.loadMoreAll=function(){e.loadingMoreAll||(e.loadingMoreAll=!0,f())},e.ShowRecentSearches=function(){u.getSearchHistory("Docs").then(function(t){e.recent=t})},e.HideRecentSearches=function(){n(function(){e.recent=0},100)},e.clearQuery=function(){e.fetchData.query="",f()},e.clickRecent=function(t){e.fetchData.query=t,e.searchDocuments(),e.HideRecentSearches()},e.goToDocument=function(e,n){c.isActive()?c.updateView("documents-detail",{id:e,personal:n}):t.go("menu.document",{id:e,personal:n})},e.handleDoc=function(t){h.getDocumentActions(t.Id).then(function(n){1==n.length&&(action=n[0],"Read"==action.Id?h.executeDocumentAction(t.Id,action.Id).then(function(){if(null!=e.documents)for(i=0;i<e.documents.length;i++)if(e.documents[i].Id==t.Id){e.documents.splice(i,1),found=!0;break}e.refreshHomeBullets()}):e.goToDocument(t.Id,1))})}}]).controller("DocumentController",["$scope","$state","$stateParams","$timeout","$ionicActionSheet","$ionicHistory","MultipleViewsManager","SharedDocumentsService","ConfigService","ConnectorService","DocumentSessionService","$ionicScrollDelegate","$ionicTabsDelegate","maxListTake","UserService","question",function(e,t,n,o,i,c,a,r,s,l,d,u,m,f,h,g){function p(){"undefined"==typeof e.doc||e.doc.Id!=n.id?n.id&&v.getDocument(n.id,n.personal).then(function(t){e.doc=t,D=0,e.loadingMore=!1,(null==c.forwardView()||"menu.contact"!=c.forwardView().stateName&&"menu.employee"!=c.forwardView().stateName)&&e.refreshReactions(),v.getFullDocument(n.id,e),o(function(){u.$getByHandle("document").scrollTop(!0)},10)}):(y=!0,S()),v.getDocumentActions(n.id).then(function(t){e.actions=t})}function S(){$||($=!0,y&&(D=0),s.getConfig().then(function(t){v.getDocumentReactions(e.doc.PageId,D,f).then(function(t){var n;for(y&&(e.reactions=[],y=!1),$=!1,e.showmore=(e.reactions?e.reactions.length:0)+t.length-D>=f,D+=t.length,n=t.length-1;n>=0;n--)w(t[n]);for("undefined"!=typeof e.reactions?e.reactions=e.reactions.concat(t):e.reactions=t,e.reactions.sort(function(e,t){return parseDateString(t.SubmitDate).getTime()-parseDateString(e.SubmitDate).getTime()}),e.showInlineContentReaction={},n=0;n<e.reactions.length;n++){var o=inlineDocType(e.reactions[n].AttachmentFilename);null!=o&&(e.showInlineContentReaction[e.reactions[n].Id]=!0)}e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){e.loadingMore=!1,e.$broadcast("scroll.refreshComplete")})}))}function w(e){if(e.AttachmentGuid){e.type="file";var t=e.AttachmentFilename.toLowerCase().substring(e.AttachmentFilename.lastIndexOf("."));(".jpeg"==t||".jpg"==t||".svg"==t||".png"==t||".gif"==t||".bmp"==t)&&(e.type="img",l.getFileData(e,"AttachmentGuid","AttachmentFilename",function(){return d.getSession()}).then(function(t){e.imageUrl="data:"+t.mimetype+";base64,"+t.filedata}))}}var v=r.getDocumentsService(),D=0,y=!1,$=!1;e.actions=[],e.loadingMore=!1,e.pageTitle=atrans("document","Document"),e.tabTitle0=atrans("document","Document"),e.tabTitle1=atrans("reactions","Reacties"),e.activatedFab=!1,h.getUser().then(function(t){e.personid=t.person}),a.updated("documents-detail",function(t){t.id?(n.id=t.id,n.personal=t.personal,y=!0,p(),e.docslider&&!t.fromReaction&&e.docslider.slideTo(0)):(e.doc=void 0,e.showplaceholder=!0,e.docslider=void 0)}),e.$on("$ionicSlides.sliderInitialized",function(t,o){e.docslider=o.slider,n.showreactions&&e.docslider.slideTo(1)}),e.$on("$ionicSlides.slideChangeStart",function(e,t){o(function(){m.$getByHandle("tabsdocument").select(t.slider.activeIndex)},1)}),e.$on("$ionicView.unloaded",function(){e.docslider=void 0}),e.$on("$ionicView.beforeEnter",function(){e.landscape=e.isLandscape(),s.getConfig().then(function(t){-1==t.modules.indexOf(12)?e.gotoPage("menu.home"):(a.isActive()||p(),e.docslider&&o(function(){e.docslider&&e.docslider.onResize(!0)},400))})}),e.$on("$ionicView.leave",function(){e.doc=void 0}),e.downloadDocumentAttachment=function(e){l.downloadFile(e,"AttachmentGuid","AttachmentFilename",function(){return d.getSession()})},e.downloadAttachment=function(e){l.downloadFile(e,"AttachmentGuid","AttachmentFilename",function(){return d.getSession()})},e.goToNewReaction=function(e,o){t.go("menu.newdocreaction",{id:e,pageId:o,personal:n.personal},{reload:!0})},e.deleteReaction=function(t){g(atrans("confirmdeletereaction","Weet je zeker dat je de reactie wilt verwijderen?")).then(function(o){1==o&&v.deleteDocumentReaction(n.id,t.Id).then(function(n){e.reactions.splice(e.reactions.indexOf(t),1)})})},e.selectDocTab=function(t){var n,o=e.showType;switch(t){case 0:e.showType="document";break;case 1:e.showType="comments"}if(n=e.showType,void 0!=o&&(hasFab(n)?(e.activatedFab=!0,e.removeFab?(e.removeFab=!1,e.addFab=!0):e.changeFab=!0):e.removeFab=!0),e.docslider&&e.docslider.activeIndex!=t)try{e.docslider.slideTo(t)}catch(i){}},hasFab=function(e){switch(e){case"document":return!1;case"comments":return!0}},e.$on("$ionicSlides.slideChangeEnd",function(t,n){o(function(){e.addFab=!1,e.changeFab=!1},1)}),e.refreshReactions=function(){y=!0,S()},e.scrollTop=function(){u.$getByHandle("document").scrollTop(!0),u.$getByHandle("reactions").scrollTop(!0)},e.showActions=function(){var t;if(1==e.actions.length)t=e.actions[0],v.executeDocumentAction(n.id,t.Id).then(function(){SessionStorage.setItem("lastDocumentChanged",n.id),e.gotoPage("menu.documents"),e.refreshHomeBullets()});else{for(var c=new Array,a=0;a<e.actions.length;a++)t=e.actions[a],c.push({text:"<i class='icon iconHide'></i>"+t.Caption});o(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),i.show({buttons:c,titleText:atrans("documentactions","Document acties"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(t){var o=e.actions[t];v.executeDocumentAction(n.id,o.Id).then(function(){SessionStorage.setItem("lastDocumentChanged",n.id),e.gotoPage("menu.documents"),e.refreshHomeBullets()})}})}},e.loadMore=function(){e.loadingMore||(e.loadingMore=!0,S())}}]).controller("DocumentReactionController",["$scope","$stateParams","$state","$ionicHistory","$timeout","SharedDocumentsService","TaskService","$ionicActionSheet","PictureService",function(e,t,n,o,i,c,a,r,s){function l(){var t=!0;return void 0==e.form.reactionText&&(e.error[0]=atrans("noreactionspecified","Vul een reactie in"),t=!1),1==t&&(e.error=!1),t}var d=t.pageId,u=(t.id,c.getDocumentsService()),m=document.getElementById("fileBrowser"),f=!1;e.file_attached=!1,e.form={},e.error=[],e.pageTitle=atrans("newreaction","Nieuwe reactie"),e.attachment_type="file",e.setupFile=function(t){document.getElementById("fileBrowser").onchange=function(n){e.filePickedGeneric(n,t,e)}},e.$on("$ionicView.beforeEnter",function(){u.getDocument(t.id,t.personal).then(function(t){e.doc=t}),e.reactionplaceholder=atrans("reactionplaceholder","Typ uw reactie hier...")}),e.showFileActions=function(t){e.showFileActionsGeneric(t,e)},e.showAttachment=function(){e.file_attached&&"img"==e.attachment_type&&e.showImage(document.getElementById("reaction_attachment").src)},e.deleteAttachment=function(){""!=document.getElementById("reaction_attachment").src&&e.file_attached&&confirm(atrans("deletedeclarationphoto","Wil je deze foto verwijderen?"))&&(e.form.fileURI=void 0,document.getElementById("fileBrowser").form.reset(),document.getElementById("reaction_attachment").src="",e.file_attached=!1)},e.addReaction=function(){l()&&0==f&&(f=!0,u.addDocumentReaction(d,m,e.form).then(function(){e.form.fileURI=void 0,document.getElementById("fileBrowser").form.reset(),document.getElementById("reaction_attachment").src="",e.form={},SessionStorage.setItem("lastDocumentReactionAdded",JSON.stringify({id:e.doc.Id,personal:e.doc.personal})),o.goBack()})["finally"](function(){f=!1}))}}]);