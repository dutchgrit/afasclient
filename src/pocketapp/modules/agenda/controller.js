angular.module("agenda.controller",["AfasServices"]).controller("AgendaController",["$scope","$state","$timeout","$window","$location","$ionicPopover","$ionicScrollDelegate","$ionicHistory","$q","ConnectorService","AgendaServiceFactory","maxListTake","MultipleViewsManager",function(e,t,a,n,o,i,r,l,d,s,c,p,f){function g(){var t=75;return"browser"!=ionic.Platform.device().platform&&(ionic.Platform.isAndroid()&&(t=94),ionic.Platform.isIOS()&&(t=114)),t+=e.showCalendarScroll?84:0}function _(e){x[u(e)]={date:new Date(e),days:[],hasAppointments:!1,fillerBefore:h(e),fillerAfter:v(e)};for(var t=new Date(e.getFullYear(),e.getMonth(),0),a=0;a<t.daysInMonth();a++){t.setDate(t.getDate()+1);var n="";(6==t.getDay()||0==t.getDay())&&(n="calColorWeekend"),x[u(t)]&&x[u(t)].days.push({date:new Date(t),id:"d"+m(t),appointments:[],color:n})}var o=new Date;o.getMonth()==e.getMonth()&&x[u(o)]&&(x[u(o)].days[o.getDate()-1].color+=" calToday")}function u(e){var t=e.getFullYear()+"-"+format_two_digits(e.getMonth()+1);return t}function m(e){return e.getFullYear().toString()+format_two_digits(e.getMonth()+1)+format_two_digits(e.getDate())}function h(e){var t=[];if(1!=e.getDay()){var a=e.getDay();0==a&&(a=7);for(var n=0;a-1>n;n++){var o=new Date(e);o.setDate(o.getDate()-(n+1));var i="";t.unshift({date:new Date(o),id:m(new Date(o)),color:i,LineType:"othercalendar"})}}return t}function v(e){for(var t=[],a=new Date(e.getFullYear(),e.getMonth()+1,0,23,59),n=a.getDay(),o=0;14-n>o;o++){var i=new Date(a);i.setDate(a.getDate()+(1+o));var r="calColorOtherMonth";t.push({date:new Date(i),id:m(new Date(i)),color:r,LineType:"othercalendar"})}return t}function y(t,a){if(e.showCalendarScroll){for(var n=0,o=a+14,i=0;i<t.fillerBefore.length;i++)n>=a&&o>n?document.getElementById("calf_"+t.fillerBefore[i].id).style.display="":document.getElementById("calf_"+t.fillerBefore[i].id).style.display="none",n++;if(t.days)for(var i=0;i<t.days.length;i++)n>=a&&o>n?document.getElementById("cald_"+t.days[i].id).style.display="":document.getElementById("cald_"+t.days[i].id).style.display="none",n++;if(t.fillerAfter)for(var i=0;i<t.fillerAfter.length;i++)n>=a&&o>n?document.getElementById("calf_"+t.fillerAfter[i].id).style.display="":document.getElementById("calf_"+t.fillerAfter[i].id).style.display="none",n++}}function w(t,a){function n(n){var o=void 0===e.optionsCalendar.__NoProfit__||e.optionsCalendar.__NoProfit__.checked;if(window.plugins&&window.plugins.calendar&&o){var i={};window.plugins.calendar.findEvent(void 0,void 0,void 0,t,a,function(t){if(t)for(var a=0;a<t.length;a++)if(t[a].title){var o=t[a].title+t[a].location+t[a].endDate+t[a].startDate;if(1!=i[o]&&(i[o]=1,-1==t[a].title.toUpperCase().indexOf("PROFIT")&&1!=e.matchdb[t[a].title.substring(t[a].title.indexOf(": ")+2)])){apt_start_date=parseDateISOLocal(t[a].startDate),apt_end_date=parseDateISOLocal(t[a].endDate),t[a].allday||apt_start_date.getFullYear()!=apt_end_date.getFullYear()||apt_start_date.getMonth()!=apt_end_date.getMonth()||apt_start_date.getDate()!=apt_end_date.getDate()||0!=apt_start_date.getHours()||23!=apt_end_date.getHours()||0!=apt_start_date.getMinutes()||59!=apt_end_date.getMinutes()||(t[a].allday=!0);var r={externalid:t[a].id,description:t[a].title,text:t[a].message,location_description:t[a].location,attendees:t[a].attendees,allday:t[a].allday,start_datetime:getJSONDate(apt_start_date,!1,!0),end_datetime:getJSONDate(apt_end_date,!1,!0)};t[a].calendar?r.calendar=t[a].calendar:t[a].calendarId?r.calendar=T[t[a].calendarId]:r.calendar="__NoProfit__",r.calendar&&1!=N[r.calendar]&&(N[r.calendar]=1,e.foundExtCalendars=!0,void 0===O[r.calendar]&&(O[r.calendar]=!0),e.optionsCalendar[r.calendar]={text:r.calendar,checked:O[r.calendar]}),x[u(apt_start_date)]&&(x[u(apt_start_date)].days[apt_start_date.getDate()-1].appointments.push(r),x[u(apt_start_date)].hasAppointments=!0)}}n.resolve()},function(){n.resolve()})}else n.resolve()}var o,i=d.defer();return void 0===e.optionsCalendar.__Profit__||e.optionsCalendar.__Profit__.checked?b.getAppointments(t,a).then(function(t){if(e.canLoadMore=t.length>0?!0:!1,t)for(var a=0;a<t.length;a++)o=parseDateString(t[a].start_datetime),t[a].calendar="__Profit__",x[u(o)]&&(x[u(o)].days[o.getDate()-1].appointments.push(t[a]),x[u(o)].hasAppointments=!0),e.matchdb[t[a].description]=1})["finally"](function(){n(i)}):n(i),i.promise}var D,C,S,A,k,P,I,M,b=c.getInstance(),x={},$="",B=!1,E=!0,T={},O={},N={};e.selectedExtCalendars={},e.optionsCalendar={};var L=LocalStorage.getItem("sel_calendars");null!=L&&(O=JSON.parse(L)),void 0===O.__Profit__&&(O.__Profit__=!0),void 0===O.__NoProfit__&&(O.__NoProfit__=!0),e.optionsCalendar.__Profit__={text:atrans("profitappointments","Profit Afspraken"),checked:O.__Profit__},e.optionsCalendar.__NoProfit__={text:atrans("extappointments","Externe afspraken"),checked:O.__NoProfit__},window.plugins&&window.plugins.calendar&&window.plugins.calendar.listCalendars(function(e){for(var t=0;t<e.length;t++)T[e[t].id]=e[t].name}),e.starting=!0,e.$on("$ionicView.leave",function(){e.isLandscape()&&(e.slider.removeAllSlides(),e.slides=[],r.$getByHandle("agendascroll").scrollTo(0,0,!1))}),e.$on("$ionicView.beforeEnter",function(){(e.isLandscape()||E)&&e.refresh(),f.isActive()&&e.slider&&a(function(){e.slider.onResize(!0)},400)}),e.agendaSlider={effect:"slide",paginationHide:!0,initialSlide:1},e.$on("$ionicSlides.sliderInitialized",function(t,a){e.slider=a.slider}),e.checkSlides=function(){function t(n){if(n.length>0){for(var o=new Date(n[0].date),i=new Date(n[0].lastDayOfMonth),l=1;l<n.length;l++)o.valueOf()>n[l].date.valueOf()&&(o=new Date(n[l].date)),i.valueOf()<n[l].lastDayOfMonth.valueOf()&&(i=new Date(n[l].lastDayOfMonth));w(o,i)["finally"](function(){t([])})}else{if(I=!1,e.starting=!1,e.rememberScrollPos){var d=r.$getByHandle("agendascroll");k=d.getScrollView().__content.scrollHeight}else e.scrollTo();a(function(){E&&(e.checkscroll(),e.slider&&e.slider.slideTo(1,!1),a(function(){E=!1},500))},100),e.$broadcast("scroll.infiniteScrollComplete")}}I=!0;for(var n=[],o=0;o<e.slides.length;o++){var i=e.slides[o];if(!i.hasAppointments&&!i.loading){i.loading=!0;var l=new Date(i.date.getFullYear(),i.date.getMonth()+1,0,23,59),d=new Date(i.date.valueOf());0==o&&d.setMonth(d.getMonth()),n.push({date:d,lastDayOfMonth:l})}}t(n)},i.fromTemplateUrl("popoverCalendar.html",{scope:e}).then(function(t){e.calendarPopover=t}),e.openCalendarPopover=function(t){e.calendarPopover.show(t)},e.updateSelCalendars=function(){O.__Profit__!=e.optionsCalendar.__Profit__.checked&&e.optionsCalendar.__Profit__.checked&&e.refresh();var t=!0;if(O.__NoProfit__!=e.optionsCalendar.__NoProfit__.checked){for(var a in e.optionsCalendar)e.optionsCalendar.hasOwnProperty(a)&&"__Profit__"!=a&&"__NoProfit__"!=a&&(e.optionsCalendar[a].checked=e.optionsCalendar.__NoProfit__.checked,e.optionsCalendar[a].checked||(delete O[a],t=!1,O.__NoProfit__=!1));e.optionsCalendar.__NoProfit__.checked&&e.refresh()}if(t)for(var a in e.optionsCalendar)e.optionsCalendar.hasOwnProperty(a)&&(O[a]=e.optionsCalendar[a].checked);LocalStorage.setItem("sel_calendars",JSON.stringify(O))},e.$on("$destroy",function(){e.calendarPopover.remove(),delete e.slider}),e.refresh=function(){M=new Date,e.foundExtCalendars=!1,P=!0,$="",I=!1,E=!0,firstDayOfMonth=new Date(M.getFullYear(),M.getMonth(),1,0,0),lastDayOfMonth=new Date(M.getFullYear(),M.getMonth()+1,0,23,59),x={},D="",e.starting=!0;var t=g();e.listTop=t+"px",e.slides=[],e.matchdb={},e.selstart=0,e.pageTitle=atrans("agenda","Agenda"),e.showCalendarScroll=!0,e.slideIndex=1,e.rememberScrollPos=!1;for(var n=new Date(M.getFullYear(),M.getMonth()-2,1,0,0),o=0;3>o;o++)n.setMonth(n.getMonth()+1),_(n),e.slides.push(x[u(n)]);a(function(){var e=M,t=x[u(e)],a=14*Math.floor((t.fillerBefore.length+e.getDate()-1)/14);y(t,a)}),e.slider&&e.checkSlides()},e.addSlideAtEnd=function(t){var a=new Date(e.slides[e.slides.length-1].date);a.setMonth(a.getMonth()+1),x[u(a)]||_(a),e.slides.push(x[u(a)]),t&&e.checkSlides()},e.addSlideAtStart=function(t){var a=new Date(e.slides[0].date);a.setMonth(a.getMonth()-1),x[u(a)]||(_(a),e.slides.unshift(x[u(a)])),t&&(e.checkSlides(),e.rememberScrollPos||""!=$||e.slider.slideTo(1,!1))},e.$on("$ionicSlides.slideChangeStart",function(t,a){e.slideIndex=a.slider.activeIndex,a.slider.isEnd?e.addSlideAtEnd(!0):a.slider.isBeginning?e.addSlideAtStart(!0):e.checkSlides();var n=g();e.listTop=n+"px",r.$getByHandle("agendascroll").resize()}),e.selectThisDay=function(e){null!=document.getElementById(e)&&(P=!1,r.$getByHandle("agendascroll").scrollTo(0,document.getElementById(e).offsetTop-1,!1),a(function(){P=!0},20))},e.hasAppointments=function(t){for(var a=0;a<t.appointments.length;a++){var n=t.appointments[a];if(e.optionsCalendar[n.calendar]&&e.optionsCalendar[n.calendar].checked)return!0}return!1},e.postRender=function(){if(!I&&e.rememberScrollPos){var t=r.$getByHandle("agendascroll");if(t){var a=t.getScrollPosition(),n=t.getScrollView().__content.scrollHeight;t.scrollTo(0,a.top+(n-k),!1)}e.rememberScrollPos=!1}},e.checkscroll=function(){if(P){var t=r.$getByHandle("agendascroll");if(t){var n=t.getScrollPosition();if(n){var o=!1,i=E?M:e.slides[e.slider.activeIndex].date;C="cal_d"+m(i);for(var l=x[u(i)],d=14*Math.floor((l.fillerBefore.length+i.getDate()-1)/14),s=0;s<e.slides.length&&!o;s++)if(e.slides[s].days)for(var c=0;c<e.slides[s].days.length&&!o;c++){var p=e.slides[s].days[c].id;if(p){var f=document.getElementById(p);f&&f.offsetTop+f.offsetHeight/2>n.top&&(!B&&!E||e.slides[s].days[c].date>=i)&&(C="cal_"+e.slides[s].days[c].id,i=e.slides[s].days[c].date,l=x[u(i)],d=14*Math.floor((l.fillerBefore.length+i.getDate()-1)/14),o=!0)}}B&&a(function(){B=!1},100),C!=D&&(document.getElementById(C)&&(document.getElementById(C).className="cal-day cal-notification"),D&&document.getElementById(D)&&(document.getElementById(D).className="cal-day"),D=C),y(l,d),A=S;for(var s=0;s<e.slides.length;s++)if(u(e.slides[s].date)==u(i)){A=s;break}S!=A&&(S=A,0==S?(P=!1,e.rememberScrollPos=!0,e.addSlideAtStart(!0)):(P=!1,e.slider.slideTo(A,!1),a(function(){P=!0},20)))}}}else a(function(){P=!0},20)},e.scrollTo=function(){P?(P=!1,a(function(){var t=u(e.slides[e.slideIndex].date);if($!=t){var n=new Date(e.slides[e.slideIndex].date.getFullYear(),e.slides[e.slideIndex].date.getMonth(),1,0,0),o=40;""==$&&(n=new Date(M.getFullYear(),M.getMonth(),M.getDate(),0,0),o=1);var i="";if(x[t])for(var l=0;l<x[t].days.length;l++)if(e.hasAppointments(x[t].days[l])>0&&x[t].days[l].date>=n){i=x[t].days[l].id,f.isActive()&&e.goToAppointment(x[t].days[l].appointments[0]);break}""!=i?($=t,a(function(){P=!1,null!=document.getElementById(i)&&r.$getByHandle("agendascroll").scrollTo(0,document.getElementById(i).offsetTop-o,!1),a(function(){P=!0,E||e.checkscroll()},20)},20)):E||(P=!1,a(function(){P=!0,e.checkscroll()},20))}},20)):a(function(){P=!0},20)},e.goNext=function(){B=!0,P=!0,e.slider.slideNext(!0)},e.goLast=function(){B=!0,P=!0,""!=$?(e.addSlideAtEnd(),e.addSlideAtEnd(),e.addSlideAtEnd(!0)):e.$broadcast("scroll.infiniteScrollComplete")},e.goPrev=function(){B=!0,P=!0,1==e.slider.activeIndex?(e.addSlideAtStart(),e.addSlideAtStart(),e.addSlideAtStart(!0)):e.slider.slidePrev(!0)},e.goToAppointment=function(a){e.isLandscape()&&l.nextViewOptions({disableAnimate:!0}),f.isActive()?f.updateView("agenda-detail",{appointment:a}):t.go("menu.appointment",{appointment:a},{reload:!0})},e.showCalendar=function(){e.showCalendarScroll=!e.showCalendarScroll,B=!0;var t=g();e.listTop=t+"px",r.$getByHandle("agendascroll").resize(),e.showCalendarScroll?a(function(){e.checkscroll()},10):D=""}}]).controller("AppointmentController",["$scope","$state","$timeout","$ionicActionSheet","ConnectorService","ConfigService","ContactServiceFactory","AgendaServiceFactory","MultipleViewsManager",function(e,t,a,n,o,i,r,l,d){function s(){if(!e.appointment.externalid&&e.appointment.personal_status){var t=rejectenabled=deleteenabled=!1;switch(e.appointment.personal_status){case"0":t=!0,rejectenabled=!0;break;case"1":t=!0;case"2":deleteenabled=!0;break;case"3":t=!0}t&&e.actions.push({Id:"Accept",Caption:atrans("appaccept","Accepteer afspraak")}),rejectenabled&&e.actions.push({Id:"Reject",Caption:atrans("appreject","Weiger afspraak")}),deleteenabled&&e.actions.push({Id:"Delete",Caption:atrans("accdelete","Accepteer verwijdering")}),e.appointment.owner&&"1"!=e.appointment.personal_status&&"2"!=e.appointment.personal_status&&"1"==e.appointment.status_code&&e.actions.push({Id:"AccRefused",Caption:atrans("appaccrefused","Accepteer weigeringen overige genodigden")}),e.appointment.owner&&"2"!=e.appointment.personal_status&&e.actions.push({Id:"AppDelete",Caption:atrans("appdelete","Verwijder afspraak")})}}function c(e,t){var a=parseDateString(e),n=parseDateString(t);return a.getDate()==n.getDate()&&a.getMonth()==n.getMonth()&&a.getFullYear()==n.getFullYear()?!0:!1}function p(){if(e.appointment)if(e.appointment.externalid){if(e.appointment.attendees){for(var t=[],a=[],n={},o=0;o<e.appointment.attendees.length;o++){var i,r={external:!0,email:e.appointment.attendees[o].email,displayName:e.appointment.attendees[o].name};e.appointment.attendees[o].email&&(i=e.appointment.attendees[o].email),e.appointment.attendees[o].URL&&-1!=e.appointment.attendees[o].URL.indexOf("mailto:")&&(i=e.appointment.attendees[o].URL.substring(7),r.email=i),1!=n[i.toLowerCase()]&&(n[i.toLowerCase()]=1,a.push(i),t.push(r))}e.attendees=t,a.length>0&&a.length<30&&_.searchByEmails(a).then(function(t){for(var a=0;a<e.attendees.length;a++)for(var n=0;n<t.length;n++)if(e.attendees[a].email&&(null!=t[n].email_work&&e.attendees[a].email.toLowerCase()==t[n].email_work.toLowerCase()||null!=t[n].email_personal&&e.attendees[a].email.toLowerCase()==t[n].email_personal.toLowerCase())){e.attendees[a].contact_person_id=t[n].guid,e.attendees[a].contact_person_image_id=t[n].image_id_person,e.attendees[a].haslink=!0;break}f(e.attendees)})}}else g.getAttendees(e.appointment.appointment_id).then(function(t){for(var a=0;a<t.length;a++){t[a].haslink=!0,t[a].user_id?t[a].displayName=t[a].user_name:t[a].displayName=t[a].contact_descripton;var n=[];switch(t[a].owner&&n.push(atrans("owner","Eigenaar")),parseInt(t[a].presence)){case 0:n.push(atrans("required","Vereist"));break;case 1:n.push(atrans("optionalApt","Optioneel"));break;case 2:n.push(atrans("planner","Inplanner (zelf afwezig)"))}t[a].status=n.join(", ")}e.attendees=t,f(e.attendees)})}function f(t){for(var a={},n=0;n<t.length;n++)t[n].contact_person_image_id&&(a[t[n].contact_person_image_id]||(a[t[n].contact_person_image_id]=!0,o.getImageData(t[n].contact_person_image_id,1).then(function(t){if(t.url)for(var a=0;a<e.attendees.length;a++)e.attendees[a].contact_person_image_id==t.key&&(e.attendees[a].image=t.url)})))}e.pageTitle=atrans("appointment","Afspraak");var g=l.getInstance(),_=r.getInstance();t.params&&null!=t.params.appointment&&(e.appointment=t.params.appointment,e.actions=[],p(),e.sameDay=c(e.appointment.start_datetime,e.appointment.end_datetime),s()),d.updated("agenda-detail",function(t){t&&(e.appointment=t.appointment,e.actions=[],p(),e.sameDay=c(e.appointment.start_datetime,e.appointment.end_datetime),s())}),e.goToAttendee=function(t){var a=(t.employee_id,t.contact_person_id);e.gotoContact(a)},e.showActions=function(){for(var t=new Array,o=0;o<e.actions.length;o++){var i=e.actions[o];t.push({text:i.Caption})}a(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),n.show({buttons:t,titleText:atrans("calendaractions","Afspraak acties"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(t){e.actions[t]}})}}]);