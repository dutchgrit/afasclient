function getDeclarationHREF(e){return"#/menu/subject/"+encodeURIComponent(e.guid)+"/"}angular.module("declarations.controller",["AfasServices"]).factory("SharedDeclarationService",["DeclarationServiceFactory",function(e){var t=e.getInstance();return{getDeclarationService:function(){return t}}}]).controller("DeclarationsController",["$scope","$timeout","$stateParams","$state","SearchService","SharedDeclarationService","$ionicActionSheet","ListServiceFactory","UserService","ConfigService","AbsenceServiceFactory","EnvConfigService","ModalSearchService",function(e,t,o,n,i,r,a,c,l,d,s,f,m){var u=r.getDeclarationService(),h=s.getInstance();e.pageTitle=atrans("declarations","Declaraties"),e.noresults=!1,e.form={};var g=c.getInstance();g.getHREFCallback=getDeclarationHREF;var v={DeclarationService:u};e.$on("$ionicView.enter",function(){d.getConfig().then(function(t){l.getUser().then(function(o){e.multipledvb=o.multiple_employment&&isVersionOrHigher(t,"Profit6"),e.multipledvb&&h.getDvbs(e.form,!1).then(function(t){e.dvbs=checkDvbDuplicates(t),e.multipledvbshow=t.length>1});var n;e.multipledvb&&(n=e.form.dvbsel?e.form.dvbsel.employment:o.dvb),u.getDeclarations(o.user,n).then(function(t){e.declarations=g.divideList(t,4,"date",2),0==e.declarations.length&&(e.noresults=!0)})})})}),e.changeDvb=function(){l.getUser().then(function(t){var o;e.multipledvb&&(e.form.dvbsel?(o=e.form.dvbsel.employment,SessionStorage.setItem("dvbsel",JSON.stringify(e.form.dvbsel))):o=t.dvb),u.getDeclarations(t.user,o).then(function(t){e.declarations=g.divideList(t,4,"date",2),0==e.declarations.length&&(e.noresults=!0)})})},e.newDeclaration=function(){d.getConfig().then(function(o){function i(e){t(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),a.show({buttons:e,titleText:atrans("newdeclaration","Nieuwe declaratie"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(t){n.go("menu.newdeclaration",{type:e[t].id,declprofile:e[t].declProfile,retour:!1},{reload:!0})}})}var r=new Array({text:atrans("gencost","Algemene kosten"),id:0,declProfile:null},{text:atrans("travelcost","Reiskosten"),id:1,declProfile:null});isVersionOrHigher(o,"Profit7")?f.getEnvConfig().then(function(t){t.profileinfo[27]&&t.profileinfo[27]>0?t.profileinfo[27]>5?e.openModal():u.searchProfiles("",0,6).then(function(e){for(var t=[],o=0;o<e.length;o++)t.push({text:"<i class='icon iconHide'></i>"+e[o].Description,id:2,declProfile:e[o]});i(t)}):i(r)}):i(r)})},e.goToDetail=function(e){0!=e.status&&d.getConfig().then(function(t){null!=t&&-1!=t.modules.indexOf(1)?n.go("menu.subject",{subjectId:e.subjectid},{reload:!0}):n.go("menu.declarationdetails",{subjectId:e.subjectid},{reload:!0})})},e.openModal=function(){m.openModal(e,"Pocket_DeclProfiles",v)},e.closeModal=function(){e.modal.hide()},e.showhide=function(){e.hidden=!e.hidden},e.search=function(t){m.search(e,t,v)},e.loadMore=function(){m.loadMore(e,v)},e.clearSearch=function(t){m.clearSearch(e)},e.clickRecent=function(t){e.modal.query=t,m.search(e,t,v)},e.ShowRecentSearches=function(){m.ShowRecentSearches(e)},e.HideRecentSearches=function(){m.HideRecentSearches(e)},e.selectTab=function(t){e.modal&&!e.modal.loading&&(e.modal.showType=t)},e.selectDeclType=function(t){i.setRecentlySelected(t,"recent_decl_profiles"),n.go("menu.newdeclaration",{type:2,declprofile:t,retour:!1},{reload:!0}),e.modal&&e.modal.hide()}}]).controller("DeclarationDetailsController",["$scope","$stateParams","SharedDeclarationService","ConfigService",function(e,t,o,n){var i=o.getDeclarationService();e.$on("$ionicView.enter",function(){var o=t.subjectId;e.pageTitle=atrans("declaration","Declaratie"),i.getDeclarationBySubjectId(o).then(function(t){e.declaration=t}),n.getConfig().then(function(t){isVersionOrHigher(t,"Profit7")&&i.getDeclarationFreeTablBySubjectId(o).then(function(t){parseInfo(e,t,null,!0),e.info=t})})})}]).controller("NewEditDeclarationController",["$scope","$stateParams","$ionicScrollDelegate","$ionicPopup","$ionicPosition","$ionicModal","$timeout","$state","SearchService","TimesheetServiceFactory","SharedDeclarationService","UserService","ConnectorService","ConfigService","DatePickerService","ModalSearchService","uiGmapGoogleMapApi","maxListTake","EnvConfigService","AbsenceServiceFactory","SubjectServiceFactory","$ionicHistory","question",function(e,t,o,n,i,r,a,c,l,d,s,f,m,u,h,g,v,p,y,I,w,S,D){function b(t,o){var n=!0;return e.error=[],0==o?((void 0==t.amount||t.amount<=0)&&(e.error[0]=atrans("noamountspecified","Vul een bedrag in"),n=!1),void 0==t.type&&(e.error[1]=atrans("notypespecified","Vul een declaratietype in"),n=!1),0==document.getElementById("fileBrowser").files.length&&void 0==t.fileURI&&(e.error[2]=atrans("noattachmentadded","Voeg een bijlage toe"),n=!1)):1==o&&(void 0==t.distance||t.distance<=0)&&(e.error[2]=atrans("nodistancespecified","Vul een afstand in"),n=!1),n&&(e.error=!1),n}function _(){var t={zoom:16,center:e.fromResult.geometry.location};e.Map.setZoom(t.zoom),e.Map.setCenter(t.center),e.DirectionsRenderer.setMap(e.Map);var n={origin:e.fromResult.place_id?{placeId:e.fromResult.place_id}:e.fromResult.geometry.location,destination:e.toResult.place_id?{placeId:e.toResult.place_id}:e.toResult.geometry.location,optimizeWaypoints:!0,durationInTraffic:!1,provideRouteAlternatives:!0,travelMode:google.maps.TravelMode.DRIVING};e.DirectionsService.route(n,function(t,n){if(n==google.maps.DirectionsStatus.OK){for(var i=0,r=0,c=0,l=0,d=0;d<t.routes.length;d++)0==d&&(r=t.routes[0].legs[0].distance.value,l=t.routes[0].legs[0].duration.value),t.routes[d].legs[0].distance.value<r&&(r=t.routes[d].legs[0].distance.value,i=d),t.routes[d].legs[0].duration.value<l&&(l=t.routes[d].legs[0].duration.value,c=d);var s="1"==e.fastestroute?c:i;t.routes[0]=t.routes[s],e.DirectionsRenderer.setDirections(t),e.form.distance=e.todigits(t.routes[s].legs[0].distance.value/1e3),e.form.distanceshow=e.todigits(t.routes[s].legs[0].distance.value/1e3),e.form.duration=" ("+t.routes[s].legs[0].duration.text+")",e.form.KmCa=e.form.distance,e.form.Qu=e.form.retour?2*e.form.distance:e.form.distance,a(function(){e.$apply()}),o.$getByHandle("map").scrollBottom(!0)}})}var j,P=s.getDeclarationService(),C=I.getInstance(),T=d.getInstance(),R=w.getInstance(),k=!1;t.subjectId&&t.subjectId>0?(e.subjectId=t.subjectId,e.declType=2,e.edit=!0):(e.declType=t.type,e.declProfile=t.declprofile,e.edit=!1),e.attachment_type="file",e.hidden=!0,e.form={},e.form.DaTi=null,e.form_modal={},e.form.startdate=new Date,e.form.startdateJourney=new Date,e.error=[],e.form.errorfld={},e.info=null,e.infoLoaded=!1,e.pageTitle=e.edit?atrans("editdeclaration","Declaratie aanpassen"):atrans("newdeclaration","Nieuwe declaratie"),e.commentplaceholder=atrans("typeyourcommentshere","Typ je commentaar hier"),e.typePlaceholder=atrans("enterdeclarationtypehere","Vul hier een declaratietype in"),e.projectPlaceholder=atrans("enterprojectcodehere","Vul hier een projectcode in"),e.file_attached=!1,e.fastestroute=1;var M={DeclarationService:P};e.selectTab=function(t){e.modal&&!e.modal.loading&&(e.modal.showType=t)},e.setupFile=function(t){document.getElementById("fileBrowser").onchange=function(o){e.filePickedGeneric(o,t,e)}},e.$on("$ionicView.enter",function(){k=!1,e.projectsactive=!0,y.getEnvConfig().then(function(t){e.projectsactive="0"!=t.projectsactive}),u.getConfig().then(function(t){e.fastestroute=t.fastestroute,f.getUser().then(function(o){e.multipledvb=o.multiple_employment&&isVersionOrHigher(t,"Profit6"),e.multipledvb&&C.getDvbs(e.form,!1).then(function(t){e.dvbs=checkDvbDuplicates(t),e.multipledvbshow=t.length>1})}),e.multipleattach=isVersionOrHigher(t,"Profit8"),2==e.declType&&e.declProfile||e.edit?(e.info=null,e.form={},e.form.errorfld={},e.form.attachments=[],e.form.startdate=new Date,e.form.startdateJourney=new Date,e.checkForOSAttachments(e.form),e.form.DaTi=null,f.getUser().then(function(t){e.edit?P.getEditDeclarationInfo(e.subjectId).then(function(o){R.getAttachments({guid:e.subjectId}).then(function(n){parseInfo(e,o,t,!1,"validateEntry2"),e.setKmCostDigits(),e.form.ProfileId={id:o.TPrId.value},e.info.ProfileId={element:"HrDeclarationInsite"},e.form.startdate=o.DaTi.value,e.form.startdateJourney=o.DaTi.value,e.form.DaTi=o.DaTi.value,e.form.attachments=[];for(var i=0;i<n.length;i++)m.getFileData(n[i],"file_id","file_name").then(function(t){e.file_attached=!0;var o="data:"+t.mimetype+";base64,"+t.filedata;t.mimetype.startsWith("image/")?e.form.attachments.push({src:o,type:"img",filename:t.filename,fileId:t.guid}):e.form.attachments.push({src:"img/file.png",type:"file",filename:t.filename,fileId:t.guid})})})["finally"](function(){e.infoLoaded=!0})},function(){S.goBack()}):(P.getDeclarationInfo(e.declProfile.Id).then(function(o){parseInfo(e,o,t,!1,"validateEntry2"),e.setKmCostDigits(),e.form.ProfileId={id:e.declProfile.Id},e.info.ProfileId={element:"HrDeclarationInSite"},e.form.startdate=e.form.DaTi,e.form.startdateJourney=e.form.DaTi})["finally"](function(){e.infoLoaded=!0}),function(){S.goBack()})})):e.setKmCostDigits()})}),e.setKmCostDigits=function(){u.getConfig().then(function(t){if(isVersionOrHigher(t,"Profit6")){var o=t.kmcostid;e.form.BiId&&(o=e.form.BiId.id),null!=o||""!=o?P.getKmCostDigits(o).then(function(t){e.kmcostdigits=t}):e.kmcostdigits=2}else e.kmcostdigits=2})},e.todigits=function(t){return null!=t?parseFloat(t.toFixed(e.kmcostdigits)):t},e.pickStartDate=function(){h.pickDate(e.form.startdate).then(function(t){e.form.startdate=t})},e.pickStartJourneyDate=function(){h.pickDate(e.form.startdateJourney).then(function(t){e.form.startdateJourney=t})},e.openModalforField=function(t){if(M.fieldId=t,e.info[t])M.searchview=e.info[t].searchview,M.searchview.filter=e.info[t].filter,isNotEmpty(M.searchview.fieldId2)&&(M.searchview.fromfieldId1?M.searchview.fieldValue2=formvalue(e.form[M.searchview.fromfieldId1],e.info[M.searchview.fromfieldId1]):e.form[M.searchview.fieldId2]&&(M.searchview.fieldValue2=formvalue(e.form[M.searchview.fieldId2],e.info[M.searchview.fieldId2]))),isNotEmpty(M.searchview.fieldId3)&&(M.searchview.fromfieldId2?M.searchview.fieldValue3=formvalue(e.form[M.searchview.fromfieldId2],e.info[M.searchview.fromfieldId2]):e.form[M.searchview.fieldId3]&&(M.searchview.fieldValue3=formvalue(e.form[M.searchview.fieldId3],e.info[M.searchview.fieldId3])));else for(var o in e.info.custom)if(e.info.custom.hasOwnProperty(o)&&e.info.custom[o][t]){M.searchview=e.info.custom[o][t].searchview;break}g.openModal(e,"Pocket_DeclarationFields",M)},e.openModal=function(t){2==e.declType&&"Pocket_Project_Stages"==t&&(e.form.project={project_id:e.form.PrId.id}),g.openModal(e,t,M)},e.closeModal=function(){e.modal.hide()},e.showhide=function(){e.hidden=!e.hidden},e.search=function(t,o){g.search(e,t,M)},e.loadMore=function(t){g.loadMore(e,M)},e.clearSearch=function(t){g.clearSearch(e)},e.clickRecent=function(t){e.modal.query=t,g.search(e,t,M)},e.ShowRecentSearches=function(t){"Pocket_DeclarationFields"==t?g.ShowRecentSearches(e,M):g.ShowRecentSearches(e)},e.HideRecentSearches=function(t){"Pocket_DeclarationFields"==t?g.HideRecentSearches(e,M):g.HideRecentSearches(e)},e.validateEntry2Delayed=function(t,o){j&&a.cancel(j),j=a(function(){j=null,e.validateEntry2(t,o)},800)},e.validateEntry2=function(t,o){if(e.form[o]=null,"string"!=typeof t&&(t=String(t)),t.length>0){if(e.form[o]={id:t},M.fieldId=o,e.info[o])M.searchview=e.info[o].searchview,isNotEmpty(M.searchview.fieldId2)&&(M.searchview.fromfieldId1?M.searchview.fieldValue2=formvalue(e.form[M.searchview.fromfieldId1],e.info[M.searchview.fromfieldId1]):e.form[M.searchview.fieldId2]&&(M.searchview.fieldValue2=formvalue(e.form[M.searchview.fieldId2],e.info[M.searchview.fieldId2]))),isNotEmpty(M.searchview.fieldId3)&&(M.searchview.fromfieldId2?M.searchview.fieldValue3=formvalue(e.form[M.searchview.fromfieldId2],e.info[M.searchview.fromfieldId2]):e.form[M.searchview.fieldId3]&&(M.searchview.fieldValue3=formvalue(e.form[M.searchview.fieldId3],e.info[M.searchview.fieldId3])));else for(var n in e.info.custom)if(e.info.custom.hasOwnProperty(n)&&e.info.custom[n][o]){M.searchview=e.info.custom[n][o].searchview;break}M.onlyId=!0,P.searchForField(M,t,0,p,!0).then(function(o){for(var n=o.rows,i=0;i<n.length;i++)if(n[i]._id==t)return void e.selectItem(n[i]);n&&n.length>0&&e.selectItem(n[0])})}},e.selectItem=function(t){e.form[t.fieldId]={id:t._id,name:t._name},e.form[t.fieldId+"_entry"]=t._id,l.setRecentlySelected(t,"recent_decl_"+t.fieldId),e.form.errorfld[t.fieldId]="","BiId"==t.fieldId&&e.setKmCostDigits(),e.form.errorfld[t.fieldId]="",e.modal&&e.modal.hide()},e.validateEntry=function(t,o){j&&a.cancel(j),j=a(function(){"project"==o?(e.validProject=!1,e.form.project=null,e.hasStages=!1,t.length>=1&&T.validateEntry(t,o,{}).then(function(t){e.selectProject(t[0])})):"type"==o?(e.validType=!1,e.form.type=null,P.validateEntry(t,o).then(function(t){e.selectType(t[0])})):"project_stage"==o&&(e.validProjectStage=!1,e.form.projectstage=null,t.length>=1&&T.validateEntry(t,o,{}).then(function(t){e.selectProjectStage(t[0])})),j=null},500)},e.selectProject=function(t){T.getProjectById(t.project_id).then(function(t){if(t.length>0){var o=t[0];e.form.project=o,e.form.project_entry=o.project_id,e.hasStages=o.number_of_stages>0;var n={project_id:o.project_id,number_of_stages:o.number_of_stages,project_name:o.project_name,contact_name:o.contact_name};l.setRecentlySelected(n,"recent_projects")}e.modal&&e.modal.hide()})},e.changeDvb=function(){f.getUser().then(function(t){e.multipledvb&&e.form.dvbsel&&SessionStorage.setItem("dvbsel",JSON.stringify(e.form.dvbsel))})},e.selectType=function(t){e.form.type=t,e.form.type_entry=t.id,e.modal&&e.modal.hide(),l.setRecentlySelected(t,"recent_declaration_types")},e.addAttachment=function(t){e.showFileActionsGeneric(t,e)},e.showAttachment=function(t){t?"img"==t.type&&e.showImage(t.src):e.file_attached&&"img"==e.attachment_type&&e.showImage(document.getElementById("declaration_attachment").src)},e.deleteAttachment=function(t){if(t){if(""!=t.src&&e.file_attached){var o=e.form.attachments.indexOf(t);-1!=o&&e.form.attachments.splice(o,1)}}else""!=document.getElementById("declaration_attachment").src&&e.file_attached&&D(atrans("deletedeclarationphoto","Wil je deze foto verwijderen?")).then(function(t){t&&(e.file_attached=!1,e.form.fileURI=void 0,document.getElementById("fileBrowser").form.reset(),document.getElementById("declaration_attachment").src="")})},e.selectProjectStage=function(t){e.form.projectstage=t,e.form.projectstage_entry=t.projectstage_id,e.modal&&e.modal.hide()},e.declarationSend=function(t){var r,l;2==t?f.getUser().then(function(t){e.form.errorfld={};var c=!1;e.info.kmdecl&&(e.form.Qu||(e.form.Qu=e.form.retour?2*e.form.KmCa:e.form.KmCa),e.form.KmRt=e.form.retour?"1":"0"),e.multipledvb&&e.form.dvbsel&&(e.form.EnSe={id:e.form.dvbsel.employment});for(l in e.info)e.info.hasOwnProperty(l)&&"FiId"!=l&&"attachments"!=l&&(c|=checkFormField(e.form,e.info,l,t));for(r in e.info.custom)if(e.info.custom.hasOwnProperty(r))for(l in e.info.custom[r])e.info.custom[r].hasOwnProperty(l)&&(c|=checkFormField(e.form,e.info.custom[r],l,t));e.info.kmdecl||e.info.FiId&&e.info.FiId.mandatory&&0==e.form.attachments.length&&(e.error[2]=atrans("noattachmentadded","Voeg een bijlage toe"),a(function(){var e=document.getElementById("errorfile");if(null!=e){var t=i.position(angular.element(e));o.$getByHandle("main").scrollTo(0,t.top,!1)}},10),c=!0),c||k?showErrors(e.form,e.info,"main",a,n,i,o):(k=!0,u.getConfig().then(function(t){P.postDeclaration(t,e.form,e.info,e.edit,e.subjectId).then(function(t){e.previousPage()})["finally"](function(){k=!1})}))}):b(e.form,t)&&!k&&(k=!0,f.getUser().then(function(o){if(0==t){e.form.date=e.form.startdate;var n=document.getElementById("fileBrowser");P.sendDeclaration(o,e.form,n).then(function(){e.form={},n.form.reset(),document.getElementById("declaration_attachment").src="",c.go("menu.declarations",{},{reload:!0})})["finally"](function(){k=!1})}else 1==t&&(e.form.date=e.form.startdateJourney,P.sendDeclarationJourney(o,e.form).then(function(){e.form={},c.go("menu.declarations",{},{reload:!0})})["finally"](function(){k=!1}))}))},e.goToDistance=function(){e.form.KmFr&&(e.form.from=e.form.KmFr),e.form.KmTo&&(e.form.to=e.form.KmTo),e.distanceModal?e.distanceModal.show():(e.fromText=atrans("chooselocation","Kies locatie"),e.toText=atrans("chooselocation","Kies locatie"),e.modalTitle=atrans("calculatedistancetitle","Afstand berekenen"),e.fromResult=null,e.toResult=null,e.calculated=!1,r.fromTemplateUrl("modules/declarations/calculatedistance.html",{scope:e,animation:"slide-in-up"}).then(function(t){u.getConfig().then(function(o){e.distanceModal=t,e.distanceModal.show(),a(function(){v.then(function(o){var n=t.modalEl.getElementsByClassName("distanceMapItem")[0];e.Map=new google.maps.Map(n,{zoom:7,center:new google.maps.LatLng(52.143506699,5.4194623)}),e.DirectionsService=new google.maps.DirectionsService,e.DirectionsRenderer=new google.maps.DirectionsRenderer,e.GeoCoder=new google.maps.Geocoder})},400)})}))},e.closeModal=function(){e.distanceModal&&e.distanceModal.hide(),e.modal&&e.modal.hide()},e.closeDistanceModal=function(){e.distanceModal.hide()},e.distancechange=function(){e.form.distance=e.todigits(e.form.distance),e.form.distance>0&&(e.form.KmCa=e.form.distance)},e.retourchange=function(){e.form.distance>0&&(e.form.KmCa=e.form.distance,e.form.Qu=e.form.retour?2*e.form.distance:e.form.distance)},e.calculate=function(){e.GeoCoder.geocode({address:e.form.from,region:"NL"},function(t,o){o==google.maps.GeocoderStatus.OK&&t.length>0&&(e.fromResult=t[0],e.GeoCoder.geocode({address:e.form.to,region:"NL"},function(t,o){o==google.maps.GeocoderStatus.OK&&t.length>0&&(e.toResult=t[0],_(),e.calculated=!0,e.from=e.form.from,e.to=e.form.to,e.info&&e.form&&(e.form.KmFr=e.form.from,e.form.KmTo=e.form.to))}))})},e.setDistance=function(){e.closeDistanceModal()}}]);