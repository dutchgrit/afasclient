angular.module("employees.controller",["AfasServices"]).factory("SharedEmployeeService",["EmployeeServiceFactory",function(e){var o=e.getInstance();return{getEmployeeService:function(){return o}}}]).controller("EmployeesController",["$scope","$state","$window","$timeout","$ionicScrollDelegate","$ionicTabsDelegate","ConnectorService","SharedEmployeeService","MultipleViewsManager","UserService","ConfigService","SearchService","maxListTake",function(e,o,t,n,i,a,l,r,s,c,m,d,p){function g(){y.getEmployees(0,p).then(function(o){e.employees=o,f+=o.length,u(o),o.length>=p&&(e.showmore=!0)})}function h(){y.getTeams(0,p).then(function(o){e.teams=o,v+=o.length,o.length>=p&&(e.showmoreTeams=!0)})}function u(e){for(var o={},t=0;t<e.length;t++)e[t].image_id&&(o[e[t].image_id]||(o[e[t].image_id]=!0,l.getImageData(e[t].image_id,1).then(function(o){if(o.url)for(var t=0;t<e.length;t++)e[t].image_id==o.key&&(e[t].image=o.url)})))}var y=r.getEmployeeService(),f=0,v=0;e.formData=[],e.formData.query="",e.pageTitle=atrans("whoiswho","Wie is wie"),e.searchplaceholder=atrans("employeeplaceholder","Zoek op naam of afkorting"),e.loadingMore=!1,e.loadingMoreTeams=!1,e.titleAll=atrans("general","Algemeen"),e.titleTeams=atrans("departments","Afdelingen"),e.titleBirthdays=atrans("birthdays","Jarigen"),e.$on("$ionicSlides.sliderInitialized",function(o,t){e.slider=t.slider}),e.$on("$ionicSlides.slideChangeStart",function(e,o){n(function(){a.$getByHandle("tabsemployees").select(o.slider.activeIndex)},1)}),e.$on("$ionicView.beforeEnter",function(){e.landscape=e.isLandscape(),m.getConfig().then(function(o){-1==o.modules.indexOf(11)?e.gotoPage("menu.home"):e.slider&&n(function(){e.slider&&e.slider.onResize(!0)},400)})}),e.$on("$ionicView.unloaded",function(){e.slider=void 0}),e.show=function(o){e.slider&&e.slider.activeIndex!=o&&e.slider.slideTo(o)},m.getConfig().then(function(o){if(isVersionOrHigher(o,"Profit5")){var t=!isVersionOrHigher(o,"Profit11")||-1!=o.modules.indexOf(19);e.showTeams=t,t&&h()}isVersionOrHigher(o,"2016B2PU12")&&-1!=o.modules.indexOf(11)&&y.getBirthdayBoys().then(function(t){e.birthdays=t;var n=!isVersionOrHigher(o,"Profit11")||-1!=o.modules.indexOf(18);e.showBirthdays=n&&e.birthdays.length>0,u(t,o)})}),g(),e.loadMoreEmployees=function(){e.showmore&&!e.loadingMore&&(e.loadingMore=!0,y.getEmployees(f,p).then(function(o){e.showmore=o.length-f>=p,e.employees=o,f=o.length,u(o),e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){e.loadingMore=!1,i.$getByHandle("employees").resize(),e.$broadcast("scroll.refreshComplete")}))},e.loadMoreTeams=function(){e.showmoreTeams&&!e.loadingMoreTeams&&(e.loadingMoreTeams=!0,y.getTeams(v,p).then(function(o){e.showmoreTeams=o.length-v>=p,e.teams=o,v=o.length,e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){e.loadingMoreTeams=!1,i.$getByHandle("teams").resize(),e.$broadcast("scroll.refreshComplete")}))},e.searchEmployees=function(o){o=o||e.formData.query,o.length>2?(d.setSearchHistory(o,"Employees"),y.searchEmployees(o).then(function(o){0==o.length&&(e.noresults=!0),f=0,e.showmore=!1,e.employees=o,u(o),i.$getByHandle("employees").scrollTop(!1),hideKeyboard(),e.HideRecentSearches()})):0==o.length&&e.clearSearch()},e.goToEmployee=function(t){s.isActive()?(e.selectedEmployee=t,s.updateView("employees-detail",{employeeId:t})):o.go("menu.employee",{id:t})},e.goToTeam=function(o){e.gotoPage("menu.team",{id:o})},e.ShowRecentSearches=function(){d.getSearchHistory("Employees").then(function(o){e.recent=o})},e.HideRecentSearches=function(){n(function(){e.recent=0},100)},e.clickRecent=function(o){e.formData.query=o,e.searchEmployees(o)},e.removeItem=function(e,o){e.preventDefault(),e.stopPropagation(),d.removeItem(o,"Employees")},e.clearSearch=function(){e.formData.query="",e.HideRecentSearches(),e.employees=null,f=0,g()}}]).controller("TeamController",["$scope","$state","$window","$timeout","$ionicScrollDelegate","$ionicTabsDelegate","ConnectorService","SharedEmployeeService","MultipleViewsManager","UserService","ConfigService","SearchService","maxListTake","$stateParams",function(e,o,t,n,i,a,l,r,s,c,m,d,p,g){function h(){y.getEmployeesByTeam(v,0,p).then(function(o){e.employees=o,f+=o.length,u(o),o.length>=p&&(e.showmore=!0)})}function u(e){for(var o={},t=0;t<e.length;t++)e[t].image_id&&(o[e[t].image_id]||(o[e[t].image_id]=!0,l.getImageData(e[t].image_id,1).then(function(o){if(o.url)for(var t=0;t<e.length;t++)e[t].image_id==o.key&&(e[t].image=o.url)})))}var y=r.getEmployeeService(),f=0,v=g.id;e.searchplaceholder=atrans("employeeplaceholder","Zoek op naam of afkorting"),e.loadingMore=!1,e.titleAll=atrans("general","Algemeen"),e.titleBirthdays=atrans("birthdays","Jarigen"),y.getTeam(v).then(function(o){e.pageTitle=o.team_description}),e.$on("$ionicSlides.sliderInitialized",function(o,t){e.slider=t.slider}),e.$on("$ionicSlides.slideChangeStart",function(e,o){n(function(){a.$getByHandle("tabsemployees").select(o.slider.activeIndex)},1)}),e.$on("$ionicView.beforeEnter",function(){e.landscape=e.isLandscape(),m.getConfig().then(function(o){-1==o.modules.indexOf(11)?e.gotoPage("menu.home"):e.slider&&n(function(){e.slider&&e.slider.onResize(!0)},400)})}),e.$on("$ionicView.unloaded",function(){e.slider=void 0}),e.show=function(o){e.slider&&e.slider.activeIndex!=o&&e.slider.slideTo(o)},m.getConfig().then(function(o){isVersionOrHigher(o,"2016B2PU12")&&-1!=o.modules.indexOf(11)&&y.getBirthdayBoys(v).then(function(o){e.teambirthdays=o,u(o)})}),h(),e.loadMoreEmployees=function(){e.showmore&&!e.loadingMore&&(e.loadingMore=!0,y.getEmployeesByTeam(v,f,p).then(function(o){e.showmore=o.length-f>=p,e.employees=o,f=o.length,u(o),e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){e.loadingMore=!1,i.$getByHandle("employees").resize(),e.$broadcast("scroll.refreshComplete")}))},e.searchEmployees=function(o){o=o||e.formData.query,o.length>2?(d.setSearchHistory(o,"Employees"),y.searchEmployees(o).then(function(o){0==o.length&&(e.noresults=!0),f=0,e.showmore=!1,e.employees=o,u(o),i.$getByHandle("employees").scrollTop(!1),hideKeyboard(),e.HideRecentSearches()})):0==o.length&&e.clearSearch()},e.goToEmployee=function(t){s.isActive()?(e.selectedEmployee=t,s.updateView("employees-detail",{employeeId:t})):o.go("menu.employee",{id:t})},e.ShowRecentSearches=function(){d.getSearchHistory("Employees").then(function(o){e.recent=o})},e.HideRecentSearches=function(){n(function(){e.recent=0},100)},e.clickRecent=function(o){e.formData.query=o,e.searchEmployees(o)},e.removeItem=function(e,o){e.preventDefault(),e.stopPropagation(),d.removeItem(o,"Employees")},e.clearSearch=function(){e.formData.query="",e.HideRecentSearches(),e.employees=null,f=0,h()}}]).controller("EmployeeController",["$scope","$state","$stateParams","$timeout","$location","$ionicTabsDelegate","$ionicPopover","$ionicScrollDelegate","$ionicPosition","ConnectorService","UserService","ConfigService","SharedEmployeeService","AvailabilityService","ContactServiceFactory","EnvConfigService","MultipleViewsManager",function(e,o,t,n,i,a,l,r,s,c,m,d,p,g,h,u,y){function f(o,t){w.getEmployee($).then(function(n){null!=n&&u.getEnvConfig().then(function(i){"0"==i.privatetabemp&&(delete n.street,delete n.house_number,delete n.country,delete n.city,delete n.postal_code,delete n.phone_personal,delete n.mobile_personal),o.pageTitle=n.name,o.employee=n,n.street&&(o.googleMapsLink="https://maps.google.com/?q="+encodeURIComponent(n.street)+"%20"+encodeURIComponent(n.house_number)+",%20"+encodeURIComponent(n.city)+",%20"+encodeURIComponent(n.country),o.googleMapsLink=o.googleMapsLink.replace("'","%27").replace('"',"%22"),e.googleMapsLink=o.googleMapsLink,o.googleMapsImage="https://maps.googleapis.com/maps/api/staticmap?key="+encodeURIComponent(t.googlemapikey)+"&markers="+encodeURIComponent(n.street)+"%20"+encodeURIComponent(n.house_number)+",%20"+encodeURIComponent(n.city)+",%20"+encodeURIComponent(n.country)+"&size=400x200",o.googleMapsImage=o.googleMapsImage.replace("'","%27").replace('"',"%22"),e.googleMapsImage=o.googleMapsImage),n.image_id&&c.getImageData(n.image_id,1).then(function(e){o.employee.imageUrl=e.url,c.getImageData(n.image_id,2).then(function(e){o.employee.imageUrl=e.url})}),d.getConfig().then(function(e){if(-1!=e.modules.indexOf(10)){var t=new Date;t.setDate(1),t.setMonth(t.getMonth()-1),t.setHours(0),t.setMinutes(0),t.setSeconds(0),o.calendars=[];for(var n=-1;11>n;n++)t.setMonth(t.getMonth()+1),o.calendars.push(v(t));o.getAvailability().then(function(e){for(var t=0;t<o.calendars.length;t++)for(var n=o.calendars[t],i=0;i<n.length;i++){var a=getJSONDate(n[i].date,!1,!0);"undefined"!=typeof e.Days[a]&&Object.keys(e.Days[a].empdeptable).forEach(function(o){var t=e.Days[a].empdeptable[o];Object.keys(t).forEach(function(e){n[i].hours=t[e].Blocks[0].Hours,n[i].LineType=t[e].Blocks[0].Type})})}})}})})})}function v(e){var o,t=new Date(e);t.setDate(1);var n,i=new Date(t.getFullYear(),t.getMonth()+1,0),a=[],l=new Date(t),r=new Date;for(o=0;o<i.getDate();o++)l.setDate(t.getDate()+o),n=6==l.getDay()||0==l.getDay()?"calColorWeekend":"",r.getFullYear()==l.getFullYear()&&r.getMonth()==l.getMonth()&&r.getDate()==l.getDate()&&(n+=" calToday"),a.push({date:new Date(l),color:n,LineType:""});if(1!=a[0].date.getDay()){var s=a[0].date.getDay();for(0==s&&(s=7),o=0;s-1>o;o++){var c=new Date(a[0].date);c.setDate(a[0].date.getDate()-1),n="calColorOtherMonth",(6==c.getDay()||0==c.getDay())&&(n+=" calColorWeekend"),a.unshift({date:new Date(c),color:n,LineType:"othercalendar"})}}if(0!=a[a.length-1].date.getDay()){var m=a[a.length-1].date.getDay();for(o=0;7-m>o;o++){var d=new Date(a[a.length-1].date);d.setDate(a[a.length-1].date.getDate()+1),n="calColorOtherMonth",(6==d.getDay()||0==d.getDay())&&(n+=" calColorWeekend"),a.push({date:new Date(d),color:n,LineType:"othercalendar"})}}return a}var S=h.getInstance(),w=p.getEmployeeService(),$=t.id;e.formData=[],e.formData.query="",y.isActive()?"menu.split-employees.employees"==o.$current.name?e.pageTitle=atrans("whoiswho","Wie is wie"):w.getTeam(o.params.id).then(function(o){e.pageTitle=o.team_description}):e.pageTitle=atrans("employee","Medewerker"),e.titleGeneral=atrans("general","Algemeen"),e.titleAvailability=atrans("availability","Bezetting"),e.activeIndex=0,l.fromTemplateUrl("popoverOptions.html",{scope:e}).then(function(o){e.popover=o}),e.openPopover=function(o){e.popover.show(o)},e.closePopover=function(){e.popover.hide()},e.$on("$destroy",function(){e.popover.remove()}),e.$on("$ionicSlides.sliderInitialized",function(o,t){e.empslider=t.slider}),e.$on("$ionicSlides.slideChangeStart",function(e,o){n(function(){a.$getByHandle("tabsemployee").select(o.slider.activeIndex)},1)}),y.isActive()&&(e.showplaceholder=!0),y.updated("employees-detail",function(e){$=e.employeeId;var o=y.getScope();o.showplaceholder=!1,d.getConfig().then(function(e){f(o,e)})}),e.$on("$ionicView.unloaded",function(){e.empslider=void 0}),e.gotoNotificationUser=function(){e.popover.hide();var t={};e.employee&&(t.EmployeeId=e.employee.employee_id,t.Id=t.EmployeeId,t.DisplayId="("+t.Id+")",t.Name=e.employee.name,t.ImageId=e.employee.image_id,t.image=e.employee.image,o.go("menu.messageboard",{sender:t},{reload:!0}))},e.$on("$ionicView.beforeEnter",function(){y.setScope(e),e.showallhours=!1,e.optionsMenu=[{text:atrans("showallhours","Toon alle uren"),checked:!1},{text:atrans("showabsence","Toon afwezigheid"),checked:!0},{text:atrans("shownoschedule","Toon roostervrij"),checked:!0}],d.getConfig().then(function(o){e.mayshowbd=-1!=o.modules.indexOf(18),-1==o.modules.indexOf(11)?e.gotoPage("menu.home"):y.isActive()||($&&f(e,o),e.empslider&&n(function(){e.empslider&&e.empslider.onResize(!0)},400))})}),e.getAvailability=function(){var o=new Date;o.setDate(1),o.setMonth(o.getMonth()-1),o.setHours(0),o.setMinutes(0),o.setSeconds(0),o.setMilliseconds(0);var t=new Date(o.getFullYear()+1,o.getMonth()+1,7);return g.getAvailabilityCalendar(o,t,e.employee.employee_id).then(function(e){return e})},e.show=function(o){if(e.empslider)switch(e.activeIndex=o,n(function(){e.empslider.slideTo(o)},10),e.activeIndex){case 0:r.$getByHandle("mainContent").scrollTop();break;case 1:"undefined"==typeof e.monthPos&&(e.monthPos=s.position(angular.element(document.getElementById("month1")))),r.$getByHandle("calendarScroll").scrollTo(0,e.monthPos.top-10,!1)}},e.saveContact=function(){e.popover.hide();var o={name:e.employee.name,first_name:e.employee.first_name,middle_name:e.employee.prefix,last_name:e.employee.last_name,nickname:e.employee.calling_name,phone_work:e.employee.phone_work,phone_personal:e.employee.phone_personal,mobile_work:e.employee.mobile_work,mobile_personal:e.employee.mobile_personal,email_work:e.employee.email_work,email_personal:e.employee.email_personal,street:e.employee.street,city:e.employee.city,postal_code:e.employee.zipcode,house_number:e.employee.house_number,country:e.employee.country,prefix:e.employee.prefix};S.saveContact(o)},e.sendSubject=function(){e.popover.hide(),e.gotoPage("menu.newsubjects",{fillInData:{S_Em:{id:e.employee.employee_id,name:e.employee.name}}})}}]);