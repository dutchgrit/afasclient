angular.module("timesheets.controller",[]).factory("SharedTimesheetService",["TimesheetServiceFactory",function(e){var t=e.getInstance();return{getTimesheetService:function(){return t}}}]).factory("SharedAbsenceService",["AbsenceServiceFactory",function(e){var t=e.getInstance();return{getAbsenceService:function(){return t}}}]).controller("TimesheetsWeekController",["$scope","$state","$timeout","$stateParams","$ionicPopover","SharedTimesheetService","DatePickerService",function(e,t,i,r,o,s,n){function a(t){var r,o,s=t?e.slider.activeIndex:0,n=1;for(t||(n=-1,e.slider.lockSwipes()),r=new Date(e.slides[s].date),o=0;h>o;o++)r.setDate(r.getDate()+7*n),t?e.slides.push(d(r)):e.slides.unshift(d(r));t||i(function(){e.slider.unlockSwipes(),e.slider.slideTo(h,0,!0)},10)}function l(){r.selection||(r.selection={}),r.selection.date||(r.selection.date=new Date),e.currentDate=r.selection.date;var t=new Date(r.selection.date);t.setDate(t.getDate()-(t.getDay()-1)),t.setDate(t.getDate()-7*(h+1));for(var i=[],o=0;2*h>=o;o++)t.setDate(t.getDate()+7),i.push(d(t));i[h].week=atrans("week","week")+" "+i[h].date.getWeek()+" "+i[h].date.getTimesheetYear()+" ("+atrans("thisweek","deze week")+")",e.slides=i,c(e.slides[h].date,!0),u.loadEntryLayouts(e,!1)["finally"](function(){e.sel&&e.sel.selectedLayout?e.mayShowOptions=e.sel.selectedLayout.info.actions.length>0:e.mayShowOptions=!1})}function d(e){var t=new Date(e);return{date:t,loaded:!1,forceRefresh:!1,week:atrans("week","week")+" "+t.getWeek()+" "+t.getTimesheetYear()}}function c(t,i){for(var r=new Date(t),o=0,s=0;s<e.slides.length;s++)e.slides[s].date.equals(r)&&(o=s);var n=new Date(e.slides[o].date),a=new Date(n);a.setDate(n.getDate()+6),e.slides[o].forceRefresh&&(e.refreshing=!0,e.slides[o].forceRefresh=!1),u.getTimesheets(n,a).then(function(t){for(var s,a=[],l=0;l<e.slides.length;l++)if(e.slides[l].date.equals(r)){for(s=0;7>s;s++){var d=new Date(n);d.setDate(d.getDate()+s),a.push({hours:f(t,d),date:new Date(d),dateString:getJSONDate(d),day_num:d.getDate(),day:getDayString(s),month:getMonthString(d.getMonth()).substring(0,3).toUpperCase()})}e.slides[l].days=a,e.slides[l].total=m(a),e.slides[l].loaded=!0,e.refreshing=!1;break}var c=new Date,u=new Date;if(e.slides[o]&&e.slides[o].date.getWeek()==c.getWeek()&&e.slides[o].date.getTimesheetYear()==c.getTimesheetYear())for(e.slides[o].week=atrans("week","week")+" "+e.slides[o].date.getWeek()+" "+e.slides[o].date.getTimesheetYear()+" ("+atrans("thisweek","deze week")+")",s=0;s<e.slides[o].days.length;s++)u=e.slides[o].days[s].date,u.getDate()==c.getDate()&&(e.slides[o].days[s].highlight=!0);if(void 0!=i&&i)try{e.showSlidebox=!0}catch(h){}})["finally"](function(){e.$broadcast("scroll.refreshComplete")})}function f(e,t){var i=0;if(e)for(var r=0;r<e.length;r++)if("6"!=e[r].type){var o=fromGMTDate(new Date(Date.parse(e[r].date)));o.getDate()==t.getDate()&&(i+=e[r].quantity)}return i}function m(e){for(var t=0,i=0;i<e.length;i++)t+=e[i].hours;return t}var u=s.getTimesheetService(),h=2;e.showSlidebox=!1,e.refreshing=!1,e.pageTitle=atrans("weekoverview","Weekoverzicht"),e.showPager=!0,e.sel={},e.refreshText=atrans("refreshtext","Laat los om te verversen"),e.sliderWeek={effect:"slide",initialSlide:h,resistanceRatio:0,paginationHide:!1,runCallbacksOnInit:!1},e.$on("$ionicSlides.sliderInitialized",function(t,i){e.slider=i.slider,e.checkClosed(!0)}),e.$on("$ionicSlides.slideChangeStart",function(t,i){e.slides[i.slider.activeIndex].loaded&&!e.slides[i.slider.activeIndex].forceRefresh||i.slider.isBeginning||c(e.slides[i.slider.activeIndex].date),i.slider.isEnd?a(!0):i.slider.isBeginning&&a(!1),e.checkClosed()}),e.checkClosed=function(t){if(e.slides&&e.slider&&e.slides[e.slider.activeIndex]&&e.sel&&e.sel.selectedLayout){var i=!1;u.checkClosed(e,getJSONDate(e.slides[e.slider.activeIndex].date,!0),t).then(function(e){e&&(i=e.closed)})["finally"](function(){e.locked=i})}},e.$on("$ionicView.enter",function(){e.slides&&0!=e.slides.length||l(),e.slides[e.slider.activeIndex].forceRefresh&&(c(e.slides[e.slider.activeIndex].date,!1),e.checkClosed(!0))}),e.$on("$ionicView.leave",function(){if(e.slides)for(var t=0;t<e.slides.length;t++)e.slides[t].loaded&&(e.slides[t].forceRefresh=!0)}),o.fromTemplateUrl("popoverOptions.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.executeAction=function(t){e.slides&&e.slides[e.slider.activeIndex]&&u.executeAction(e,getJSONDate(e.slides[e.slider.activeIndex].date),t).then(function(){e.checkClosed(!0),"CloseDecl"==t.id&&e.gotoPage("menu.flexdeclarations"),c(e.slides[e.slider.activeIndex].date,!0)})},e.refreshWeek=function(){e.checkClosed(!0),c(e.slides[e.slider.activeIndex].date,!0)},e.goToDay=function(i){t.go("menu.timesheetsday",{selection:{date:i.date,locked:e.locked}},{reload:!1})},e.goTo=function(t){"next"==t&&e.slider.slideNext(!0),"previous"==t&&e.slider.slidePrev(!0)},e.pickWeek=function(){n.pickDate(e.slides[e.slider.activeIndex].date).then(function(e){r.selection.date=e,l()})},l()}]).controller("TimesheetsDayController",["$scope","$timeout","$state","$stateParams","$ionicPopover","SharedTimesheetService","question","DatePickerService","UserService","SharedAbsenceService",function(e,t,i,r,o,s,n,a,l,d){function c(){r.selection||(r.selection={}),r.selection.date||(r.selection.date=new Date),h.loadEntryLayouts(e,!0)["finally"](function(){e.sel&&e.sel.selectedLayout?(e.checkClosed(),e.maySelectLayout=e.sel.entryLayouts&&e.sel.entryLayouts.length>1,e.canBookCosts=e.sel.selectedLayout.info.settingFields.Cost.value,e.mayShowOptions=e.maySelectLayout||e.sel.selectedLayout.info.actions.length>0):e.mayShowOptions=!1});var t=dateFromStateParams(r.selection.date.yyyymmdd());t.setDate(t.getDate()-y-1);for(var i=[],o=0;2*y>=o;o++)t.setDate(t.getDate()+1),i.push(m(t));e.slides=i,u(e.slides[y].date,!0)}function f(i){var r,o,s=i?e.slider.activeIndex:0,n=1;for(i||(n=-1,e.slider.lockSwipes()),r=new Date(e.slides[s].date),o=0;y>o;o++)r.setDate(r.getDate()+n),i?e.slides.push(m(r)):e.slides.unshift(m(r));i||t(function(){e.slider.unlockSwipes(),e.slider.slideTo(y,0,!0)},10)}function m(e){var t=formatDate(e),i=new Date;return e.getDate()==i.getDate()&&e.getMonth()==i.getMonth()&&e.getFullYear()==i.getFullYear()&&(t+=" ("+atrans("today","vandaag")+")"),{loaded:!1,forceRefresh:!1,date_txt:t,date:new Date(e)}}function u(t,i){l.getUser().then(function(e){p.getTimetable(getJSONDate(t,!0)+"T00H00",e.employement_id),p.getSchedule(e.dvb)}),e.currentDate=t;for(var r=0,o=0;o<e.slides.length;o++)e.slides[o].date==t&&(r=o);e.slides[r].forceRefresh&&(e.refreshing=!0,e.slides[r].forceRefresh=!1),void 0!=i&&i&&(e.showSlidebox=!0,e.slider&&e.slider.slideTo(r,0,!1)),h.getTimesheets(t,t).then(function(t){if(t){var o=[],s=[];for(n=0;n<t.length;n++)switch(t[n].type){case"1":o.push(t[n]);break;case"6":s.push(t[n])}var n,a=0;for(n=0;n<s.length;n++)a+=s[n].quantity*s[n].unit_price;if("undefined"!=typeof e.slides[r].timesheets_costs){for(n=0;n<e.slides[r].timesheets_costs.length;n++)if(e.slides[r].timesheets_costs[n].showed)for(var l=0;l<s.length;l++)if(e.slides[r].timesheets_costs[n].guid==s[l].guid){for(var d in s[l])s[l].hasOwnProperty(d)&&(e.slides[r].timesheets_costs[n][d]=s[l][d]);s.splice(l,1);break}for(n=s.length-1;n>=0;n--)e.slides[r].timesheets_costs.unshift(s[n])}else e.slides[r].timesheets_costs=s;e.slides[r].total_costs=a;var c=0;for(n=0;n<o.length;n++)c+=o[n].quantity;if("undefined"!=typeof e.slides[r].timesheets_hours){for(n=0;n<e.slides[r].timesheets_hours.length;n++)if(e.slides[r].timesheets_hours[n].showed)for(var l=0;l<o.length;l++)if(e.slides[r].timesheets_hours[n].guid==o[l].guid){for(var d in o[l])o[l].hasOwnProperty(d)&&(e.slides[r].timesheets_hours[n][d]=o[l][d]);o.splice(l,1);break}for(n=o.length-1;n>=0;n--)e.slides[r].timesheets_hours.unshift(o[n])}else e.slides[r].timesheets_hours=o;for(e.slides[r].total_hours=c,e.refreshing=!1,n=0;n<e.slides[r].timesheets_costs.length;n++)e.slides[r].timesheets_costs[n].showed=!0;for(n=0;n<e.slides[r].timesheets_hours.length;n++)e.slides[r].timesheets_hours[n].showed=!0;void 0!=i&&i&&(e.showSlidebox=!0,e.slider.slideTo(r,0,!1))}})["finally"](function(){e.$broadcast("scroll.refreshComplete"),e.slides[r].loaded=!0})}var h=s.getTimesheetService(),p=d.getAbsenceService(),y=3;e.refreshText=atrans("refreshtext","Laat los om te verversen"),e.sliderDays={effect:"slide",initialSlide:y,resistanceRatio:0,paginationHide:!0,runCallbacksOnInit:!1},e.pageTitle=atrans("dayoverview","Dagoverzicht"),e.$on("$ionicSlides.sliderInitialized",function(t,i){e.slider=i.slider,e.checkClosed()}),e.$on("$ionicSlides.slideChangeStart",function(t,i){e.currentDate=e.slides[i.slider.activeIndex].date,0!=e.slides[i.slider.activeIndex].loaded&&!e.slides[i.slider.activeIndex].forceRefresh||i.slider.isBeginning||u(e.slides[i.slider.activeIndex].date),i.slider.isEnd?f(!0):i.slider.isBeginning&&f(!1),e.checkClosed()}),e.refreshTimesheets=function(){u(e.currentDate)},e.goToTimesheet=function(e){i.go("menu.timesheetdetail",{guid:e},{reload:!0})},o.fromTemplateUrl("popoverOptions.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.executeAction=function(t){e.slides&&e.slides[e.slider.activeIndex]&&h.executeAction(e,getJSONDate(e.slides[e.slider.activeIndex].date),t).then(function(){e.checkClosed(!0),"CloseDecl"==t.id&&e.gotoPage("menu.flexdeclarations")})},e.checkClosed=function(t){if(e.slides&&e.slider&&e.slides[e.slider.activeIndex]&&e.sel&&e.sel.selectedLayout){var i=!1;h.checkClosed(e,getJSONDate(e.slides[e.slider.activeIndex].date,!0),t).then(function(e){e&&(i=e.closed)})["finally"](function(){e.locked=i})}},e.$on("$ionicView.enter",function(){e.slides&&e.slides[e.slider.activeIndex].forceRefresh&&u(e.slides[e.slider.activeIndex].date,!1)}),e.selectLayout=function(){h.loadEntryLayouts(e,!0,!0)["finally"](function(){e.sel&&e.sel.selectedLayout?(e.maySelectLayout=e.sel.entryLayouts.length>0,e.canBookCosts=e.sel.selectedLayout.info.settingFields.Cost.value,e.mayShowOptions=e.maySelectLayout||e.sel.selectedLayout.info.actions.length>0):e.mayShowOptions=!1})},e.newTimesheet=function(t){var r={type:t,date:e.currentDate,sel:e.sel};i.go("menu.timesheetswizard",{selection:r},{reload:!1})},c(),e.$on("$ionicView.leave",function(){if(e.slides)for(var t=0;t<e.slides.length;t++)e.slides[t].loaded&&(e.slides[t].forceRefresh=!0)}),e.editTimesheet=function(t){var r={type:t.type,date:fromGMTDate(parseDateString(t.date)),rowid:t.guid,sel:e.sel};i.go("menu.timesheetswizard",{selection:r},{reload:!1})},e.removeTimesheet=function(i){n(atrans("deletetext","Weet je zeker dat je de nacalculatieregel wilt verwijderen?")).then(function(r){if(r){var o=new Date(Date.parse(i.date)),s=getJSONDate(o).replace(/:/g,".");h.remove(i.guid,s).then(function(r){"6"!=i.type?e.slides[e.slider.activeIndex].timesheets_hours.splice(e.slides[e.slider.activeIndex].timesheets_hours.indexOf(i),1):e.slides[e.slider.activeIndex].timesheets_costs.splice(e.slides[e.slider.activeIndex].timesheets_costs.indexOf(i),1),t(function(){u(e.slides[e.slider.activeIndex].date)},500)})}})},e.goTo=function(t){"next"==t&&e.slider.slideNext(!0),"previous"==t&&e.slider.slidePrev(!0),e.wizard&&e.slider.lockSwipes()},e.pickDay=function(){a.pickDate(e.slides[e.slider.activeIndex].date).then(function(e){r.selection.date=e,c()})}}]).controller("TimesheetsWizardController",["$scope","$timeout","$state","$ionicSlideBoxDelegate","$ionicScrollDelegate","$ionicPopover","$stateParams","UserService","ConfigService","EnvConfigService","ModalSearchService","DatePickerService","SearchService","SharedTimesheetService","SharedAbsenceService","LongOperationService","ConnectorService","question","maxListTake",function(e,t,i,r,o,s,n,a,l,d,c,f,m,u,h,p,y,g,T){function v(){e.sel&&1!=e.sel.type||(e.form.time=8,e.normalhours=8,d.getEnvConfig().then(function(t){var i=(e.currentDate.getDay()+6)%7;"undefined"!=typeof t.timesheetconfig[i].Hours&&(e.form.time=parseFloat(t.timesheetconfig[i].Hours.replace(",",".")),e.normalhours=e.form.time),e.currentDayTotal&&(e.form.time-=e.currentDayTotal),e.form.time<0&&(e.form.time=0),e.projectsactive="0"!=t.projectsactive,(null==e.form.activity||null==e.form.itemtype)&&l.getConfig().then(function(r){if(isVersionOrHigher(r,"Profit4")&&(e.hasItemTypes=!0,null!=t&&"undefined"!=typeof t.timesheetconfig)){var o=t.timesheetconfig[i].HoursNormal;e.sel&&e.sel.selectedLayout||(null==o||""==o)&&(o="1"),null!=o&&""!=o&&w.validateEntry(o,"itemtype",e.getCurrentValues()).then(function(t){for(var i=0;i<t.length;i++)if(t[i].timetype==o)return e.defaultItemType=t[i],void e.selectItemType(t[i],!1);e.defaultItemType=t[0],e.selectItemType(t[0],!1)})}e.showinternextern="1"==r.showinternextern}),e.sel&&e.sel.selectedLayout?(e.startTimeFieldsSpinning(),I.getTimetable(getJSONDate(e.currentDate,!0)+"T00H00",e.user.employement_id).then(function(t){if(t&&t.length>0){var i=0==e.sel.selectedLayout.info.settingFields.Type.value;i&&(e.form.time=t[0].hours-e.currentDayTotal,e.form.TimeSpan=Math.max(0,60*e.form.time)),e.showTime()}else e.startTimeFieldsSpinning(),I.getSchedule(e.user.dvb).then(function(t){t&&t.length>0&&(t[0].days_per_week>0?e.hoursPerDay=t[0].hours_per_week/t[0].days_per_week:e.user.isflexemployee?(e.hoursPerDay=8,e.hasZeroHours=!0):e.hoursPerDay=e.normalhours,e.form.TimeSpan=Math.max(0,60*(e.hoursPerDay-e.currentDayTotal)),e.form.TimeSpan=rearound(e.form.TimeSpan),e.form.time=e.form.TimeSpan/60)})["finally"](function(){e.showTime(),e.endTimeFieldsSpinning()})},function(){e.showTime()})["finally"](function(){e.endTimeFieldsSpinning()})):e.showTime()}))}function S(){var t=!0;return e.error=[],(void 0==e.form.time||0==e.form.time)&&(e.error[0]=atrans("nohoursspecified","Geef het aantal uren op"),t=!1),e.form.time+e.currentDayTotal>24&&(e.error[0]=atrans("toomanyhoursspecified","De waarde mag niet boven 24 zijn"),t=!1),e.form.time<0&&(e.error[0]=atrans("negativehhoursspecified","De waarde mag niet onder 0 zijn."),t=!1),void 0==e.form.activity&&(e.error[1]=atrans("noactivityspecified","Geef een werksoort op"),t=!1),t&&(e.error=!1),t}var w=u.getTimesheetService(),I=h.getAbsenceService(),D=null,P={TimesheetService:w,fields:{}},_=!1;e.projectsactive=!0,e.showinternextern=!1,e.timetables={},e.hoursPerDay=8,e.sel={},e.descriptionPlaceholder=atrans("enterdescriptionhere","Vul hier je omschrijving in"),e.projectPlaceholder=atrans("enterprojectcodehere","Vul hier een projectcode in"),e.projectStagePlaceholder=atrans("enterprojectstagecodehere","Vul hier een projectfase code in"),e.activityPlaceholder=atrans("enteractivitycodehere","Vul hier een werksoortcode in"),e.itemtypePlaceholder=atrans("enteritemtypecodehere","Vul hier een urensoortcode in"),e.layoutVisible=function(t){return e.sel&&e.sel.selectedLayout&&e.sel.selectedLayout.info["layoutFields_"+e.sel.type]&&-1!=e.sel.selectedLayout.info["layoutFields_"+e.sel.type].indexOf(t)},e.startTimeFieldsSpinning=function(){p.startN("field_TimeSpan"),p.startN("field_StTi"),p.startN("field_EnTi"),p.startN("field_PaTi")},e.endTimeFieldsSpinning=function(){p.endN("field_TimeSpan"),p.endN("field_StTi"),p.endN("field_EnTi"),p.endN("field_PaTi")},e.showLayout=function(t,i){if(e.sel&&e.sel.selectedLayout){if(e.sel.selectedLayout.info.detailFields.KnSbjFiId&&e.sel.selectedLayout.info.detailFields.KnSbjFiId.enabled&&e.sel.selectedLayout.info.detailFields.KnSbjFiId.visible&&(e.sel.selectedLayout.info.detailFields.KnSbjFiId.showInFields=!0,e.sel.selectedLayout.info.detailFields.KnSbjFiId.multiFile=!1),resetdefaults(e.sel.selectedLayout.info.detailFields),!n.selection.rowid){var r=e.sel.selectedLayout.info["fieldSetting_"+e.sel.type];for(var o in r)if(r.hasOwnProperty(o)&&"eob"!=o&&r[o]){var s=e.sel.selectedLayout.info.detailFields[o];s&&(s.old||(s.old={defaultvalue:s.defaultvalue,value:s.value,enabled:s.enabled,mandatory:s.mandatory,visible:s.visible}),r[o]["default"]&&(s.defaultvalue=replaceFieldVariable(r[o]["default"],i),s.value=""),r[o].disabled?s.enabled=!1:s.enabled=s.old.enabled,r[o].mandatory?s.mandatory=!0:s.mandatory=s.old.mandatory,r[o].hideField?s.visible=!1:s.visible=s.old.visible)}}e.sel.selectedLayout.info.detailFields.BiId&&(1==e.sel.type?e.sel.selectedLayout.info.detailFields.BiId.label=atrans("activity","Werksoort"):e.sel.selectedLayout.info.detailFields.BiId.label=atrans("itemcode","Item code"));for(var o in e.sel.selectedLayout.info.labels)e.sel.selectedLayout.info.labels.hasOwnProperty(o)&&"eob"!=o&&(e.sel.selectedLayout.info.detailFields[o].label=e.sel.selectedLayout.info.labels[o]);if(e.layoutVisible("PcId")&&e.sel.selectedLayout.info.detailFields.PcId&&(e.sel.selectedLayout.info.detailFields.PcId.description=null),delete e.sel.selectedLayout.info.detailFields.VaIt,parseInfo(e,e.sel.selectedLayout.info.detailFields,i,!1,"validateEntry2",n.selection.rowid),e.form.VaIt={id:e.sel.type},n.selection.rowid)e.form.Id=n.selection.rowid,1==e.sel.type&&(e.form.TimeSpan=60*e.sel.selectedLayout.info.detailFields.QuUn.value),e.form.DaTi=getGMTDate(t),e.form.PrId&&(e.hasStages=null!=e.form.PrSt_entry,e.form.project={project_id:e.form.PrId.id,project_name:e.form.PrId.description}),e.screenview();else{var a=["EmId"];if(n.selection&&n.selection.defaultFields)for(var l in n.selection.defaultFields)if(n.selection.defaultFields.hasOwnProperty(l)){var d=n.selection.defaultFields[l],c=e.sel.selectedLayout.info.detailFields[l];c&&(issearchfield(c.ctype)?(-1==a.indexOf(l)&&a.push(l),e.form[l]={id:d.value,name:d.description,idext:d.extvalue},e.form[l+"_entry"]=d.extvalue||d.value):e.form[l]=d.value)}e.form.DaTi=getGMTDate(t),e.form.TimeSpan=480,e.screenview(),w.checkTriggerFields(a,e)}}},e.changeWizardScreen=function(t){e.wizard&&t>=0&&t<e.wizard.screens.length&&(e.wizard.currentScreen=t,e.checkWizardField(),o.$getByHandle("main").scrollTop(!0),o.$getByHandle("wizardmain").scrollTop(!0))},e.loadScreen=function(){e.form={},e.form.project={},e.triggersBusy=0,e.form.attachments=[],e.form.errorfld={},e.form.screenview=e.screenview,n.selection||(n.selection={}),n.selection.date||n.selection.rowid||(n.selection.date=new Date),n.selection.type||(n.selection.type=1),e.currentDate=n.selection.date,e.sel=n.selection.sel,e.info=null,w.loadEntryLayouts(e,!0,!1,n.selection.rowid)["finally"](function(){e.sel&&(e.sel.type=n.selection.type,e.sel.selectedLayout?(e.info=e.sel.selectedLayout.info,e.checkType(),n.selection.rowid&&(e.info.detailFields.DaTi&&(e.info.detailFields.DaTi.value?n.selection.date=fromGMTDate(parseDateString(e.info.detailFields.DaTi.value)):n.selection.date=null),e.info.detailFields.KnSbjFiId&&e.info.detailFields.KnSbjFiId.value&&e.info.detailFields.KnSbjFiId.description&&y.getFileData(e.info.detailFields.KnSbjFiId,"value","description").then(function(t){e.file_attached=!0;var i="data:"+t.mimetype+";base64,"+t.filedata;t.mimetype.startsWith("image/")?e.form.attachments.push({src:i,type:"img",filename:t.filename,fileId:t.guid}):e.form.attachments.push({src:"img/file.png",type:"file",filename:t.filename,fileId:t.guid})}))):e.mayShowOptions=!1),e.loadDay(n.selection.date)}),e.rowid=n.selection.rowid},e.checkType=function(){e.sel&&(e.form.VaIt={id:e.sel.type})},e.selectLayout=function(){w.loadEntryLayouts(e,!0,!0).then(function(){e.previousPage()})},e.checkWizardField=function(){if(e.wizard&&e.wizard.screens&&e.wizard.currentScreen<e.wizard.screens.length&&e.wizard.screens[e.wizard.currentScreen].fields&&e.wizard.currentField<e.wizard.screens[e.wizard.currentScreen].fields.length){var t=e.wizard.screens[e.wizard.currentScreen].fields[e.wizard.currentField];if(e.sel.selectedLayout&&e.sel.selectedLayout.info){var i=e.sel.selectedLayout.info.detailFields[t];i&&i.enabled&&i.visible&&(!isNotEmpty(e.form[t])||14==i.ctype||7==i.ctype)&&issearchfield(i.ctype)&&e.openModalforField(t,!0)}}},s.fromTemplateUrl("popoverOptions.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.$on("$ionicView.beforeEnter",function(){e.alreadyLoaded||(e.alreadyLoaded=!0,e.loadScreen())}),e.wizardGoPrevious=function(){e.wizard.currentScreen--,e.wizard.currentField=0},e.wizardGoNextField=function(){e.wizard.currentField<e.wizard.screens[e.wizard.currentScreen].fields.length-1?(e.wizard.currentField++,e.checkWizardField()):e.wizardGoNext()},e.wizardGoNext=function(){e.wizard.currentScreen++,e.wizard.currentField=0},e.screenview=function(t,i){t&&"DaTi"==t&&e.form.DaTi&&e.currentDate.valueOf()!=e.form.DaTi.valueOf()&&(e.currentDate=e.form.DaTi,e.lastEnTi=null,e.startTimeFieldsSpinning(),w.getTimesheets(e.currentDate,e.currentDate).then(function(t){if(t){var i,r=0,o=0;for(i=0;i<t.length;i++)"6"!=t[i].type&&(o+=t[i].quantity,t[i].end_time&&r<toTimeValue(t[i].end_time)&&(r=toTimeValue(t[i].end_time),e.lastEnTi=t[i].end_time));e.currentDayTotal=o,v(),e.form.StTi=null,e.form.EnTi=null,e.checkClosed(),e.screenview(),e.pageTitle=formatDate(e.currentDate)}})["finally"](function(){e.endTimeFieldsSpinning()})),t&&"AmPy"==t&&"DU"==e.sel.selectedLayout.flexcomptype&&e.checkTriggerField("AmPy"),a.getUser().then(function(r){function o(t){if(t&&t.length>0){var i=60*fromSecondsToReaAmount(toTimeValue(timeToDate(t[0].end_time))-toTimeValue(timeToDate(t[0].start_time))-toTimeValue(timeToDate(t[0]["break"])));if(null==e.lastEnTi)e.layoutVisible("PaTi")?(e.form.PaTi=timeToDate(t[0]["break"]),e.form.EnTi=timeToDate(t[0].end_time),e.form.TimeSpan=60*t[0].hours):(e.form.EnTi=null,e.form.PaTi=null,e.form.TimeSpan=0),e.form.StTi=timeToDate(t[0].start_time);else{e.layoutVisible("PaTi")?e.form.PaTi=timeToDate("00:00"):e.form.PaTi=null,e.lastEnTi?e.form.StTi=timeToDate(e.lastEnTi):e.form.StTi=timeToDate(t[0].start_time),e.form.EnTi=new Date(e.form.StTi.getTime()+6e4*Math.max(0,i-60*e.currentDayTotal));var r=toTimeValue(e.form.EnTi);86340==r&&(r=86400),e.form.TimeSpan=Math.max(0,60*fromSecondsToReaAmount(r-toTimeValue(e.form.StTi)))}}else if(e.user.isflexemployee&&e.hasZeroHours){e.layoutVisible("PaTi")?(e.form.PaTi=timeToDate("00:30"),e.lastEnTi?e.form.StTi=timeToDate(e.lastEnTi):e.form.StTi=timeToDate("08:30"),e.form.EnTi=timeToDate("17:00")):(e.form.PaTi=null,e.lastEnTi?e.form.StTi=timeToDate(e.lastEnTi):e.form.StTi=timeToDate("09:00"),e.form.EnTi=timeToDate("17:00"));var r=toTimeValue(e.form.EnTi);86340==r&&(r=86400),e.form.TimeSpan=Math.max(0,60*fromSecondsToReaAmount(r-toTimeValue(e.form.StTi)-(null==e.form.PaTi?0:toTimeValue(e.form.PaTi))))}else if(e.layoutVisible("PaTi")?e.form.PaTi=timeToDate("00:00"):e.form.PaTi=null,e.lastEnTi&&(e.form.StTi=timeToDate(e.lastEnTi)),e.form.StTi&&(e.form.EnTi=new Date(e.form.StTi.getTime()+36e5*Math.max(0,e.hoursPerDay-e.currentDayTotal)),e.form.EnTi.setMinutes(rearound(e.form.EnTi.getMinutes()))),e.form.EnTi&&e.form.StTi){var r=toTimeValue(e.form.EnTi);86340==r&&(r=86400),e.form.TimeSpan=Math.max(0,60*fromSecondsToReaAmount(r-toTimeValue(e.form.StTi))),e.form.TimeSpan=rearound(e.form.TimeSpan)}else e.form.TimeSpan=60*e.hoursPerDay,e.form.TimeSpan=rearound(e.form.TimeSpan);e.form.StTi&&(e.lastStTiValue=toTimeValue(e.form.StTi)),e.form.EnTi&&(e.lastEnTiValue=toTimeValue(e.form.EnTi)),e.form.QuUn=e.form.TimeSpan/60,d.Qu&&(e.form.Qu=e.form.QuUn),d.QuSa&&!e.layoutVisible("QuSa")&&(e.form.QuSa=e.form.QuUn)}function s(t,i,r,o){var s=e.sel.selectedLayout.info.detailFields;s[t]&&(s[t].visible=i,i?s[t].enabled=!0:(o&&(e.form[t]=null,e.form[t+"_entry"]=""),s[t].enabled=!1),r?s[t].mandatory=!0:s[t].mandatory=!1)}e.user=r;var a=6==e.sel.type,l=1==e.sel.selectedLayout.info.settingFields.Type.value,d=e.sel.selectedLayout.info.detailFields;if(s("TimeSpan",!a,!a,!0),s("TimeSpanEntry",!1,!1,!0),s("TimeEntryTo",!1,!1,!0),s("TimeEntryFrom",!1,!1,!0),e.EmIdBySelection=!1,e.sel.selectedLayout.info.detailFields.EmId&&(n.selection.defaultFields&&n.selection.defaultFields.EmId?e.EmIdBySelection=n.selection.defaultFields.EmId.value!=e.user.employee_id:e.EmIdBySelection=d.EmId.enabled),s("StTi",!a&&l,!a&&l,!0),s("EnTi",!a&&l,!a&&l,!0),s("PaTi",e.layoutVisible("PaTi")&&!a&&l,e.layoutVisible("PaTi")&&!a&&l,!1),s("WoTi",!a&&l,!a&&l,!0),s("DiRe",e.form.DiAp,e.form.DiAp,!0),s("DaTi",e.layoutVisible("DaTi"),e.layoutVisible("DaTi"),!1),e.form.PcId&&(!e.form.PtPctPrId||e.form.PrId&&e.form.PrId.id==e.form.PtPctPrId||(e.form.PrId={id:e.form.PtPctPrId},e.validateEntry2(e.form.PtPctPrId,"PrId"),d.PrId.enabled=!1),s("DaTi",!0,!0,!1)),e.form.EnTi&&e.form.EnTi.setSeconds&&e.form.EnTi.setSeconds(0),e.form.PaTi&&e.form.PaTi.setSeconds&&e.form.PaTi.setSeconds(0),e.form.StTi&&e.form.StTi.setSeconds&&e.form.StTi.setSeconds(0),("StTi"==t||"EnTi"==t||"PaTi"==t)&&(e.form.EnTi&&e.form.EnTi.setMinutes&&(0==toTimeValue(e.form.EnTi)?e.form.EnTi=timeToDate("23:59"):86340!=toTimeValue(e.form.EnTi)&&e.form.EnTi.setMinutes(rearound(e.form.EnTi.getMinutes()))),e.form.EnTi&&e.form.StTi&&toTimeValue(e.form.EnTi)<toTimeValue(e.form.StTi)&&(e.form.EnTi=new Date(e.form.StTi)),e.form.PaTi&&e.form.PaTi.setMinutes&&e.form.PaTi.setMinutes(rearound(e.form.PaTi.getMinutes())),e.form.StTi&&e.form.StTi.setMinutes&&e.form.StTi.setMinutes(rearound(e.form.StTi.getMinutes()))),"TimeSpan"==t&&e.form.TimeSpan&&(e.form.TimeSpan=rearound(e.form.TimeSpan)),!a){if(l)if(d.TimeSpan.enabled=!1,!n.selection.rowid&&(null==e.form.StTi||null==e.form.EnTi||e.layoutVisible("PaTi")&&null==e.form.PaTi))!_&&e.currentDate&&(_=!0,e.startTimeFieldsSpinning(),I.getTimetable(getJSONDate(e.currentDate,!0)+"T00H00",e.user.employement_id).then(function(e){o(e)})["finally"](function(){e.endTimeFieldsSpinning(),_=!1}));else if(("StTi"==t||"EnTi"==t||"PaTi"==t)&&e.form.EnTi&&e.form.StTi){e.lastEnTiValue&&"PaTi"!=t&&(null!=e.form.EnTi&&toTimeValue(e.form.EnTi)!=e.lastEnTiValue||toTimeValue(e.form.StTi)!=e.lastStTiValue)&&(e.form.PaTi=timeToDate("00:00"));var c=toTimeValue(e.form.EnTi);86340==c&&(c=86400),e.form.TimeSpan=Math.max(0,60*fromSecondsToReaAmount(c-toTimeValue(e.form.StTi)-(null==e.form.PaTi?0:toTimeValue(e.form.PaTi))))}if(e.layoutVisible("WoTi")){var f=new Date;f.setHours(0,0,0,0),f.setMinutes(e.form.TimeSpan),e.form.WoTi=getGMTDate(f)}e.form.QuUn=e.form.TimeSpan/60,d.Qu&&(e.form.Qu=e.form.QuUn),d.QuSa&&!e.layoutVisible("QuSa")&&(e.form.QuSa=e.form.QuUn)}if(d.PrSt.enabled=null!=e.form.project,d.SaAF&&(e.form.SaAF=Math.floor(100*e.form.QuUn*e.form.AmFc)/100),d.CpAm&&(e.form.CpAm=Math.floor(100*e.form.QuUn*e.form.AmCo)/100),d.Qu&&(d.Qu.enabled=a),d.QuUn.enabled=a,d.AmPy&&(d.AmPy.enabled=!1),i&&e.checkForNextWizardStep(t),e.sel.selectedLayout.flexcomptype){switch(d.QuUn.enabled=!1,d.KnSbjFiId&&(d.KnSbjFiId.mandatory="DU"==e.sel.selectedLayout.flexcomptype),e.sel.selectedLayout.flexcomptype){case"VA":case"LNU":case"TU":case"ST":case"OV":d.QuUn&&(d.QuUn.enabled=!0)}d.AmPy&&(d.AmPy.enabled="DU"==e.sel.selectedLayout.flexcomptype),d.EpFc&&(d.EpFc.enabled=!1),d.AmCo&&(d.AmCo.enabled=!1),d.AmFc&&(d.AmFc.enabled=!1)}setPlaceholder(d)})},e.setupFile=function(t){document.getElementById("fileBrowser").onchange=function(i){e.filePickedGeneric(i,t,e)}},e.addAttachment=function(t){e.showFileActionsGeneric(t,e)},e.showAttachment=function(t){"img"==t.type&&e.showImage(t.src)},e.deleteAttachment=function(t){""!=t.src&&e.file_attached&&g(atrans("deletesubattach","Wil je deze bijlage verwijderen?")).then(function(i){if(i){var r=e.form.attachments.indexOf(t);-1!=r&&e.form.attachments.splice(r,1)}})},e.$on("$ionicView.leave",function(){}),e.loadDay=function(t){function i(t){e.form.time=t.quantity,t.project_id&&(e.form.project_entry=t.project_id,e.form.project={project_id:t.project_id,project_name:t.project_description}),t.projectstage_id&&(e.form.projectstage_entry=t.projectstage_id,e.form.projectstage={projectstage_description:t.projectstage_description}),t.item&&e.validateEntry(t.item,"activity"),e.form.comment=t.description,e.form.commentint=t.description_intern,e.form.commentext=t.description_extern,e.showTime()}e.pageTitle=formatDate(t),null==t?e.previousPage():(e.currentDate=t,e.form.startdate=t,a.getUser().then(function(i){e.user=i,e.selectedLayoutChanged=function(){e.showLayout(t,i)},e.sel&&e.sel.selectedLayout&&(e.checkClosed(),e.showLayout(t,i),n.selection.rowid?e.wizard=null:e.checkWizard(e.sel.selectedLayout.info["wizard_"+e.sel.type]))}),n.selection.rowid?e.sel&&e.sel.selectedLayout||(n.selection.timesheet?i(n.selection.timesheet):w.getSpecificTimesheet(n.selection.rowid).then(function(e){e&&e.length>0&&i(e[0])})):(e.startTimeFieldsSpinning(),w.getTimesheets(t,t).then(function(t){if(t){var i,r=0,o=0;for(e.lastEnTi=null,i=0;i<t.length;i++)"6"!=t[i].type&&(r+=t[i].quantity,t[i].end_time&&o<toTimeValue(t[i].end_time)&&(o=toTimeValue(t[i].end_time),e.lastEnTi=t[i].end_time));e.currentDayTotal=r,e.form.StTi=null,e.form.EnTi=null,v()}})["finally"](function(){e.endTimeFieldsSpinning()})))},e.checkWizard=function(t){if(t){var i={};for(var r in t)t.hasOwnProperty(r)&&"screens"!=r&&(i[r]=t[r]);var o=[];if(t.screens)for(var s=0;s<t.screens.length;s++){var n=t.screens[s],a=!1;a||o.push(n)}o.length>0?(i.screens=o,e.wizard=i,e.pickedFields={},e.wizard.currentScreen=0,e.wizard.currentField=0,e.wizard.fieldSkipped={},e.checkWizardField()):e.wizard=null}else e.wizard=null},e.getNextWizardFieldId=function(){if(e.wizard&&e.wizard.screens&&e.wizard.currentScreen<e.wizard.screens.length){var t=e.wizard.currentScreen+1;if(t<e.wizard.screens.length&&e.wizard.screens[t].fields)return e.wizard.screens[t].fields[0]}},e.getCurrentWizardFieldId=function(){return e.wizard&&e.wizard.screens&&e.wizard.currentScreen<e.wizard.screens.length&&e.wizard.screens[e.wizard.currentScreen].fields?e.wizard.screens[e.wizard.currentScreen].fields[0]:void 0},e.showTime=function(){var t=new Date;t.setMinutes(0);var i=e.form.time+"";if(t.setHours(i.split(".")[0]),null!=i.split(".")[1]){var r=i.split(".")[1];1==r.length&&(r+="0"),r.length>2&&(r=r.slice(0,2)),t.setMinutes(Math.round(r/100*60))}e.form.time=parseFloat((t.getHours()+t.getMinutes()/60).toFixed(2)),e.form.time_show=format_two_digits(t.getHours())+":"+format_two_digits(t.getMinutes()),e.sel&&e.sel.selectedLayout&&(e.form.TimeSpan=60*e.form.time,e.screenview())},e.changeTimeSpanOld=function(t){var i=new Date;i.setMinutes(0);var r=e.form.time+"";if(i.setHours(r.split(".")[0]),null!=r.split(".")[1]){var o=r.split(".")[1];1==o.length&&(o+="0"),i.setMinutes(o/100*60)}f.pickTime(getGMTDate(i)).then(function(i){e.$applyAsync(function(){i=fromGMTDate(i),t||(e.form.time=parseFloat((i.getHours()+i.getMinutes()/60).toFixed(2)),e.form.time_show=format_two_digits(i.getHours())+":"+format_two_digits(i.getMinutes()))})})},e.validateEntryDelayed=function(i,r){D&&t.cancel(D),D=t(function(){D=null,e.validateEntry(i,r)},500)},e.validateEntry=function(t,i){"project"==i?(e.form.projectstage_entry="",e.validProject=!1,e.form.project={},e.validProjectStage=!1,e.form.projectstage={},e.hasStages=!1,e.sel&&e.sel.selectedLayout&&(e.form.PrId=null),t.length>=1&&w.validateEntry(t,i,e.getCurrentValues()).then(function(i){for(var r=0;r<i.length;r++)if(i[r].project_id==t)return void e.selectProject(i[r],!1);e.selectProject(i[0],!1)})):"activity"==i?(e.validActivity=!1,e.form.activity=null,e.sel&&e.sel.selectedLayout&&(e.form.BiId=null),t.length>=1&&w.validateEntry(t,i,e.getCurrentValues()).then(function(i){for(var r=0;r<i.length;r++)if(i[r].id==t)return void e.selectActivity(i[r],!1);e.selectActivity(i[0],!1)})):"itemtype"==i?(e.form.itemtype=null,e.sel&&e.sel.selectedLayout&&(e.form.VaIt=null),t.length>=1&&w.validateEntry(t,i,{}).then(function(i){for(var r=0;r<i.length;r++)if(i[r].timetype==t)return void e.selectItemType(i[r],!1);e.selectItemType(i[0],!1)})):"project_stage"==i&&(e.validProjectStage=!1,e.form.projectstage=null,e.sel&&e.sel.selectedLayout&&(e.form.PrSt=null),t.length>=1&&w.validateEntry(t,i,{}).then(function(i){for(var r=0;r<i.length;r++)if(i[r].projectstage_id==t)return void e.selectProjectStage(i[r]);e.selectProjectStage(i[0])}))},e.selectProject=function(t,i){var r=e.getNextWizardFieldId();e.sel&&e.sel.selectedLayout&&(e.form.PrId={
id:t.project_id,name:t.project_name},e.form.PrId_entry=t.project_id,e.hasStages&&(e.form.PrSt=null,e.form.PrSt_entry=""),"PrSt"!=r&&e.checkTriggerField("PrId"),e.form.errorfld.PrId="");var o=t.project_id;w.getProjectById(o).then(function(o){if(1==o.length){t=o[0],e.form.project=t,e.form.project_entry=t.project_id,e.hasStages=t.number_of_stages>0,e.sel&&e.sel.selectedLayout&&(e.screenview(),"PrSt"==r&&e.checkTriggerField("PrId")),e.validProject=!0;var s={project_id:t.project_id,project_name:t.project_name,number_of_stages:t.number_of_stages,contact_name:t.contact_name};m.setRecentlySelected(s,"recent_projects"+(e.sel?e.sel.type:"")+(e.form.PcId?"_"+e.form.PcId.id:""))}i&&e.modal&&e.modal.hide()})},e.checkForNextWizardStep=function(t){if(e.wizard&&e.wizard.screens&&e.wizard.currentScreen<e.wizard.screens.length){var i=e.wizard.screens[e.wizard.currentScreen].fields[e.wizard.currentField],r=e.form[i];isNotEmpty(r)&&issearchfield(e.sel.selectedLayout.info.detailFields[i].ctype)?e.wizardGoNextField():"TimeSpan"==t||"EnTi"==t?e.wizardGoNext():i==t&&e.wizardGoNextField()}},e.selectActivity=function(t,i){e.form.activity=t,e.form.activity_entry=t.id,e.sel&&e.sel.selectedLayout&&(e.form.BiId={id:t.id,idext:t.id,name:t.description},e.form.BiId_entry=t.id,e.checkTriggerField("BiId"),e.form.errorfld.BiId="",e.screenview()),e.validActivity=!0,e.itemtypefixed&&e.defaultItemType&&e.selectItemType(e.defaultItemType,i),e.itemtypefixed=!1,w.checkForItemType(t).then(function(t){e.itemtypefixed=!0,e.selectItemType(t,i)}),i&&e.modal&&e.modal.hide(),m.setRecentlySelected(t,"recent_activities"+(e.sel?e.sel.type:"")+(e.form&&e.form.PcId?"_"+e.form.PcId.id:""))},e.selectItemType=function(t,i){e.form.itemtype=t,e.form.itemtype_entry=t.timetype,e.sel&&e.sel.selectedLayout&&(e.form.StId={id:t.timetype,name:t.description},e.form.StId_entry=t.timetype,e.checkTriggerField("StId"),e.form.errorfld.StId="",e.screenview()),i&&e.modal&&e.modal.hide(),m.setRecentlySelected(t,"recent_itemtypes")},e.selectProjectStage=function(t,i){e.form.projectstage=t,e.form.projectstage_entry=t.projectstage_id,e.sel&&e.sel.selectedLayout&&(e.form.PrSt={id:t.projectstage_id,name:t.projectstage_description},e.form.PrSt_entry=t.projectstage_id,e.checkTriggerField("PrSt"),e.form.errorfld.PrSt="",e.screenview()),i&&e.modal&&e.modal.hide()},e.openModal=function(t,i){c.openModal(e,t,e.getCurrentValues(),i)},e.closeModal=function(){e.modal.hide()},e.showhide=function(){e.hidden=!e.hidden},e.search=function(t){c.search(e,t,e.getCurrentValues())},e.loadMore=function(){c.loadMore(e,e.getCurrentValues())},e.clearSearch=function(t){c.clearSearch(e)},e.clickRecent=function(t){e.modal.query=t,c.search(e,t,e.getCurrentValues())},e.ShowRecentSearches=function(){c.ShowRecentSearches(e)},e.HideRecentSearches=function(){c.HideRecentSearches(e)},e.selectTab=function(t){e.modal&&!e.modal.loading&&(e.modal.showType=t)},e.validateEntry2Delayed=function(i,r,o){D&&t.cancel(D),D=t(function(){D=null,e.validateEntry2(i,r,o)},o?100:800)},e.validateEntry2=function(t,i,r){if("VaIt"!=i)switch("string"!=typeof t&&(t=String(t)),i){case"BiId":e.validateEntry(t,"activity");break;case"PrId":e.validateEntry(t,"project");break;case"PrSt":e.validateEntry(t,"project_stage");break;case"StId":e.validateEntry(t,"itemtype");break;default:e.form[i]=null,t.length>0?(e.form[i]={id:t},P.fieldId=i,e.sel&&e.sel.selectedLayout.info.detailFields[i]&&(P.searchview=e.sel.selectedLayout.info.detailFields[i].searchview),P.info=e.sel.selectedLayout,P.form=e.form,P.onlyId=!0,w.searchForField(P,t,0,T).then(function(i){for(var r=i.rows,o=0;o<r.length;o++)if(r[o]._id==t)return void e.selectItem(r[o],!1);r&&r.length>0&&e.selectItem(r[0],!1)})["finally"](function(){r&&r()})):r&&r()}},e.checkClosed=function(t){if(e.sel&&e.sel.selectedLayout&&e.currentDate){var i=!1;w.checkClosed(e,getJSONDate(e.currentDate,!0),t).then(function(e){e&&(i=e.closed)})["finally"](function(){e.locked=i})}},e.checkTriggerField=function(t){function i(t,i){var r=e.sel.selectedLayout.info["fieldSetting_"+e.sel.type];return r[t]&&r[t].TriggerFields&&-1!=r[t].TriggerFields.indexOf(i)}e.triggersBusy++;var r=[];switch(t){case"PrId":r.push(t),e.hasStages&&r.push("PrSt"),i("BiId",t)||r.push("BiId");break;case"BiId":i("PrId",t)||r.push("PrId"),e.form.PcId&&(i("PcId",t)||r.push("PcId")),e.hasStages&&(i("PrSt",t)||r.push("PrSt")),r.push(t);break;case"PrSt":i("PrId",t)||r.push("PrId"),r.push(t),i("BiId",t)||r.push("BiId");break;default:r.push(t)}var o=e.getCurrentWizardFieldId(),s=e.getNextWizardFieldId(),n=!s||!i(s,t);n?(e.checkForNextWizardStep(),o&&s||1==e.triggersBusy&&p.startBlock()):(""==o||o==t)&&1==e.triggersBusy&&p.startBlock(),log("trigger "+t),w.checkTriggerFields(r,e).then(function(){n||e.checkForNextWizardStep()})["finally"](function(){e.triggersBusy--,e.pickedFields&&(e.pickedFields[t]=1),n?o&&s||0==e.triggersBusy&&p.endBlock():(""==o||o==t)&&0==e.triggersBusy&&p.endBlock(),log("trigger finally "+t)})},e.openModalforField=function(t,i){switch(t){case"BiId":e.openModal("Pocket_Activities",i);break;case"PrId":e.openModal("Pocket_Projects",i);break;case"PrSt":e.openModal("Pocket_Project_Stages",i);break;case"StId":e.openModal("Pocket_ItemTypes",i);break;default:P.fieldId=t,P.info=e.sel.selectedLayout,P.form=e.form,e.getCurrentValues(),e.sel.selectedLayout&&e.sel.selectedLayout.info.detailFields[t]&&(P.searchview=e.sel.selectedLayout.info.detailFields[t].searchview,P.searchview.filter=e.sel.selectedLayout.info.detailFields[t].filter,isNotEmpty(P.searchview.fieldId2)&&(P.searchview.fromfieldId1?P.searchview.fieldValue2=formvalue(e.form[P.searchview.fromfieldId1],e.sel.selectedLayout.info.detailFields[P.searchview.fromfieldId1]):e.form[P.searchview.fieldId2]&&(P.searchview.fieldValue2=formvalue(e.form[P.searchview.fieldId2],e.sel.selectedLayout.info.detailFields[P.searchview.fieldId2]))),isNotEmpty(P.searchview.fieldId3)&&(P.searchview.fromfieldId2?P.searchview.fieldValue3=formvalue(e.form[P.searchview.fromfieldId2],e.sel.selectedLayout.info.detailFields[P.searchview.fromfieldId2]):e.form[P.searchview.fieldId3]&&(P.searchview.fieldValue3=formvalue(e.form[P.searchview.fieldId3],e.sel.selectedLayout.info.detailFields[P.searchview.fieldId3])))),c.openModal(e,"Pocket_TimesheetFields",P,i)}},e.selectItem=function(t,i){e.form[t.fieldId]={id:t._id,name:t._name},e.form[t.fieldId+"_entry"]=t._id,m.setRecentlySelected(t,"recent_timesheet_"+e.sel.selectedLayout.Id+"_"+t.fieldId+"_"+("PcId"!=t.fieldId&&e.form&&e.form.PcId?"_"+e.form.PcId.id:"")),e.form.errorfld[t.fieldId]="";for(var r in t)t.hasOwnProperty(r)&&-1!=r.indexOf("_fixed_")&&(e.form[t.fieldId][r]=t[r]);e.checkTriggerField(t.fieldId),e.screenview(),i&&e.modal&&e.modal.hide()},e.getCurrentValues=function(){return P.fields.Date=getJSONDate(e.currentDate,!0),P.fields.ProjectId=e.form.project?e.form.project.project_id:"",P.fields.ItemId=e.form.activity?e.form.activity.id:"",e.sel&&e.sel.selectedLayout&&(e.form.PrId&&(P.fields.ProjectId=e.form.PrId.id),e.form.BiId&&(P.fields.ItemId=e.form.BiId.idext||e.form.BiId.id),e.form.PrSt&&(P.fields.ProjectStageId=e.form.PrSt.id),P.fields.VaIt=e.sel.type,e.form.PcId&&(P.fields.PcId=e.form.PcId.idext||e.form.PcId.id)),P},e.postTimesheet=function(){if(0==e.triggersBusy)if(e.sel&&e.sel.selectedLayout)e.form.errorfld={},e.haserror=!1,e.form.DaTi=getGMTDate(e.currentDate),e.form.BiId&&(e.form.ItCd=e.form.BiId.id),w.postTimesheetByLayout(e).then(function(t){n.selection.callback?n.selection.callback(t):e.previousPage()});else{var t=0,i=0,r="",o="",s="",l="",c="";S()&&(t=e.form.activity.id,i=e.form.time,e.projectsactive&&null!=e.form.project&&(r=e.form.project.project_id),void 0!=e.form.comment&&(o=e.form.comment),e.showinternextern&&(s=e.form.commentint,l=e.form.commentext),e.hasStages&&(e.form.projectstage?c=e.form.projectstage.projectstage_id:""!=e.form.projectstage_entry&&(c=e.form.projectstage_entry)),a.getUser().then(function(a){e.user=a,d.getEnvConfig().then(function(a){var d="";if(e.hasItemTypes&&null!=e.form.itemtype&&(d=e.form.itemtype.timetype),""==d&&null!=a&&"undefined"!=typeof a.timesheetconfig){var f=(e.currentDate.getDay()+6)%7;d=a.timesheetconfig[f].HoursNormal}("undefined"==typeof d||""==d)&&(d="1");var m={DaTi:getJSONDate(getGMTDate(e.currentDate)),VaIt:1,ItCd:t,StId:d,Qu:i,EmId:e.user.employee_id,PrSt:c};n.selection.rowid&&(m.Id=n.selection.rowid),e.showinternextern?(m.DsIn=s,m.DsEx=l):m.Ds=o,e.projectsactive&&(m.PrId=r),w.postTimesheet(m).then(function(t){e.previousPage()})})}))}}}]).controller("TimesheetsDetailController",["$scope","$state","$ionicPopup","$stateParams","SharedTimesheetService","ConfigService",function(e,t,i,r,o,s){var n=o.getTimesheetService();e.$on("$ionicView.enter",function(){n.loadEntryLayouts(e,!1)["finally"](function(){e.sel&&e.sel.selectedLayout&&e.sel.selectedLayout.info&&e.sel.selectedLayout.info.labels&&(e.descfromlayout={fase:e.sel.selectedLayout.info.labels.PrSt,project:e.sel.selectedLayout.info.labels.PrId,item:e.sel.selectedLayout.info.labels.BiId,amount:e.sel.selectedLayout.info.labels.QuUn})}),n.getSpecificTimesheet(r.guid).then(function(t){e.timesheet=t[0]}),s.getConfig().then(function(t){e.mayApprove="1"==t.mayapprovehours||"undefined"==typeof t.mayapprovehours})}),e.approveTimesheet=function(){if(e.mayApprove){var o=i.confirm({title:atrans("approve","Accorderen"),cssClass:"afaserrorpopup",template:atrans("approvetext","Weet je zeker dat je de nacalculatieregel wilt accorderen?"),cancelText:atrans("no","Nee"),okText:atrans("yes","Ja")});o.then(function(i){if(i){var o=new Date(Date.parse(e.timesheet.date)),s=getJSONDate(o);n.postApproved(r.guid,s,!0).then(function(i){t.go("menu.timesheetsday",{selection:{date:Date.parse(e.timesheet.date)}},{reload:!1})})}})}},e.editTimesheet=function(i){var r={type:i.type,date:fromGMTDate(parseDateString(i.date)),rowid:i.guid,sel:e.sel,timesheet:i};t.go("menu.timesheetswizard",{selection:r},{reload:!1})},e.disapproveTimesheet=function(){if(e.mayApprove){var o=i.confirm({title:atrans("disapprove","Accorderen ongedaan maken"),cssClass:"afaserrorpopup",template:atrans("disapprovetext","Weet je zeker dat je de nacalculatieregel accordering wil ongedaan maken?"),cancelText:atrans("no","Nee"),okText:atrans("yes","Ja")});o.then(function(i){if(i){var o=new Date(Date.parse(e.timesheet.date)),s=getJSONDate(o);n.postApproved(r.guid,s,!1).then(function(i){t.go("menu.timesheetsday",{selection:{date:Date.parse(e.timesheet.date)}},{reload:!1})})}})}}}]);