angular.module("projects.controller",["AfasServices"]).factory("SharedProjectService",["ProjectServiceFactory",function(e){var t=e.getInstance();return{getProjectService:function(){return t}}}]).controller("ProjectsController",["$scope","$state","$timeout","$ionicScrollDelegate","$ionicTabsDelegate","$ionicSlideBoxDelegate","$ionicActionSheet","$ionicPopup","ListServiceFactory","ModalFilterService","SharedProjectService","ConfigService","SearchService","FavoriteService","maxListTake","ConnectorService","MultipleViewsManager","EnvConfigService","ModalSearchService",function(e,t,o,r,a,n,i,s,c,l,d,u,f,h,p,m,g,j,y){function v(){h.getFavorites(I).then(function(t){e.favorites=t?t.map(function(e){return e.isFav=!0,e}):[]})}function b(t){var o=e.tabs[t];o.loading=!0,o.searched=!1;var r=o.orderBy?o.orderBy.id:null;S.getProjects(o.mode,0,p,r,o.orderByDir,o.query,o.searchField).then(function(t){o.showmore=t.rows.length>=p,o.loaded=t.rows.length,o.fields=t.deffields,Array.prototype.push.apply(o.fields,t.fields),t.rows=w(t.rows),o.orderByHeader&&(t.rows=_.handleHeaders(t.rows,o.orderBy)),o.projects=angular.copy(e.favorites),Array.prototype.push.apply(o.projects,t.rows),o.orderByHeader&&e.favorites.length>0&&o.projects.splice(0,0,{divider:atrans("favorites","Favorieten")}),o.searched=!0,e.$broadcast("scroll.refreshComplete")})["finally"](function(){o.loading=!1})}function w(t){return t.filter(function(t){return!e.favorites.some(function(e){return e._id===t._id?(e._name!=t._name,!0):!1})})}var S=d.getProjectService(),_=c.getInstance(),P="Projects",I="Projects",D={ProjectService:S};e.pageTitle=atrans("projects","Projecten"),e.searchplaceholder=atrans("projectsplaceholder","Zoek op project"),e.refreshText=atrans("refreshtext","Laat los om te verversen"),e.favorites=null,e.tabs=[{name_id:"tabMyProjects",mode:5,title:atrans("myprojects","Mijn projecten")},{name_id:"tabAllProjects",mode:6,title:atrans("allprojects","Alle projecten")}],e.tabs.map(function(t,o){t.loading=!1,t.searched=!1,t.query=null,t.searchField=LocalStorage.getItem("Projects"+o+"searchField")||null;var r=LocalStorage.getItem("Projects"+o+"searchFieldName");return t.searchPlaceHolder=r?atrans("searchgen","Zoek op {0}",r):e.searchplaceholder,t.orderBy=JSON.parse(LocalStorage.getItem("Projects"+o+"sortfield"))||null,t.orderByHeader=t.orderBy?_.controlDataTypeAllowsHeader(t.orderBy.ctype,t.orderBy.dtype):!1,t.orderByDir=parseInt(LocalStorage.getItem("Projects"+o+"sortdir")||"1",10),t.orderByDirName=0==t.orderByDir?"Z-A":"A-Z",t}),e.toggleFavorite=function(e,t){if(1!=e){var o=300,r=750;setTimeout(function(){n.slide(1,r)},o),setTimeout(function(){if(t.isFav)t.isFav=!1,h.removeFavorite(t,I);else{var e={_id:t._id,_name:t._name,isFav:!0,dateAdded:Date.now(),dateLastOpened:null};h.setFavorite(e,I).then(function(e){t.isFav=e})}},o+r+200)}},e.scrollTop=function(){r.$getByHandle("projects").scrollTop(!0)},e.$on("$ionicView.beforeEnter",function(){e.landscape=e.isLandscape(),j.getEnvConfig().then(function(t){e.showNewProject=t.profileinfo[18]&&t.profileinfo[18]>0})}),v(),b(0),e.$on("$ionicView.unloaded",function(){e.slider=void 0}),e.loadMoreProjects=function(t){var o=e.tabs[t];if(!o.loading){o.loading=!0;var a=o.orderBy?o.orderBy.id:null;S.getProjects(o.mode,o.loaded,p,a,o.orderByDir,o.query,o.searchField).then(function(t){o.showmore=t.rows.length>=p,o.loaded+=t.rows.length,t.rows=w(t.rows),o.orderByHeader&&(t.rows=_.handleHeaders(t.rows,o.orderBy,o.projects[o.projects.length-1])),Array.prototype.push.apply(o.projects,t.rows),e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){o.loading=!1,r.$getByHandle("projects").resize(),e.$broadcast("scroll.refreshComplete")})}},e.refresh=function(e){b(e)},e.goToProject=function(o,r){r.isFav&&(r.dateLastOpened=Date.now()),g.isActive()?(e.selectedProject=o,g.updateView("projects-detail",{projectId:o,projectName:r._name})):t.go("menu.project",{projectId:o,projectName:r._name})},e.selectProjectType=function(o){f.setRecentlySelected(o,"recent_project_profiles"),t.go("menu.newproject",{projectProfile:o},{reload:!0}),e.modal&&e.modal.hide()},e.newProject=function(){function r(e){o(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),i.show({buttons:e,titleText:atrans("newProject","Nieuw project"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(o){t.go("menu.newproject",{projectProfile:e[o].projProfile},{reload:!0})}})}j.getEnvConfig().then(function(t){t.profileinfo[18]&&t.profileinfo[18]>0?t.profileinfo[18]>5?e.openModalProfile():S.searchProfiles("",0,6).then(function(e){for(var t=[],o=0;o<e.length;o++)t.push({text:"<i class='icon iconHide'></i>"+e[o].Description,id:2,projProfile:e[o]});r(t)}):s.alert({title:atrans("error","Foutmelding"),template:atrans("noprojectprofiles","Geen pocket projectprofielen gevonden")})})},e.$on("$ionicSlides.sliderInitialized",function(t,o){e.slider=o.slider,a.$getByHandle("tabsprojects").select(0),e.slider.lockSwipes()}),e.$on("$ionicSlides.slideChangeStart",function(e,t){o(function(){a.$getByHandle("tabsprojects").select(t.slider.activeIndex)},1)}),e.selectProjectTab=function(t){e.slider&&e.slider.activeIndex!=t&&(e.slider.unlockSwipes(),e.slider.slideTo(t),e.slider.lockSwipes(),e.tabs[t].searched||e.refresh(t))},e.searchProjects=function(t){var o=e.tabs[t].query;0==o.length?e.clearSearchProjects(t):(f.setSearchHistory(o,P),r.$getByHandle("projects").scrollTop(!0),b(t),hideKeyboard(),e.HideRecentProjectSearches())},e.ShowRecentProjectSearches=function(){f.getSearchHistory(P).then(function(t){e.recent=t})},e.HideRecentProjectSearches=function(){o(function(){e.recent=0},100)},e.clickRecentProjects=function(t,o){var r=e.tabs[t];r.query=o,e.searchProjects(o)},e.removeItemProjects=function(e,t){e.preventDefault(),e.stopPropagation(),f.removeItem(t,P)},e.clearSearchProjects=function(t){var o=e.tabs[t];o.query="",e.HideRecentProjectSearches(),o.projects=null,o.loaded=0,e.refresh(t)},e.openModalQuery=function(t,o){var r=e.tabs[t],a=r.orderBy?r.orderBy.id:null;l.openModal(e,r.fields,r.orderByDir,r.searchField,a)},e.selectModalTab=function(t){e.modal&&(e.modal.showType=t)},e.selectModalSearchField=function(t){var r=e.slider.activeIndex;LocalStorage.setItem("Projects"+r+"searchField",t.id),LocalStorage.setItem("Projects"+r+"searchFieldName",t.name),e.tabs[r].searchField=t.id,e.tabs[r].searchPlaceHolder=atrans("searchgen","Zoek op {0}",t.name),e.modal&&o(function(){e.modal.hide()},200)},e.selectModalSortField=function(t){var r=e.slider.activeIndex;LocalStorage.setItem("Projects"+r+"sortfield",JSON.stringify(t)),e.tabs[r].orderBy=t,e.tabs[r].orderByHeader=_.controlDataTypeAllowsHeader(t.ctype,t.dtype),e.modal&&o(function(){e.modal.hide()},200),b(r)},e.reverseOrderBy=function(t){e.pickdir(0==t.orderByDir?1:0),r.$getByHandle("projects").scrollTop(!0)},e.pickdir=function(t){var r=e.slider.activeIndex;LocalStorage.setItem("Projects"+r+"sortdir",t),e.tabs[r].orderByDir=t,e.tabs[r].orderByDirName=0==t?"Z-A":"A-Z",e.modal?(e.modal.sortDir=t,e.tabs[r].orderBy&&(o(function(){e.modal.hide()},200),b(r))):b(r)},e.openModalProfile=function(){y.openModal(e,"Pocket_ProjectProfiles",D)},e.search=function(t){y.search(e,t,D)},e.selectTab=function(t){e.modal&&!e.modal.loading&&(e.modal.showType=t)},e.loadMore=function(){y.loadMore(e,D)},e.clearSearch=function(t){y.clearSearch(e)},e.clickRecent=function(t){e.modal.query=t,y.search(e,t,D)},e.ShowRecentSearches=function(){y.ShowRecentSearches(e)},e.HideRecentSearches=function(){y.HideRecentSearches(e)},e.closeModal=function(){e.modal.hide()},e.showhide=function(){e.hidden=!e.hidden}}]).controller("ProjectController",["$scope","$state","$timeout","$ionicTabsDelegate","$ionicPopover","$ionicSlideBoxDelegate","SharedProjectService","ContactServiceFactory","MultipleViewsManager","$stateParams","FavoriteService","ConnectorService","SubjectServiceFactory","TimesheetServiceFactory","maxListTake","ListServiceFactory","SearchService",function(e,t,o,r,a,n,i,s,c,l,d,u,f,h,p,m,g){function j(){e.pageTitle=e.projectName,M.getProject(e.projectId).then(function(t){e.project=t,_(),S()}),M.getTeam(e.projectId).then(function(t){e.team={IPL:null,EPL:null,members:t,internalMembers:[],externalMembers:[]};for(var o=0;o<t.length;o++)"IPL"==t[o].Team_Role_Code||"EPL"==t[o].Team_Role_Code?e.team[t[o].Team_Role_Code]=t[o]:e.team[null===t[o].Employee_Code?"externalMembers":"internalMembers"].push(t[o]),t[o].expanded=!1;v(t,"Member_Img"),e.teamsLoaded=!0,P()}),y(),b(),e.$broadcast("refreshChildControllers"),e.loaded=!0,e.showType="general",o(function(){e.selectProjectTab(0)},1)}function y(){d.getFavorites(B).then(function(t){if(t){var o=t.filter(function(t){return t._id==e.projectId});e.isFav=o.length>0}})}function v(e,t){for(var o={},r=0;r<e.length;r++){var a=e[r][t];a&&(o[a]||(o[a]=!0,u.getImageData(a,1).then(function(o){if(o.url)for(var r=0;r<e.length;r++)e[r][t]==o.key&&(e[r].image=o.url)})))}}function b(){e.tabs=[],e.tabs.push({title:"Overzicht",name_id:"tabGeneral",showType:"general"}),e.tabs.push({title:"Team",name_id:"tabTeam",showType:"team"}),e.tabs.push({title:"Uren",name_id:"tabHours",showType:"hours"}),e.showPhasesTab&&e.tabs.push({title:"Fases",name_id:"tabStages",showType:"stages"}),e.tabs.push({title:"Dossier",name_id:"tabDossier",showType:"subjects"}),e.useTabs=e.tabs.length>1,w(),o(function(){e.selectProjectTab(1),e.selectProjectTab(0)},1)}function w(){o(function(){for(var e=document.querySelectorAll("#projectScrollTabBar .tab-item"),t=document.getElementById("projectScrollTabBar").children[0],o=0,r=0;r<e.length;r++){var a=e[r];if(a.offsetLeft+a.offsetWidth>=t.offsetWidth){var n=a.offsetLeft+a.offsetWidth-t.offsetWidth,i=a.offsetWidth/2;return r==e.length-1&&a.offsetLeft+a.offsetWidth==t.offsetWidth?(t.style.paddingLeft=0,void(t.style.justifyContent="center")):(i>n?o=i-n:n>i&&(o=r>0?e[r-1].offsetWidth/2+a.offsetWidth-n:20),t.style.justifyContent="space-between",void(t.style.paddingLeft=o+"px"))}}},1)}function S(){e.project.Location_AddressId?e.project.location={street:e.project.Location_Street,house_number:e.project.Location_Housenumber,house_number_add:e.project.Location_Housenumber_Addition,address_add:e.project.Location_Address_Addition,postal_code:e.project.Location_Zipcode,city:e.project.Location_City,state:e.project.Location_State,country:e.project.Location_Country}:e.project.location={street:e.project.Street,house_number:e.project.Housenumber,house_number_add:e.project.Housenumber_Addition,address_add:e.project.Address_Addition,postal_code:e.project.Zipcode,city:e.project.City,state:e.project.Location_State,country:e.project.Country},E.getGoogleMapsLinkAndImage(e,e.project.location),e.project.Contact_Id&&(e.project.contact={id:e.project.Contact_Id,name:e.project.Contact_Name,image_id:null!=e.project.Contact_Image_Id?e.project.Contact_Image_Id:e.project.Contact_Org_Image_Id},e.project.contact.image_id&&u.getImageData(e.project.contact.image_id,2).then(function(t){t.url?e.project.contact.image_src=t.url:e.project.contact.imagesrc="img/man.png"})),e.project.Sales_Relation_Id&&(e.project.salesrelation={id:e.project.Sales_Relation_Id,name:e.project.Sales_Relation_Name,image_id:e.project.Sales_Relation_Image_Id},e.project.salesrelation.image_id&&u.getImageData(e.project.salesrelation.image_id,2).then(function(t){t.url?e.project.salesrelation.image_src=t.url:e.project.contact.imagesrc="img/man.png"})),o(function(){var t=[{type:"matrix",data:[["Type","Hours"],["Hours_Declaration",e.project.Hours_Declaration],["Hours_Difference",e.project.Hours_Difference]]}],o={element:document.querySelector("#container"+e.project.Project_Id),data:t,settings:{scales:{c:{type:"categorical-color",data:["Hours_Declaration","Hours_Difference"],range:[e.project.Hours_Declaration>e.project.Hours_Quotation?"red":"#bbb","green"]}},components:[{key:"p",type:"pie",data:{extract:{field:"Type",props:{num:{field:"Hours"}}}},settings:{padAngle:.02,slice:{cornerRadius:4,innerRadius:.4,arc:{ref:"num"},fill:{scale:"c"},strokeWidth:1,stroke:"rgba(255, 255, 255, 0.5)"}},layout:{displayOrder:1}},{type:"labels",displayOrder:2,settings:{sources:[{component:"p",selector:"path",strategy:{type:"slice",settings:{direction:"right",fontSize:24,labels:[{placements:[{position:"inside"},{position:"inside"}],label:function(t){return e.project.Hours_Difference>0?"Hours_Difference"==t.data.value?(100*t.data.num.value/Math.max(t.data.num.value,e.project.Hours_Quotation)).toFixed(0)+"%":"":(100*e.project.Hours_Declaration/e.project.Hours_Quotation).toFixed(0)+"%"}}]}}}]}}]}};picasso.chart(o)},100)}function _(){var t=e.project,o=t.Date_Start?Date.parse(t.Date_Start):null,r=t.Date_End?Date.parse(t.Date_End):Date.parse(t.Date_Planned),a=Date.now(),n=Math.round((+r-o)/864e5),i=Math.round((+r-a)/864e5);t.daysLeft=i,t.daysLeftPercentage=Math.round(i/n*100),t.Hours_Difference=-1*t.Hours_Difference,t.Hours_DifferencePercentage=t.Hours_Quotation?Math.round(t.Hours_Difference/t.Hours_Quotation*100):null}function P(){var t=new Date;t.setDate(t.getDate()-(t.getDay()-1)),t.setDate(t.getDate()-7*(W+1));for(var o=[],r=0;2*W>=r;r++)t.setDate(t.getDate()+7),o.push(D(t));o[W].week=atrans("week","week")+" "+o[W].date.getWeek()+" "+o[W].date.getTimesheetYear()+" ("+atrans("thisweek","deze week")+")",e.slides=o,T(e.slides[W].date,!0)}function I(t){var r,a,n=t?e.WeekHoursSlider.currentIndex():0,i=t?1:-1;for(r=new Date(e.slides[n].date),a=0;W>a;a++)r.setDate(r.getDate()+7*i),t?e.slides.push(D(r)):e.slides.unshift(D(r));t||o(function(){e.WeekHoursSlider.slide(W,1)},10),e.WeekHoursSlider.update()}function D(e){var t=new Date(e);return{date:t,loaded:!1,forceRefresh:!1,week:atrans("week","week")+" "+t.getWeek()+" "+t.getTimesheetYear()}}function T(t,o){for(var r=new Date(t),a=0,n=0;n<e.slides.length;n++)e.slides[n].date.equals(r)&&(a=n);var i=new Date(e.slides[a].date),s=new Date(i);s.setDate(i.getDate()+6),e.slides[a].forceRefresh&&(e.slides[a].forceRefresh=!1),A.getProjectTimesheets(i,s,e.projectId).then(function(t){v(t,"employee_img");for(var n,s=[],c=k(t),l=0;l<e.slides.length;l++)if(e.slides[l].date.equals(r)){for(n=0;7>n;n++){var d=new Date(i);d.setDate(d.getDate()+n);for(var u=C(t,d),f=0;f<c.length;f++)c[f].days.push({day_num:d.getDate(),day:getDayString(n),hours:$(t,d,c[f].name)});s.push({hours:u.totalHours,date:new Date(d),dateString:getJSONDate(d),day_num:d.getDate(),day:getDayString(n),month:getMonthString(d.getMonth()).substring(0,3).toUpperCase(),rows:u.days,employeeRows:H(u.days),expanded:!1})}e.slides[l].days=s,e.slides[l].employees=c,e.slides[l].total=F(s),e.slides[l].loaded=!0,e.slides[l].isExpanded=!1;break}var h=new Date,p=new Date;if(e.slides[a]&&e.slides[a].date.getWeek()==h.getWeek()&&e.slides[a].date.getTimesheetYear()==h.getTimesheetYear())for(e.slides[a].week=atrans("week","week")+" "+e.slides[a].date.getWeek()+" "+e.slides[a].date.getTimesheetYear()+" ("+atrans("thisweek","deze week")+")",n=0;n<e.slides[a].days.length;n++)p=e.slides[a].days[n].date,p.getDate()==h.getDate()&&(e.slides[a].days[n].highlight=!0);if(void 0!=o&&o)try{e.WeekHoursSlider.slide(a),e.showSlidebox=!0}catch(m){}})}function H(t){for(var o=[],r={},a=e.team.internalMembers.length>0,n=0;n<e.team.members.length;n++){var i=e.team.members[n];null!==i.Employee_Code&&(r[i.Employee_Code]=n,o.push({employee:i.Employee_Code,employee_name:i.Member_Name,image:i.image,hours:0,rows:[]}))}for(n=0;n<t.length;n++){var s=t[n],c=r[s.employee];void 0===c&&(r[s.employee]=o.length,c=o.length,o.push(s),o[o.length-1].hours=0,o[o.length-1].rows=[],o[o.length-1].notInTeam=a),o[c].hours+=s.quantity,o[c].rows.push(s)}return o}function k(e){for(var t=[],o=[],r=0;r<e.length;r++)-1==t.indexOf(e[r].employee)&&t.push(e[r].employee);for(r=0;r<t.length;r++)o.push({name:t[r],days:[]});return o}function $(e,t,o){for(var r=0,a=0;a<e.length;a++){var n=fromGMTDate(new Date(Date.parse(e[a].date)));n.getDate()==t.getDate()&&o==e[a].employee&&(r+=e[a].quantity)}return r}function C(e,t){var o={};o.totalHours=0,o.days=[];for(var r=0;r<e.length;r++){var a=fromGMTDate(new Date(Date.parse(e[r].date)));a.getDate()==t.getDate()&&(o.totalHours+=e[r].quantity,o.days.push(e[r]))}return o}function F(e){for(var t=0,o=0;o<e.length;o++)t+=e[o].hours;return t}function x(t){e.isExpanded=t,e.slides[e.WeekHoursSlider.currentIndex()].isExpanded=t}var B="Projects",M=i.getProjectService(),L=f.getInstance(),E=s.getInstance(),A=h.getInstance(),R=m.getInstance(),W=2,q=!1,N="";R.itemHeight="90",R.getHREFCallback=getSubjectHREF,e.projectId=null,e.isFav=!1,e.loaded=!1,e.teamsLoaded=!1,e.showplaceholder=c.isActive(),e.tabs=[{title:"Overzicht",name_id:"tabGeneral"}],e.pageTitle=atrans("projects","Projecten"),e.fabIcon="ion-edit",e.removeFab=!1,e.searchplaceholderSubject=atrans("subjectSearchplaceholder","Zoek naar een dossieritem"),e.refreshText=atrans("refreshtext","Laat los om te verversen"),e.showmore_subjects=!1,e.queryData={},e.queryData.subjectQuery="",e.searchedSubject=!1,e.showTeamWeekSlider=!1,e.showSlidebox=!1,e.isExpanded=!1,e.sliderWeek={effect:"slide",initialSlide:W,resistanceRatio:0,paginationHide:!1,runCallbacksOnInit:!1},e.WeekHoursSlider=n.$getByHandle("WeekHoursSlider"),e.showPhasesToggleButton=!0,e.showPhasesTab=!1,e.showPhasesSlide=!0,e.toggleStagesView=function(){e.$broadcast("toggleStages")},e.$on("hidePhasesToggle",function(t,o){e.showPhasesToggleButton=!1}),e.$on("showPhasesTab",function(t,o){e.showPhasesTab=!0,e.tabs.length<=1?b():(e.tabs.push({title:"Fases",name_id:"tabStages",showType:"stages"}),w())}),e.$on("hidePhasesSlide",function(t,o){e.showPhasesSlide=!1}),l&&null!=l.projectId&&(e.projectId=l.projectId,e.projectName=l.projectName,j()),c.updated("projects-detail",function(t){e.loaded=!1,e.teamsLoaded=!1,e.projectId=t.projectId,e.projectName=t.projectName,e.showplaceholder=!1,e.weeksloaded=!1,e.showPhasesToggleButton=!0,e.showPhasesTab=!1,e.showPhasesSlide=!0,e.showSlidebox=!1,e.isExpanded=!1,e.WeekHoursSlider=n.$getByHandle("WeekHoursSlider"),q=!1,j()}),e.toggleFavorite=function(){if(e.isFav)e.isFav=!1,d.removeFavorite({_id:e.projectId},B);else{var t={_id:e.projectId,_name:e.projectName,isFav:!0,dateAdded:Date.now(),dateLastOpened:Date.now()};d.setFavorite(t,B).then(function(t){e.isFav=t})}},a.fromTemplateUrl("popoverOptions.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.openMembersPopover=function(e){},e.closePopover=function(){e.popover.hide()},e.$on("$destroy",function(){e.popover.remove()}),e.$on("$ionicSlides.sliderInitialized",function(t,o){e.slider=o.slider,r.$getByHandle("tabsproject").select(0)}),e.$on("$ionicSlides.slideChangeStart",function(t,a){var n,i=e.showType;o(function(){switch(n=a.slider.activeIndex,e.showType=e.tabs[n].showType,void 0!=i&&(hasFab(e.showType)?e.removeFab?(e.removeFab=!1,e.addFab=!0):e.changeFab=!0:e.removeFab=!0),e.showType){case"general":e.fabIcon="ion-edit";break;case"hours":case"subjects":e.fabIcon="ion-plus";break;case"stages":case"team":e.fabIcon=""}r.$getByHandle("tabsproject").select(a.slider.activeIndex)},1)}),e.$on("$ionicSlides.slideChangeEnd",function(t,r){document.querySelector(".tab-item-active").scrollIntoView({behavior:"smooth",inline:"center"}),o(function(){e.addFab=!1,e.changeFab=!1,"subjects"!=e.showType||q||(q=!0,getSubjects()),"hours"==e.showType&&e.WeekHoursSlider.update()},1)}),e.selectProjectTab=function(t,o){o&&o.target&&o.target.scrollIntoView({behavior:"smooth",inline:"center"}),e.slider&&e.slider.activeIndex!=t&&e.slider.slideTo(t)},hasFab=function(e){switch(e){case"general":return!0;case"team":return!1;case"hours":return!0;case"stages":return!1;case"subjects":return!0}},e.projectAction=function(){switch(e.showType){case"general":generalAction();break;case"team":teamAction();break;case"hours":hoursAction();break;case"stages":break;case"subjects":e.sendSubject()}},generalAction=function(){},teamAction=function(){},hoursAction=function(){},e.editStatus=function(){},e.editProject=function(){},e.sendSubject=function(){e.gotoPage("menu.newsubjects")},e.clickMember=function(t){e.goToEmployee(t.Employee_Code)},e.goToEmployee=function(o){c.isActive()?(e.selectedEmployee=o,c.updateView("employees-detail",{employeeId:o})):t.go("menu.employee",{id:o})},e.clickExternalMember=function(t){e.gotoContact(t.Member_Contact_Id)},e.holdMember=function(e){},e.addHoursMember=function(o){A.loadEntryLayouts(e).then(function(){var r={type:1,date:new Date,defaultFields:{EmId:{ctype:5,value:o.Employee_Code,description:o.Member_Name},PrId:{ctype:5,value:o.Project_Id,description:e.projectName}},sel:e.sel};t.go("menu.timesheetswizard",{selection:r},{reload:!0})})},getSubjects=function(){N="",e.queryData.subjectQuery="",L.getSubjectsByProject(e.projectId,"",0,p).then(function(t){e.showmore_subjects=t.length>=p,e.subjects=R.divideList(t,3,"submitdate",2),e.totalsubjects=t.length,e.$broadcast("scroll.refreshComplete"),e.refreshing=!1})},e.loadMoreSubjects=function(){e.loadingMore||(e.loadingMore=!0,""!=e.queryData.subjectQuery&&e.queryData.subjectQuery!=N&&(N=e.queryData.subjectQuery,e.subjects=[]),L.getSubjectsByProject(e.projectId,N,e.subjects.length,p).then(function(t){e.showmore_subjects=t.length>=p;for(var o=0;o<t.length;o++)e.subjects.push(t[o]);e.subjects=R.divideList(e.subjects,3,"submitdate",2),e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){e.loadingMore=!1,e.$broadcast("scroll.refreshComplete")}))},e.searchCachedSubjects=function(){e.HideRecentSearches("subjects"),N=e.queryData.subjectQuery,e.searchedSubject=!0,e.subjects=[],L.getSubjectsByProject(e.projectId,e.queryData.subjectQuery,e.subjects.length,p).then(function(t){e.showmore_subjects=t.length>=p,e.subjects=R.divideList(t,3,"submitdate",2),e.totalsubjects=t.length,e.$broadcast("scroll.refreshComplete"),e.refreshing=!1,hideKeyboard()})},e.clearSubjects=function(){e.queryData.subjectQuery="",e.subjects=[],e.HideRecentSearches("subjects"),getSubjects()},e.ShowRecentSearches=function(t){g.getSearchHistory(t).then(function(o){"subjects"==t&&(e.recentSubjects=o)})},e.HideRecentSearches=function(t){"subjects"==t&&o(e.recentSubjects=0,200)},e.clickRecent=function(t,o){"subjects"==o&&(e.queryData.subjectQuery=t,e.searchCachedSubjects())},e.removeItem=function(e,t,o){e.preventDefault(),e.stopPropagation(),g.removeItem(t,o)},e.slideChanged=function(t){var o=e.slides[t];o.loaded&&!o.forceRefresh||0==t||T(o.date),t==e.slides.length-1?I(!0):0==t&&I(!1),e.isExpanded=o.isExpanded},e.lockSlide=function(){n.$getByHandle("WeekHoursSlider").enableSlide(!1)},e.resetWeek=function(){for(var t=new Date,o=0;o<e.slides.length;o++)e.slides[o].date.getWeek()==t.getWeek()&&e.slides[o].date.getTimesheetYear()==t.getTimesheetYear()&&e.WeekHoursSlider.slide(o)},e.toggleExpand=function(e,t){return t.isExpanded&&e.expanded?(x(!1),void(e.expanded=!1)):(e.expanded=!e.expanded,void(e.expanded&&(t.days.some(function(e){return!e.expanded})||x(!0))))},e.toggleExpandFull=function(){var t=e.slides[e.WeekHoursSlider.currentIndex()];if(t.loaded){var o=!e.isExpanded;x(o);for(var r=0;r<t.days.length;r++)t.days[r].expanded=o}}}]).controller("NewProjectController",["$scope","$state","$ionicScrollDelegate","SharedProjectService","ModalSearchService","SearchService","UserService",function(e,t,o,r,a,n,i){e.pageTitle=atrans("projectnew","Nieuw project");var s,c=r.getProjectService(),l=t.params.projectProfile,d={ProjectService:c};e.attachment_type="",e.setupFile=function(t){document.getElementById("fileBrowser").onchange=function(o){e.filePickedGeneric(o,t,e)}},e.$on("$ionicView.beforeEnter",function(){o.$getByHandle("main").scrollTop(!0),l=t.params.projectProfile,e.info=null,e.form={},e.form.errorfld={},e.form.attachments=[],e.infoLoaded=!1,null!=l?(o.resize(),i.getUser().then(function(t){c.getProjectInfo(l.Id).then(function(o){parseInfo(e,o,t,!1,"validateEntry"),e.title=l.Description,e.screenview(),e.checkForOSAttachments(e.form)},function(){e.previousPage()})["finally"](function(){e.infoLoaded=!0})})):(e.infoLoaded=!0,e.previousPage())}),e.addAttachment=function(t){e.showFileActionsGeneric(t,e)},e.showAttachment=function(t){"img"==t.type&&e.showImage(t.src)},e.deleteAttachment=function(t){if(""!=t.src&&e.file_attached&&confirm(atrans("deletesubattach","Wil je deze bijlage verwijderen?"))){var o=e.form.attachments.indexOf(t);-1!=o&&e.form.attachments.splice(o,1)}},e.openModalforField=function(t){if(d.fieldId=t,d.info=e.info,d.form=e.form,e.info[t])d.searchview=e.info[t].searchview,d.searchview.filter=e.info[t].filter,d.searchview.fromfieldId1?d.searchview.fieldValue2=formvalue(e.form[d.searchview.fromfieldId1],e.info[d.searchview.fromfieldId1]):e.form[d.searchview.fieldId2]&&(d.searchview.fieldValue2=formvalue(e.form[d.searchview.fieldId2],e.info[d.searchview.fieldId2])),d.searchview.fromfieldId2?d.searchview.fieldValue3=formvalue(e.form[d.searchview.fromfieldId2],e.info[d.searchview.fromfieldId2]):e.form[d.searchview.fieldId3]&&(d.searchview.fieldValue3=formvalue(e.form[d.searchview.fieldId3],e.info[d.searchview.fieldId3]));else for(var o in e.info.custom)if(e.info.custom.hasOwnProperty(o)&&e.info.custom[o][t]){d.searchview=e.info.custom[o][t].searchview;break}a.openModal(e,"Pocket_ProjectFields",d)},e.closeModal=function(){$rootScope.currentModal=null,e.modal.hide()},e.search=function(t){a.search(e,t,d)},e.loadMore=function(){a.loadMore(e,d)},e.clearSearch=function(t){a.clearSearch(e)},e.clickRecent=function(t){e.modal.query=t,a.search(e,t,d)},e.ShowRecentSearches=function(){a.ShowRecentSearches(e,d)},e.HideRecentSearches=function(){a.HideRecentSearches(e)},e.selectTab=function(t){e.modal&&!e.modal.loading&&(e.modal.showType=t)},e.validateEntryDelayed=function(t,o,r){s&&$timeout.cancel(s),s=$timeout(function(){s=null,e.validateEntry(t,o,r)},r?100:800)},e.validateEntry=function(t,o,r){if(e.form[o]=null,"string"!=typeof t&&(t=String(t)),t.length>0){if(e.form[o]={id:t},d.fieldId=o,e.info[o])d.searchview=e.info[o].searchview;else for(var a in e.info.custom)if(e.info.custom.hasOwnProperty(a))for(var n in e.info.custom[a])e.info.custom[a].hasOwnProperty(n)&&e.info.custom[a][n]&&e.info.custom[a][n].searchview&&(d.searchview=e.info.custom[a][n].searchview);d.info=e.info,d.form=e.form,d.onlyId=!0,SubjectService.searchForField(d,t,0,maxListTake).then(function(o){for(var r=o.rows,a=0;a<r.length;a++)if(r[a]._id==t)return void e.selectItem(r[a]);r&&r.length>0&&e.selectItem(r[0])})["finally"](function(){r&&r()})}else r&&r()},e.validateEntry2Delayed=e.validateEntryDelayed,e.validateEntry2=e.validateEntry,e.postProject=function(){e.form.errorfld={},e.haserror=!1,c.postProject(e).then(function(){e.previousPage()})},e.selectItem=function(t){e.form[t.fieldId]={id:t._id,name:t._name},e.form[t.fieldId+"_entry"]=t._id,n.setRecentlySelected(t,"recent_proj_"+e.info.type+"_"+t.fieldId),e.form.errorfld[t.fieldId]="";for(var o in t)t.hasOwnProperty(o)&&-1!=o.indexOf("_fixed_")&&(e.form[t.fieldId][o]=t[o]);e.modal&&e.modal.hide()},e.screenview=function(){e.info.PrId.enabled=!e.form.AuId}}]).controller("ProjectStageController",["$scope","$state","$timeout","$ionicScrollDelegate","$stateParams","SharedProjectService",function(e,t,o,r,a,n){function i(){c.stages=[],s.getProjectStages(c.projectId).then(function(t){c.stagesList=t;for(var o={},r=0;r<t.length;r++){var a=t[r];a.statusChecked=a.checked_out?atrans("checkedout","Gereed"):atrans("active","Actief"),o[a.projectstage_id]=r,a.stage_has_children&&(a.children=[],a.showChildren=!1),0==a.stage_level?c.stages.push(a):t[o[a.stage_parent]].children.push(a)}0!=c.stages.length?e.$emit("showPhasesTab"):e.$emit("hidePhasesSlide"),c.stages.length==c.stagesList.length&&(e.$emit("hidePhasesToggle"),c.treeView=!1),o=null,c.loaded=!0})}var s=n.getProjectService(),c=this;c.treeView=!0,c.loaded=!1,c.projectId=e.$parent.projectId,i(),e.$on("toggleStages",function(e,t){c.changeView()}),e.$on("refreshChildControllers",function(t,o){c.treeView=!0,c.loaded=!1,c.projectId=e.$parent.projectId,i()}),c.changeView=function(){c.treeView=!c.treeView},c.toggleChildren=function(e){e.showChildren=!e.showChildren,r.$getByHandle("stages").resize()}}]);