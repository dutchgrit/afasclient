angular.module("search.controller",["AfasServices"]).controller("SearchController",["$scope","$state","$timeout","$ionicScrollDelegate","SearchService","SiteSearchService","ConnectorService","ContactServiceFactory","EnvConfigService","ConfigService",function(e,t,c,s,n,a,r,o,u,l){function i(){e.searchContactsBusy?(S&&c.cancel(S),S=c(function(){i(),S=null},100)):"undefined"!=typeof e.fetchData.query&&e.fetchData.query.length>=3?l.getConfig().then(function(t){-1!=t.modules.indexOf(3)&&(e.searchContactsBusy=!0,e.searchquery=e.fetchData.query,n.setSearchHistory(e.fetchData.query,"Search"),e.HideRecentSearches(),g.searchContacts(e.fetchData.query,0,20).then(function(t){g.loadContactImages(t),e.contactsresults=0,e.activeTab=0,0==e.fetchData.query.indexOf(e.searchquery)?(e.contacts=t,e.contactsresults=t.length):e.contacts=[]},function(){e.contacts=[],e.contactsresults=0})["finally"](function(){f()}))}):(e.contacts=[],e.contactsresults=0)}function h(){e.searchBusy?(m&&c.cancel(m),m=c(function(){h(),m=null},400)):"undefined"!=typeof e.fetchData.query&&e.fetchData.query.length>=4?l.getConfig().then(function(t){-1!=t.modules.indexOf(12)&&(e.searchBusy=!0,a.search(e.fetchData.query,50,{timeout:3e4,callback:function(){e.timeoutmessage=atrans("querynotspecific","De zoekopdracht is te algemeen. Verfijn de zoekopdracht om het aantal resultaten te beperken.")}}).then(function(t){if(e.docsresults=0,e.subjectsresults=0,0==e.fetchData.query.indexOf(e.searchquery)){e.searchresults=t;for(var c=0;c<t.length;c++)null==t[c].SubjectId&&t[c].IsDocument?e.docsresults++:null!=t[c].SubjectId&&(e.hasSubjects=!0,e.subjectsresults++)}else e.searchresults=[];e.subjectsresults>0&&0==e.contactsresults&&(e.activeTab=1),e.docsresults>0&&0==e.subjectsresults&&0==e.contactsresults&&(e.activeTab=2)},function(){e.searchresults=[],e.docsresults=0,e.subjectsresults=0})["finally"](function(){d()}))}):(e.searchresults=[],e.docsresults=0,e.subjectsresults=0)}function f(){s.$getByHandle("search").scrollTop(),e.searchContactsBusy=!1,e.$broadcast("scroll.refreshComplete")}function d(){s.$getByHandle("search").scrollTop(),e.searchBusy=!1,e.$broadcast("scroll.refreshComplete")}e.searchActive=!1,u.getEnvConfig().then(function(t){e.searchActive=1==t.searchactive});var g=o.getInstance();e.searchplaceholder=atrans("searchSearchplaceholder","Zoek op contacten, dossieritems en documenten.."),e.refreshText=atrans("refreshtext","Laat los om te verversen"),e.resultes=[],e.fetchData={};var y=null,S=null,m=null;e.pageTitle=atrans("search","Zoeken"),e.titleDocuments=atrans("docs","Zoeken"),e.activeTab=0,e.showTab=function(t){e.activeTab=t,s.$getByHandle("search").scrollTop()},e.$on("$ionicView.beforeEnter",function(){e.HideRecentSearches(),e.searchbusy=!1}),e.searchahead=function(){e.timeoutmessage="",c(function(){i()},100),e.searchActive&&(y&&c.cancel(y),y=c(function(){h(),y=null},1500))},e.search=function(){e.timeoutmessage="",e.activeTab=0,e.HideRecentSearches(),i(),e.searchActive&&h()},e.clearSearch=function(){e.fetchData.query="",e.contacts=[],e.searchresults=[],e.HideRecentSearches()},e.gotoResult=function(e){null!=e.SubjectId?t.go("menu.subject",{subjectId:e.SubjectId},{reload:!0}):null!=e.PageId?t.go("menu.document",{id:e.PageId,personal:0},{reload:!0}):null!=e.name&&t.go("menu.contact",{contactId:e.guid},{reload:!0})},e.ShowRecentSearches=function(){n.getSearchHistory("Search").then(function(t){e.recent=t})},e.HideRecentSearches=function(){c(function(){e.recent=0},100)},e.clickRecent=function(t){e.fetchData.query=t,e.search()},e.removeItem=function(e,t){e.preventDefault(),e.stopPropagation(),n.removeItem(t,"Search")}}]);