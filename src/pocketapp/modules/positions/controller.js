angular.module("positions.controller",["AfasServices"]).controller("PositionsController",["$scope","$state","uiGmapGoogleMapApi","ConfigService","UserService","ConnectionService","ConnectorService","EmployeeServiceFactory",function(e,t,o,n,i,a,r,s){function l(t,n){o.then(function(o){function s(e,t,o,n,i,a){this.type=e,this.latlng_=o,this.imageSrc=i,this.myself=t,this.employeeid=a,this.orgid=a,this.setMap(n)}s.prototype=new google.maps.OverlayView,s.prototype.update=function(e){this.latlng_=e,this.draw()},s.prototype.draw=function(){var t=this.div_;if(!t){if(t=this.div_=document.createElement("div"),0==this.type){t.className="customMarker",this.myself||(t.className+=" customMarkerOther");var o=document.createElement("img");o.src=this.imageSrc,t.appendChild(o);var n=this;google.maps.event.addDomListener(t,"click",function(t){google.maps.event.trigger(n,"click"),e.gotoEmployee(n.employeeid)})}else{if(t.className="customMarkerCompany",this.imageSrc){var o=document.createElement("img");o.src=this.imageSrc,t.appendChild(o)}var n=this;google.maps.event.addDomListener(t,"click",function(t){google.maps.event.trigger(n,"click"),e.gotoOrganization(n.orgid)})}var i=this.getPanes();i&&i.overlayImage.appendChild(t)}var a=this.getProjection();if(a){var r=a.fromLatLngToDivPixel(this.latlng_);r&&(t.style.left=r.x+"px",t.style.top=r.y+"px")}},s.prototype.remove=function(){this.div_&&(this.div_.parentNode.removeChild(this.div_),this.div_=null)},s.prototype.getPosition=function(){return this.latlng_};var l=n&&n.coords?new google.maps.LatLng(n.coords.latitude,n.coords.longitude):new google.maps.LatLng(52.143506699,5.4194623);e.Map=new google.maps.Map(t,{zoom:18,streetViewControl:!1,fullscreenControl:!1,scaleControl:!1,rotateControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,center:l}),lastBoundsJson=LocalStorage.getItem("lastBounds"),null!=lastBoundsJson&&boundsDeserialize(e.Map,lastBoundsJson),e.DirectionsService=new google.maps.DirectionsService,e.DirectionsRenderer=new google.maps.DirectionsRenderer,e.Map.addListener("bounds_changed",function(){null!=p&&(null!=c&&c.equals(e.Map.getBounds())||(c=e.Map.getBounds(),LocalStorage.setItem("lastBounds",boundsSerialize(e.Map)),e.refresh(!0)))}),e.refresh=function(t){SessionStorage.removeItem("lastTimeChecked"),a.testConnection()["finally"](function(){if(e.Map&&(navigator.geolocation.getCurrentPosition(function(o){var n=o&&o.coords?new google.maps.LatLng(o.coords.latitude,o.coords.longitude):new google.maps.LatLng(52.143506699,5.4194623);e.mymarker&&e.mymarker.update(n),t||e.Map.setCenter(n)},function(){},{maximumAge:6e4,timeout:500,enableHighAccuracy:!0}),!m)){m=!0;for(var o=0;o<e.markers.length;o++)e.markers[o].remove();e.markers=[];var n=e.Map.getBounds(),i=n.getNorthEast(),a=n.getSouthWest();r.getPositions(Math.min(i.lat(),a.lat()),Math.max(i.lat(),a.lat()),Math.min(i.lng(),a.lng()),Math.max(i.lng(),a.lng())).then(function(t){for(var o=0;o<t.length;o++){if(t[o].userid){var n=p[t[o].userid];n&&(n.position=t[o],n&&!n.imageUrl?r.getImageData(n.image_id,2).then(function(t){for(var o in p)if(p.hasOwnProperty(o)&&p[o].position&&p[o].image_id==t.key){p[o].imageUrl=t.url,e.markers.push(new s(0,!1,new google.maps.LatLng(p[o].position.latitude,p[o].position.longitude),e.Map,t.url,p[o].employee_id));break}}):e.markers.push(new s(0,!1,new google.maps.LatLng(n.position.latitude,n.position.longitude),e.Map,n.imageUrl,n.employee_id)))}t[o].orgid&&e.markers.push(new s(1,!1,new google.maps.LatLng(n.position.latitude,n.position.longitude),e.Map))}})["finally"](function(){m=!1})}})},i.getUser().then(function(t){return"undefined"!=typeof t.image_id?r.getImageData(t.image_id,1).then(function(o){e.mymarker=new s(0,!0,l,e.Map,o.url,t.employee_id)}):r.getFileData(t,"imagefileid","imagefilename").then(function(o){e.mymarker=new s(0,!0,l,e.Map,"data:"+o.mimetype+";base64,"+o.filedata,t.employee_id)})})})}var g=s.getInstance();e.markers=[];var m=!1,c=null,p=null;g.getEmployees(-1,-1).then(function(t){if(p={},t&&t.length>0){for(var o=0;o<t.length;o++)p[t[o].user_id]=t[o];e.refresh&&e.refresh()}}),e.form={};var u=document.getElementById("positionsMap");u&&navigator.geolocation.getCurrentPosition(function(e){l(u,e)},function(){l(u)},{maximumAge:6e4,timeout:500,enableHighAccuracy:!0}),e.$on("$ionicView.beforeEnter",function(){null!=p&&e.refresh&&e.refresh()}),e.gotoEmployee=function(e){n.getConfig().then(function(o){modules=o.modules,-1!=modules.indexOf(11)&&t.go("menu.employee",{id:e})})}}]);