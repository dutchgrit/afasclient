angular.module("businesscard.controller",["AfasServices"]).controller("BusinesscardController",["$scope","$state","ConfigService","UserService","EnvConfigService","SharedEmployeeService","PictureService","PersonServiceFactory","ConnectorService","$ionicTabsDelegate","$ionicActionSheet","$timeout",function(e,o,i,n,t,a,r,l,c,s,f,d){function m(e){function o(e,o){if("kl-kl"==currentLanguage&&"undefined"!=typeof cordova&&"undefined"!=typeof cordova.plugins.Klingonize&&-1!=o.indexOf(";base64")){var i=o.substring(0,o.indexOf(";base64,")),n=o.substring(o.indexOf(";base64,")+8);cordova.plugins.Klingonize.klingonize(i,n).then(function(o){e.imageUrl="data:"+i+";base64,"+o,"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()})}else e.imageUrl=o}return"undefined"!=typeof e.user.image_id?c.getImageData(e.user.image_id,1).then(function(i){return LocalStorage.setItem("lastUserImageFileId",e.user.imagefileid),o(e,i.url),c.getImageData(e.user.image_id,2).then(function(i){o(e,i.url)})}):c.getFileData(e.user,"imagefileid","imagefilename").then(function(i){LocalStorage.setItem("lastUserImageFileId",e.user.imagefileid),o(e,"data:"+i.mimetype+";base64,"+i.filedata)})}e.loaded=!1,e.pageTitle=atrans("myprofiledata","Mijn gegevens"),e.tabTitle0=atrans("myprofilebuss","Zakelijk"),e.tabTitle1=atrans("myprofilepriv","Persoonlijk"),e.empmut=!1,e.imageUrl="img/man.png";var u=l.getInstance(),p=a.getEmployeeService(),h={EmployeeService:p};n.getUser().then(function(o){i.getConfig().then(function(i){isVersionOrHigher(i,"Profit11")&&o.employee_id&&(o.date_end_arv?new Date(o.date_end_arv)>new Date&&(e.empmut=!0):o.employer_id?e.empmut=!0:e.empmut=!1,e.empmut&&t.getEnvConfig().then(function(o){e.envConfig=o,e.empmut4=e.envConfig.profileinfo[4]>0,e.empmut5=e.envConfig.profileinfo[5]>0,e.empmut13=e.envConfig.profileinfo[13]>0}))})}),e.$on("$ionicView.enter",function(){n.refresh().then(function(o){e.user=o,isNotEmpty(e.user.nickname)&&(e.user.name=e.user.nickname,isNotEmpty(e.user.middle_name)&&(e.user.name+=" "+e.user.middle_name),e.user.name+=" "+e.user.last_name),e.prefix=atrans("prefmale","de heer"),null!=o&&"V"==o.gender&&(e.prefix=atrans("preffemale","mevrouw"),"img/man.png"==e.imageUrl&&(e.imageUrl="img/woman.png")),o.imagefileid&&(LocalStorage.getItem("lastUserImageFileId")!=o.imagefileid||"img/man.png"==e.imageUrl||"img/woman.png"==e.imageUrl)&&m(e),i.getConfig().then(function(o){isVersionOrHigher(o,"Profit11")&&c.executeGet("Pocket_Salary_Account",{},0,1).then(function(o){o&&o.length>0&&(e.salaryaccount=o[0].IBAN)})}),c.getQrFileDataUrl(o).then(function(o){e.qrImageUrl=o})})["finally"](function(){e.loaded=!0})}),e.showPhotoActions=function(){var o=new Array;o.push({text:"<i class='icon iconHide'></i>"+atrans("takephoto","Maak een foto")+"</span>"}),o.push({text:"<i class='icon iconHide'></i>"+atrans("choosefile","Kies bestand")+"</span>"}),d(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),f.show({buttons:o,titleText:atrans("uploadfoto","Upload foto"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(o){return 0==o?e.photo(1):1==o&&e.photo(0),!0}})},e.photo=function(o){var i=document.querySelector("#profilepic");r.getPicture(o).then(function(o){i.classList.remove("expandpic"),i.classList.add("shrinkpic"),u.updatePersonImage(e.user,o).then(function(){n.getUser().then(function(o){e.user=o,m(e).then(function(){i.classList.remove("shrinkpic"),i.classList.add("expandpic")})})})})},e.selectMutType=function(i){SearchService.setRecentlySelected(i,"recent_mut_profiles"),i.type=e.type,o.go("menu.menu.empmut",{mutprofile:i,imageUrl:e.imageUrl},{reload:!0}),e.modal&&e.modal.hide()},e.$on("$ionicSlides.sliderInitialized",function(o,i){e.slider=i.slider}),e.$on("$ionicSlides.slideChangeStart",function(e,o){d(function(){s.$getByHandle("tabprofile").select(o.slider.activeIndex)},1)}),e.selectMainTab=function(o){e.slider&&e.slider.activeIndex!=o&&e.slider.slideTo(o)},e.scrollMainTop=function(){$ionicScrollDelegate.$getByHandle("profilebus").scrollTop(!0),$ionicScrollDelegate.$getByHandle("profilepriv").scrollTop(!0)},e.edit=function(i){function n(n){d(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),f.show({buttons:n,titleText:atrans("mutprofile","Kies mutatie profiel"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(t){n[t].mutProfile.type=i,o.go("menu.empmut",{mutprofile:n[t].mutProfile,imageUrl:e.imageUrl},{reload:!0})}})}SessionStorage.removeItem("mutpin"),e.type=i,e.envConfig.profileinfo[i]&&e.envConfig.profileinfo[i]>0&&(e.envConfig.profileinfo[i]>5?e.openModal():p.searchProfiles("",0,6,i).then(function(t){if(0==t.length);else if(1==t.length)t[0].type=i,o.go("menu.empmut",{mutprofile:t[0],imageUrl:e.imageUrl},{reload:!0});else{for(var a=[],r=0;r<t.length;r++)a.push({text:"<i class='icon iconHide'></i>"+t[r].Description,mutProfile:t[r]});n(a)}}))},e.openModal=function(){ModalSearchService.openModal(e,"Pocket_MutProfiles",h)},e.closeModal=function(){e.modal.hide()},e.showhide=function(){e.hidden=!e.hidden},e.search=function(o){ModalSearchService.search(e,o,h)},e.loadMore=function(){ModalSearchService.loadMore(e,h)},e.clearSearch=function(){ModalSearchService.clearSearch(e)},e.clickRecent=function(o){e.modal.query=o,ModalSearchService.search(e,o,h)},e.ShowRecentSearches=function(){ModalSearchService.ShowRecentSearches(e)},e.HideRecentSearches=function(){ModalSearchService.HideRecentSearches(e)}}]).controller("EmpMutController",["$scope","$state","$ionicScrollDelegate","$timeout","$ionicModal","$ionicPopup","ConnectorService","ConfigService","$ionicActionSheet","$rootScope","PictureService","SearchService","SharedEmployeeService","UserService","ModalSearchService","maxListTake","uiGmapGoogleMapApi",function(e,o,i,n,t,a,r,l,c,s,f,d,m,u,p,h,g){function v(){l.getConfig().then(function(o){isVersionOrHigher(o,"Profit15")&&(e.multipleattach=!0)})}function y(){var o={zoom:16,center:e.fromResult.geometry.location};e.Map.setZoom(o.zoom),e.Map.setCenter(o.center),e.DirectionsRenderer.setMap(e.Map);var t={origin:e.fromResult.place_id?{placeId:e.fromResult.place_id}:e.fromResult.geometry.location,destination:e.toResult.place_id?{placeId:e.toResult.place_id}:e.toResult.geometry.location,optimizeWaypoints:!0,durationInTraffic:!1,provideRouteAlternatives:!0,travelMode:google.maps.TravelMode.DRIVING};e.DirectionsService.route(t,function(o,t){if(t==google.maps.DirectionsStatus.OK){for(var a=0,r=0,l=0,c=0,s=0;s<o.routes.length;s++)0==s&&(r=o.routes[0].legs[0].distance.value,c=o.routes[0].legs[0].duration.value),o.routes[s].legs[0].distance.value<r&&(r=o.routes[s].legs[0].distance.value,a=s),o.routes[s].legs[0].duration.value<c&&(c=o.routes[s].legs[0].duration.value,l=s);var f="1"==e.fastestroute?l:a;o.routes[0]=o.routes[f],e.DirectionsRenderer.setDirections(o),e.form.distance=o.routes[f].legs[0].distance.value/1e3,e.form.distanceshow=o.routes[f].legs[0].distance.value/1e3,e.form.duration=" ("+o.routes[f].legs[0].duration.text+")",e.form.KmCa=e.form.distance,e.form.KmWW=e.form.distance,n(function(){e.$apply()}),i.$getByHandle("map").scrollBottom(!0)}})}var b,I=m.getEmployeeService(),S={EmployeeService:I},w=o.params.mutprofile;e.imageUrl="img/man.png",e.multipleattach=!1,e.pageTitle=atrans("mut","Mutatie"),e.attachment_type="",e.setupFile=function(o){document.getElementById("fileBrowser").onchange=function(i){e.filePickedGeneric(i,o,e)}},e.$on("$ionicView.beforeEnter",function(){null==SessionStorage.getItem("mutpin")?(SessionStorage.setItem("hasEnteredPin","0"),o.go("pin",{},{reload:!0})):(w=o.params.mutprofile,w&&(e.type=w.type,e.title=w.Description),o.params.action&&(e.subjectId=o.params.action.subjectid,w={Description:atrans("edit","Aanpassen"),Id:o.params.action.profileid},e.title=w.Description,e.type=o.params.action.profiletype),e.imageUrl=o.params.imageUrl,e.info=null,e.form={},e.form.errorfld={},e.form.attachments=[],e.infoLoaded=!1,null!=w?(e.profileId=w.Id,i.resize(),u.getUser().then(function(o){I.getMutationInfo(w.Id,e.type,e.subjectId).then(function(i){13==e.type&&(i.TRe={ctype:1,defaultvalue:"",description:"",dtype:10,element:"HrEmpMutInsite",enabled:!0,extvalue:"",filter:"",inputcorrection:"",label:atrans("reasonmut","Reden mutatie"),mandatory:!0,message:"",value:"",visible:!0}),parseInfo(e,i,o,!1,"validateEntry"),e.screenview(),v(),e.form.DaBe||(e.form.DaBe=new Date),!e.imageUrl&&e.info.Img&&e.info.Img.value&&e.info.Img.visible&&r.getImageData(e.info.Img.value,1).then(function(o){e.imageUrl=o.url})},function(){e.previousPage()})["finally"](function(){e.infoLoaded=!0})})):(e.infoLoaded=!0,e.previousPage()))}),e.showPhotoActions=function(){var o=new Array;o.push({text:"<i class='icon iconHide'></i>"+atrans("takephoto","Maak een foto")+"</span>"}),o.push({text:"<i class='icon iconHide'></i>"+atrans("choosefile","Kies bestand")+"</span>"}),n(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),c.show({buttons:o,titleText:atrans("uploadfoto","Upload foto"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(o){return 0==o?e.photoEmp(1):1==o&&e.photoEmp(0),!0}})},e.addAttachment=function(o){e.showFileActionsGeneric(o,e)},e.showAttachment=function(o){o?"img"==o.type&&e.showImage(o.src):e.file_attached&&"img"==e.attachment_type&&e.showImage(document.getElementById("profilepic").src)},e.deleteAttachment=function(o){if(o){if(""!=o.src&&e.file_attached){var i=e.form.attachments.indexOf(o);-1!=i&&e.form.attachments.splice(i,1)}}else""!=document.getElementById("profilepic").src&&e.file_attached&&confirm(atrans("deletedeclarationphoto","Wil je deze foto verwijderen?"))&&(e.file_attached=!1,e.form.fileURI=void 0,document.getElementById("fileBrowser").form.reset(),document.getElementById("declaration_attachment").src="")},e.photoEmp=function(o){f.getPicture(o).then(function(o){return r.uploadFileByUrl("HrEmpMutInsite",o).then(function(i){if(e.form.FileId=i.fileids[0],e.form.Img=null,o&&-1!=o.indexOf(";base64"))e.imageUrl=o,"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply();else{var n=new XMLHttpRequest;n.open("GET",o,!0),n.responseType="blob",n.onload=function(){var o=new FileReader;o.onload=function(){e.imageUrl=o.result,"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()},o.readAsDataURL(n.response)},n.send()}})})},e.goToDistance=function(){e.form.from=e.form.Ad+" "+e.form.HmNr+" "+e.form.ZpCd+" "+e.form.Rs.id,e.form.KmTo&&(e.form.to=e.form.KmTo),e.distanceModal?e.distanceModal.show():(e.toText=atrans("chooselocation","Kies locatie"),e.modalTitle=atrans("calculatedistancetitle","Afstand berekenen"),e.fromResult=null,e.toResult=null,e.hideFrom=!0,e.hideRetour=!0,e.calculated=!1,t.fromTemplateUrl("modules/declarations/calculatedistance.html",{scope:e,animation:"slide-in-up"}).then(function(o){l.getConfig().then(function(i){e.distanceModal=o,e.distanceModal.show(),n(function(){g.then(function(i){var n=o.modalEl.getElementsByClassName("distanceMapItem")[0];e.Map=new google.maps.Map(n,{zoom:7,center:new google.maps.LatLng(52.143506699,5.4194623)}),e.DirectionsService=new google.maps.DirectionsService,e.DirectionsRenderer=new google.maps.DirectionsRenderer,e.GeoCoder=new google.maps.Geocoder})},400)})}))},e.closeDistanceModal=function(){e.distanceModal.hide()},e.distancechange=function(){e.form.distance=e.todigits(e.form.distance),e.form.distance>0&&(e.form.KmCa=e.form.distance,e.form.KmWW=e.form.distance)},e.calculate=function(){e.GeoCoder.geocode({address:e.form.from,region:"NL"},function(o,i){i==google.maps.GeocoderStatus.OK&&o.length>0&&(e.fromResult=o[0],e.GeoCoder.geocode({address:e.form.to,region:"NL"},function(o,i){i==google.maps.GeocoderStatus.OK&&o.length>0&&(e.toResult=o[0],y(),e.calculated=!0,e.from=e.form.from,e.to=e.form.to,e.info&&e.form&&(e.form.KmTo=e.form.to))}))})},e.setDistance=function(){e.closeDistanceModal()},e.todigits=function(e){return e},e.selectItem=function(o){e.form[o.fieldId]={id:o._id,name:o._name},e.form[o.fieldId+"_entry"]=o._id,d.setRecentlySelected(o,"recent_subj_"+e.info.type+"_"+o.fieldId),e.form.errorfld[o.fieldId]="";for(var i in o)o.hasOwnProperty(i)&&-1!=i.indexOf("_fixed_")&&(e.form[o.fieldId][i]=o[i]);e.form.errorfld[o.fieldId]="",e.screenview(),e.modal&&e.modal.hide()},e.postMutation=function(){e.form.errorfld={},e.haserror=!1,I.postMutation(e).then(function(){a.alert({title:atrans("successmut","Insturen mutatie gelukt! "),template:atrans("muttextsuccess","Je wijzigen zijn zichtbaar na goedkeuring door je leidinggevende en/of HR afdeling.")}),e.previousPage()})},e.screenview=function(){if(e.info&&(e.info.EmAdZ10&&(e.info.EmAdZ10.enabled=e.form.PsPv&&("E"==e.form.PsPv.id||"B"==e.form.PsPv.id)||e.form.YsPv&&("E"==e.form.YsPv.id||"B"==e.form.YsPv.id)),e.info.SeAt&&(e.info.SeAt.enabled=e.form.PsPv&&("E"==e.form.PsPv.id||"B"==e.form.PsPv.id)||e.form.YsPv&&("E"==e.form.YsPv.id||"B"==e.form.YsPv.id),e.info.TPwEm1.enabled=e.form.SeAt,e.info.TPwEm2.enabled=e.form.SeAt),e.info.ViCs&&e.info.DaMa&&(e.info.DaMa.visible=e.form.ViCs&&"GH"==e.form.ViCs.id),e.info.ViCs&&e.info.DaDi&&(e.info.DaDi.visible=e.form.ViCs&&"GS"==e.form.ViCs.id),e.info.CaPa))if(e.form.CaPa)e.info.CoId.enabled=!1,e.info.CoId.mandatory=!1,e.info.BkTp.enabled=!1,e.info.BkTp.mandatory=!1,e.info.BkIc.enabled=!1,e.info.BkIc.mandatory=!1,e.info.BaAc.enabled=!1,e.info.BaAc.mandatory=!1,e.info.DiNm.enabled=!1,e.info.DiPl.enabled=!1,e.info.DiPl.enabled=!1,e.info.Ds.enabled=!1,e.info.BaNm.enabled=!1,e.info.BaFi.enabled=!1,e.info.BaAd.enabled=!1,e.info.CalM.enabled=!1,e.info.CalM.mandatory=!1,e.info.DsTp.enabled=!1,e.info.Iban.enabled=!1,e.info.Iban.mandatory=!1;else{e.info.CoId.enabled=!0,e.info.CoId.mandatory=!0;var o=e.form.IbCk;o?(e.info.BkTp.enabled=!0,e.info.BkTp.mandatory=!1):(e.info.BkTp.enabled=!0,e.info.BkTp.mandatory=!0),e.form.CoId&&("AW"==e.form.CoId.id||"BQ"==e.form.CoId.id||"CW"==e.form.CoId.id||"NA"==e.form.CoId.id||"SX"==e.form.CoId.id?(e.info.BkIc.enabled=!0,e.info.BkIc.mandatory=!0):(e.info.BkIc.enabled=!1,e.info.BkIc.mandatory=!1)),e.info.Iban.enabled=o,e.info.Iban.mandatory=o,e.info.BaAc.enabled=!o,e.info.BaAc.mandatory=!o,e.info.DiNm.enabled=!0,e.info.DiPl.enabled=!0,e.info.Ds.enabled=!0,e.info.BaNm.enabled=!0,e.info.BaFi.enabled=!0,e.info.BaAd.enabled=!0,e.info.CalM.enabled=!0,e.info.CalM.mandatory=!0,e.info.DsTp.enabled=!0}},e.openModalforField=function(o){if(S.fieldId=o,S.info=e.info,S.form=e.form,e.info[o]){if(S.searchview=e.info[o].searchview,S.searchview.filter=e.info[o].filter,S.searchview.fromfieldId1){var i=S.searchview.fromfieldId1;S.searchview.fieldValue2=formvalue(e.form[i],e.info[i])}else e.form[S.searchview.fieldId2]&&(S.searchview.fieldValue2=formvalue(e.form[S.searchview.fieldId2],e.info[S.searchview.fieldId2]));if(S.searchview.fromfieldId2){var n=S.searchview.fromfieldId2;S.searchview.fieldValue3=formvalue(e.form[n],e.info[n])}else e.form[S.searchview.fieldId3]&&(S.searchview.fieldValue3=formvalue(e.form[S.searchview.fieldId3],e.info[S.searchview.fieldId3]))}else{for(var t in e.info.custom)if(e.info.custom.hasOwnProperty(t)&&e.info.custom[t][o]){S.searchview=e.info.custom[t][o].searchview;break}for(var t in e.info.customZ10)if(e.info.customZ10.hasOwnProperty(t)&&e.info.customZ10[t][o]){S.searchview=e.info.customZ10[t][o].searchview;break}}p.openModal(e,"Pocket_MutationFields",S)},e.closeModal=function(){s.currentModal=null,e.modal.hide()},e.search=function(o){p.search(e,o,S)},e.loadMore=function(){p.loadMore(e,S)},e.clearSearch=function(o){p.clearSearch(e)},e.clickRecent=function(o){e.modal.query=o,p.search(e,o,S)},e.ShowRecentSearches=function(){p.ShowRecentSearches(e,S)},e.HideRecentSearches=function(){p.HideRecentSearches(e)},e.selectTab=function(o){e.modal&&!e.modal.loading&&(e.modal.showType=o)},e.validateEntryDelayed=function(o,i,t){b&&n.cancel(b),b=n(function(){b=null,e.validateEntry(o,i,t)},t?100:800)},e.validateEntry=function(o,i,n){if(e.form[i]=null,"S_Bc"==i&&e.info.S_Cd&&(e.info.S_Cd.visible=!0),"string"!=typeof o&&(o=String(o)),o.length>0){if(e.form[i]={id:o},S.fieldId=i,e.info[i])S.searchview=e.info[i].searchview;else{for(var t in e.info.custom)if(e.info.custom.hasOwnProperty(t)&&e.info.custom[t][i]){S.searchview=e.info.custom[t][i].searchview;break}for(var t in e.info.customZ10)if(e.info.customZ10.hasOwnProperty(t)&&e.info.customZ10[t][i]){S.searchview=e.info.customZ10[t][i].searchview;break}}S.info=e.info,S.form=e.form,S.onlyId=!0,I.searchForField(S,o,0,h).then(function(i){for(var n=i.rows,t=0;t<n.length;t++)if(n[t]._id==o)return void e.selectItem(n[t]);n&&n.length>0&&e.selectItem(n[0])})["finally"](function(){n&&n()})}else n&&n()},e.validateEntry2Delayed=e.validateEntryDelayed,e.validateEntry2=e.validateEntry,e.addAttachment2=function(o){e.showFileActionsGeneric(o,e)},e.showAttachment2=function(o){o?"img"==o.type&&e.showImage(o.src):e.file_attached&&"img"==e.attachment_type&&e.showImage(document.getElementById("declaration_attachment").src)},e.deleteAttachment2=function(o){if(o&&""!=o.src&&e.file_attached){var i=e.form.attachments.indexOf(o);-1!=i&&e.form.attachments.splice(i,1)}},e.setupFile2=function(o){document.getElementById("fileBrowser").onchange=function(i){e.filePickedGeneric(i,o,e)}}}]);