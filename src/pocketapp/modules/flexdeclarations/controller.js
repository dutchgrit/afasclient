angular.module("flexdeclaration.controller",["AfasServices"]).factory("SharedFlexdeclarationService",["FlexdeclarationServiceFactory",function(e){var t=e.getInstance();return{getFlexdeclarationService:function(){return t}}}]).controller("FlexdeclarationsController",["$scope","$state","$stateParams","$ionicPopover","$timeout","$ionicScrollDelegate","$ionicTabsDelegate","$ionicSlideBoxDelegate","$ionicActionSheet","$ionicPopup","ListServiceFactory","ModalFilterService","SharedFlexdeclarationService","ConfigService","SearchService","maxListTake","ConnectorService","MultipleViewsManager","EnvConfigService","ModalSearchService","PlacementServiceFactory","UserService","TimesheetServiceFactory",function(e,t,a,o,n,l,r,c,s,d,u,f,p,m,y,g,h,w,S,b,v,x,R){function F(){return{ctype:4,defname:"date_booked",dtype:8,id:"date_booked",name:atrans("bookingsdate","Boekingsdatum")}}function k(t){t.loading=!0;var a=SessionStorage.getItem(t.sessionStorageString);if(null!=a&&""!=a&&"undefined"!=a)var o=JSON.parse(a);if(t.placements){if(t.placements.length>1&&(t.multiplepctshow=!0),o)for(i=0;i<t.placements.length;i++)o.placement_id==t.placements[i].placement_id&&(e.changePlacement(t.placements[i],t),t.chooseplacement=!1);!t.pctsel&&t.placements.length>0&&e.changePlacement(t.placements[0],t),t.loading=!1}else t.placements||(t.loading=!0,t.searched=!1,D.getPlacements(-1,-1,t.mode).then(function(a){if(t.placements=a,a.length>1){if(t.multiplepctshow=!0,o)for(i=0;i<a.length;i++)if(t.pctsel&&a[i].placement_id==t.pctsel.placement_id){e.changePlacement(a[i],t),t.chooseplacement=!1;break}}else 1!=a.length||t.pctsel||(t.pctsel=a[0]);!t.pctsel&&t.placements.length>0&&e.changePlacement(a[0],t),I(t.mode),t.loading=!1}))}function I(a){"1"==SessionStorage.getItem("ReloadFlexDeclarations")&&(SessionStorage.setItem("ReloadFlexDeclarations","0"),e.forceRefresh=!0);var o=e.tabs[a];o.loading=!0,o.searched=!1;var n=o.orderBy?o.orderBy.id:null;if(!o.pctsel){var i=SessionStorage.getItem(o.sessionStorageString);null!=i&&""!=i&&"undefined"!=i&&(o.pctsel=JSON.parse(i))}o.pctsel?(o.chooseplacement=!1,T.getReaDeclarations(o.mode,o.pctsel,e.forceRefresh).then(function(a){e.forceRefresh=!1,o.reaDeclarations=a,T.getFlexdeclarations(0,g,o.mode,n,o.orderByDir,o.query,o.searchField,o.pctsel).then(function(t){o.loaded=t.rows.length,o.fields=t.deffields,Array.prototype.push.apply(o.fields,t.fields),o.orderByHeader&&(t.rows=$.handleHeaders(t.rows,o.orderBy)),o.declarations=t.rows,o.searched=!0,o.showmore=o.loaded>=g,e.$broadcast("scroll.refreshComplete")})["finally"](function(){if(o.loading=!1,e.newReaRowId>0){var a=e.newReaRowId;e.newReaRowId=0,T.getSingleReaRow(a).then(function(e){if(e){var a={id:"",code:"",mode:o.mode,year:e.year,period:e.period,periodtable:e.periodtable,editmode:!0,placement:o.pctsel};w.isActive()?w.updateView("flexdeclarations-detail",a):t.go("menu.flexdeclaration",a)}})}})})):(o.loading=!1,o.chooseplacement=!0)}var T=p.getFlexdeclarationService(),D=v.getInstance(),$=u.getInstance(),L=R.getInstance(),C="Flexdeclarations",B={FlexdeclarationService:T};e.pageTitle=atrans("flexdeclarations","Declaraties"),e.searchplaceholder=atrans("flexdeclarationsplaceholder","Zoek op declaraties"),e.refreshText=atrans("refreshtext","Laat los om te verversen"),e.favorites=null,e.form={},e.showNewReaRow=!0,e.newReaRowId=0,e.tabs=[{name_id:"tabActual",mode:0,title:atrans("actualflexdeclarations","Actueel"),sessionStorageString:"pctselact"},{name_id:"tabPayed",mode:1,title:atrans("payedflexdeclarations","Uitbetaald"),sessionStorageString:"pctselall"}],e.tabs.map(function(t,a){t.loading=!1,t.searched=!1,t.query=null,t.searchField=JSON.parse(LocalStorage.getItem("Flexdeclarations"+a+"searchField"))||null;var o=LocalStorage.getItem("Flexdeclarations"+a+"searchFieldName");return t.searchPlaceHolder=o?atrans("searchgen","Zoek op {0}",o):e.searchplaceholder,t.orderBy=JSON.parse(LocalStorage.getItem("Flexdeclarations"+a+"sortfield"))||F(),t.orderByHeader=t.orderBy?$.controlDataTypeAllowsHeader(t.orderBy.ctype,t.orderBy.dtype):!1,t.orderByDir=parseInt(LocalStorage.getItem("Flexdeclarations"+a+"sortdir")||"0",10),t.orderByDirName=0==t.orderByDir?"Z-A":"A-Z",t}),e.scrollTop=function(){l.$getByHandle("flexdeclarations").scrollTop(!0)},e.$on("$ionicView.enter",function(){var t=e.tabs[0];k(t),I(0)}),e.$on("$ionicView.beforeEnter",function(){if(e.landscape=e.isLandscape(),S.getEnvConfig().then(function(t){e.showNewFlexdeclaration=t.profileinfo[24]&&t.profileinfo[24]>0}),w.isActive()){var t=e.tabs[0];k(t),I(0)}L.loadEntryLayouts(e,!0)["finally"](function(){e.sel&&e.sel.selectedLayout&&(e.maySelectLayout=e.sel.entryLayouts&&e.sel.entryLayouts.length>1,e.mayShowOptions=e.maySelectLayout)})}),e.selectLayout=function(){L.loadEntryLayouts(e,!0,!0)["finally"](function(){e.sel&&e.sel.selectedLayout?(e.maySelectLayout=e.sel.entryLayouts.length>0,e.canBookCosts=e.sel.selectedLayout.info.settingFields.Cost.value,e.mayShowOptions=e.maySelectLayout||e.sel.selectedLayout.info.actions.length>0):e.mayShowOptions=!1})},e.$on("$ionicView.unloaded",function(){e.slider=void 0}),e.loadMoreFlexdeclarations=function(t){var a=e.tabs[t];if(!a.loading){a.loading=!0;var o=a.orderBy?a.orderBy.id:null;T.getFlexdeclarations(a.loaded,g,a.mode,o,a.orderByDir,a.query,a.searchField,a.pctsel).then(function(t){a.showmore=a.loaded!=t.rows.length,a.loaded=t.rows.length,a.orderByHeader&&(t.rows=$.handleHeaders(t.rows,a.orderBy)),a.declarations=t.rows,e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){a.loading=!1,l.$getByHandle("flexdeclarations").resize(),e.$broadcast("scroll.refreshComplete")})}},e.refresh=function(t){k(e.tabs[e.slider.activeIndex]),I(t)},e.goToPlacement=function(e){m.getConfig().then(function(a){-1!=a.modules.indexOf(24)&&(w.isActive()?w.updateView("placements-detail",{placementId:e,mode:0}):t.go("menu.placement",{placementId:e,mode:0}))})},e.gotoReaDeclarations=function(a,o){var n=e.tabs[e.slider.activeIndex],i=a._id?a._id:0;e.selectedFlexdeclaration=i,e.year=a.year,e.period=a.period,o||3!==a.status||(o=!0),w.isActive()?w.updateView("flexdeclarations-detail",{id:i,code:a.declaration,mode:n.mode,year:a.year,period:a.period,periodtable:a.periodtable,editmode:o,placement:n.pctsel}):t.go("menu.flexdeclaration",{id:i,code:a.declaration,mode:n.mode,year:a.year,period:a.period,periodtable:a.periodtable,editmode:o,placement:n.pctsel})},e.selectFlexdeclarationType=function(a){y.setRecentlySelected(a,"recent_flexdeclaration_profiles"),t.go("menu.newflexdeclaration",{flexdeclarationprofile:a},{reload:!0}),e.modal&&e.modal.hide()},e.$on("$ionicSlides.sliderInitialized",function(t,a){e.slider=a.slider,r.$getByHandle("tabsflexdeclarations").select(0),e.slider.lockSwipes()}),e.$on("$ionicSlides.slideChangeStart",function(e,t){n(function(){r.$getByHandle("tabsflexdeclarations").select(t.slider.activeIndex)},1)}),e.selectFlexdeclarationsTab=function(t){e.slider&&e.slider.activeIndex!=t&&(e.slider.unlockSwipes(),e.slider.slideTo(t),e.slider.lockSwipes(),e.refresh(t))},e.searchFlexdeclarations=function(t){var a=e.tabs[t].query;if(0==a.length)e.clearSearchFlexdeclarations(t);else{e.tabs[t];y.setSearchHistory(a,C),l.$getByHandle("flexdeclarations").scrollTop(!0),I(t),hideKeyboard(),e.HideRecentFlexdeclarationSearches()}},e.ShowRecentFlexdeclarationSearches=function(){y.getSearchHistory(C).then(function(t){e.recent=t})},e.HideRecentFlexdeclarationSearches=function(){n(function(){e.recent=0},100)},e.clickRecentFlexdeclarations=function(t,a){var o=e.tabs[t];o.query=a,e.searchFlexdeclarations(t)},e.removeItemFlexdeclarations=function(e,t){e.preventDefault(),e.stopPropagation(),y.removeItem(t,C)},e.clearSearchFlexdeclarations=function(t){var a=e.tabs[t];a.query="",e.HideRecentFlexdeclarationSearches(),a.flexdeclarations=null,a.loaded=0,e.refresh(t)},e.openModalQuery=function(t,a){var o=e.tabs[e.slider.activeIndex],n=o.orderBy?o.orderBy.id:null;f.openModal(e,o.fields,o.orderByDir,o.searchField,n)},e.selectModalTab=function(t){e.modal&&(e.modal.showType=t)},e.selectModalSearchField=function(t){var a=e.slider.activeIndex;LocalStorage.setItem("Flexdeclarations"+a+"searchField",JSON.stringify(t)),LocalStorage.setItem("Flexdeclarations"+a+"searchFieldName",t.name),e.tabs[a].searchField=t,e.tabs[a].searchPlaceHolder=atrans("searchgen","Zoek op {0}",t.name),e.modal&&n(function(){e.modal.hide()},200)},e.selectModalSortField=function(t){var a=e.slider.activeIndex;LocalStorage.setItem("Flexdeclarations"+a+"sortfield",JSON.stringify(t)),e.tabs[a].orderBy=t,e.tabs[a].orderByHeader=$.controlDataTypeAllowsHeader(t.ctype,t.dtype),e.modal&&n(function(){e.modal.hide()},200),I(a)},e.pickdir=function(t){var a=e.slider.activeIndex;e.modal.sortDir=t,LocalStorage.setItem("Flexdeclarations"+a+"sortdir",t),e.tabs[a].orderByDir=t,e.tabs[a].orderByDirName=0==t?"Z-A":"A-Z",e.tabs[a].orderBy&&e.modal&&(n(function(){e.modal.hide()},200),I(a))},e.reverseSortDirection=function(){var t=e.slider.activeIndex,a=e.tabs[t],o=0==a.orderByDir?1:0;LocalStorage.setItem("Flexdeclarations"+t+"sortdir",o),a.orderByDir=o,a.orderByDirName=0==o?"Z-A":"A-Z",I(t),e.scrollTop()},e.openModalProfile=function(){b.openModal(e,"Pocket_FlexdeclarationProfiles",B)},e.search=function(t){b.search(e,t,B)},e.selectTab=function(t){e.modal&&!e.modal.loading&&(e.modal.showType=t)},e.loadMore=function(){b.loadMore(e,B)},e.clearSearch=function(t){b.clearSearch(e)},e.clickRecent=function(t){e.modal.query=t,b.search(e,t,B)},e.ShowRecentSearches=function(){b.ShowRecentSearches(e)},e.HideRecentSearches=function(){b.HideRecentSearches(e)},e.closeModal=function(){e.modal.hide()},e.showhide=function(){e.hidden=!e.hidden},o.fromTemplateUrl("popoverOptions.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.changePlacement=function(t,a){t?(a.pctsel||!a.pctsel||t.placement_id!=a.pctsel.placement_id)&&(a.previousPct=t,a.pctsel=t,e.forceRefresh=!0):(a.previousPct&&a.pctsel?a.previousPct.placement_id!=a.pctsel.placement_id&&(e.forceRefresh=!0):a.previousPct||(e.forceRefresh=!0),a&&(a.previousPct=a.pctsel)),"1"==SessionStorage.getItem("ReloadFlexDeclarations")&&(SessionStorage.setItem("ReloadFlexDeclarations","0"),e.forceRefresh=!0),SessionStorage.setItem(a.sessionStorageString,JSON.stringify(a.pctsel)),a.chooseplacement=!1,e.forceRefresh===!0&&I(e.slider.activeIndex)},e.newReaRow=function(a){L.loadEntryLayouts(e,!0)["finally"](function(){function a(a){n(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500);var o=e.tabs[e.slider.activeIndex];o.pctsel&&s.show({buttons:a,titleText:atrans("book","Boeken"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(n){x.getUser().then(function(i){var l={type:a[n].type,date:new Date,defaultFields:{EmId:{value:o.pctsel.employee_id,description:o.pctsel.employee_id},PcId:{value:o.pctsel.placement_id,extvalue:o.pctsel.placement_code,description:o.pctsel.organisation?o.pctsel.organisation:o.pctsel.description}},callback:function(t){SessionStorage.setItem("ReloadFlexDeclarations","1"),e.newReaRowId=t,e.previousPage()},skipFields:["PrId"]};t.go("menu.timesheetswizard",{selection:l},{reload:!0})})}})}if(e.sel&&e.sel.selectedLayout){var o=e.sel.selectedLayout.info.settingFields.Cost.value,i=new Array({text:"<i class='icon iconHide'></i>"+atrans("bookinghours","Uren"),id:0,type:1});o&&i.push({text:"<i class='icon iconHide'></i>"+atrans("bookingcosts","Onkosten"),id:1,type:6}),a(i)}else e.mayShowOptions=!1,d.alert({title:atrans("boentrylayout","Geen boekingslay-out"),template:atrans("noentrylayouts","Je hebt geen rechten op een boekingslay-out, of er is geen boekingslay-out ingesteld.<br>Neem contact op met je applicatiebeheerder.")})})}}]).controller("FlexdeclarationController",["$scope","$state","$stateParams","$q","$timeout","$ionicTabsDelegate","SharedFlexdeclarationService","ConfigService","MultipleViewsManager",function(e,t,a,o,n,i,l,r,c){function s(){u.getFlexdeclaration(f,p).then(function(t){e.pageTitle=t._id,e.declaration=t,e.loaded=!0})}function d(){e.tabs=[{title:"Actueel",name_id:"tabActual"},{title:"Betaald",name_id:"tabPayed"}],e.useTabs=e.tabs.length>1}var u=l.getFlexdeclarationService(),f=a.id,p=a.mode;e.yestext=atrans("yes","Ja"),e.notext=atrans("no","Nee"),e.isFav=!1,e.loaded=!1,e.showplaceholder=c.isActive()?!0:!1,d(),e.pageTitle=c.isActive()?atrans("flexdeclarations","Declaraties"):atrans("flexdeclaration","Declaratie"),null!=f&&(e.declarationId=f,s(e.declarationId,p)),c.updated("flexdeclarations-detail",function(t){e.loaded=!1,f=t.declarationId,p=t.mode,e.showplaceholder=!1,s(),e.selectFlexdeclarationTab(0)}),e.$on("$ionicSlides.sliderInitialized",function(t,a){e.slider=a.slider,i.$getByHandle("tabsflexdeclaration").select(0)}),e.$on("$ionicSlides.slideChangeStart",function(e,t){n(function(){i.$getByHandle("tabsflexdeclaration").select(t.slider.activeIndex)},1)}),e.$on("$ionicView.beforeEnter",function(){c.setScope(e),r.getConfig().then(function(t){e.mayshowdeclaration=!(isVersionOrHigher(t,"Profit12")||-1!=t.modules.indexOf(24)),-1==t.modules.indexOf(24)?e.gotoPage("menu.home"):c.isActive()||(f&&p&&s(e,t),e.flexdeclarationSlider&&n(function(){e.flexdeclarationSlider&&e.flexdeclarationSlider.onResize(!0)},400))}),TimesheetService.loadEntryLayouts(e,!0)["finally"](function(){e.sel&&e.sel.selectedLayout&&(e.maySelectLayout=e.sel.entryLayouts&&e.sel.entryLayouts.length>1,e.mayShowOptions=e.maySelectLayout)})}),e.selectLayout=function(){TimesheetService.loadEntryLayouts(e,!0,!0)["finally"](function(){e.sel&&e.sel.selectedLayout?(e.maySelectLayout=e.sel.entryLayouts.length>0,e.canBookCosts=e.sel.selectedLayout.info.settingFields.Cost.value,e.mayShowOptions=e.maySelectLayout||e.sel.selectedLayout.info.actions.length>0):e.mayShowOptions=!1})},e.selectFlexdeclarationTab=function(t){e.slider&&e.slider.activeIndex!=t&&e.slider.slideTo(t)},e.goToPlacement=function(e){r.getConfig().then(function(a){-1!=a.modules.indexOf(24)&&(c.isActive()?c.updateView("placements-detail",{placementId:e,mode:0}):t.go("menu.placement",{placementId:e,mode:0}))})}}]).controller("FlexdeclarationRearowsController",["$scope","$state","$ionicPopover","$q","$stateParams","$ionicActionSheet","$timeout","$ionicTabsDelegate","$ionicHistory","SharedFlexdeclarationService","ConfigService","MultipleViewsManager","ListServiceFactory","DatePickerService","$ionicPopup","UserService","TimesheetServiceFactory","SubjectServiceFactory","TaskService","$ionicSlideBoxDelegate",function(e,t,a,o,n,l,r,c,s,d,u,f,p,m,y,g,h,w,S,b){function v(){e.loading=!0,e.fromTask?L.getFlexdeclaration(e.declarationId,0,e.fromTask).then(function(t){if(!t||"undefined"==typeof t)throw s.goBack(),new FriendlyException({title:atrans("cannotopendeclaration","Kan de declaratie niet openen"),message:atrans("cannotopendeclarationnorightsfordeclaration","Kan de declaratie niet openen. Je hebt geen rechten om deze declaratie te openen.")});e.year=t.year,e.periodtable=t.periodtable,e.declarationCode=t.declaration,e.mode=0,e.editmode=!e.readonly,e.readonly&&(e.resubmit=!1),e.placement={placement_id:t.placement_id,placement_code:t.placement_code,description:"",func_title:t["function"]}})["finally"](function(){e.loading=!0,L.getReaRows(e.year,e.period,e.declarationId,e.placement.placement_id,e.forceRefresh,e.fromTask).then(function(t){if(!t||0==t.length)throw s.goBack(),new FriendlyException({title:atrans("cannotopendeclaration","Kan de declaratie niet openen"),message:atrans("cannotopendeclarationnorightsfordeclaration","Kan de declaratie niet openen. Je hebt geen rechten om deze declaratie te openen.")});e.forceRefresh=!1,R(t),e.reaRows=t,e.period=t[0].period,e.placement.description=t[0].project,e.pageTitle=e.year+" | Periode "+e.period,C.handleHeaders(e.reaRows,orderbyField,e.reaRows[e.reaRows.length-1]),e.$broadcast("scroll.refreshComplete")})["finally"](function(){e.resubmit&&x(),e.loading=!1,I()})}):e.placement?(e.loading=!0,L.getReaRows(e.year,e.period,e.declarationId,e.placement.placement_id,e.forceRefresh).then(function(t){e.forceRefresh=!1,R(t),e.reaRows=t,e.pageTitle=e.year+" | Periode "+e.period,C.handleHeaders(e.reaRows,orderbyField,e.reaRows[e.reaRows.length-1]),e.$broadcast("scroll.refreshComplete")})["finally"](function(){e.resubmit&&x(),e.loading=!1,0==e.reaRows.length?(e.showplaceholder=!0,e.norearows=!0):(e.showplaceholder=!1,e.norearows=!1),I()})):(e.showplaceholder=!0,e.loading=!1)}function x(){L.getSubjectIdFromDeclarationId(e.declarationId).then(function(t){t&&(e.subject=t,P.getReactionsBySubject(e.subject[0].guid).then(function(t){e.reactions=t,e.latestreaction=t[0]}))})}function R(t){for(var a=0;a<t.length;a++)t[a].mayedit&&t[a].mayedit===!0&&e.editmode?t[a].activeslide=1:t[a].activeslide=0}function F(e){L.getSingleReaRow(e._id).then(function(t){e.amount=t.amount,e.costpriceamount=t.costpriceamount,1==e.itemtype&&(e.amountDatetime=k(e.amount))})["finally"](function(){e.edit=!1,e.busy=!1})}function k(e){var t=Math.floor(e),a=parseFloat(e%1*60).toFixed(0),o=new Date;return o.setUTCHours(t),o.setUTCMinutes(a),o}function I(){L.getPeriodtable(e.periodtable,e.year,e.period).then(function(t){e.periodData=t[0],T(t[0].date_from,t[0].date_to),D(),$(t[0].date_from,t[0].date_to)})}function T(t,a){for(var o={},n=new Date(t),i=new Date(a);i>=n;)o[n]={hours:0},n.setDate(n.getDate()+1);e.dateDict=o}function D(){for(var t=0;t<e.reaRows.length;t++){var a=new Date(e.reaRows[t].date);e.dateDict[a]&&"1"==e.reaRows[t].itemtype&&(e.dateDict[a].hours+=e.reaRows[t].amount)}}function $(t,a){for(var o=new Date(t),n=new Date(a);n>=o;){if(e.dateDict[o].hours<8){e.bookingDate=o;break}o.setDate(o.getDate()+1)}e.bookingDate||(e.bookingDate=o)}var L=d.getFlexdeclarationService(),C=p.getInstance(),B=h.getInstance(),P=w.getInstance();e.year=n.year,e.period=n.period,e.periodtable=n.periodtable,e.declarationId=n.id,e.declarationCode=n.code,e.mode=n.mode,e.editmode=n.editmode,e.readonly=n.readonly,e.placement=n.placement,e.fromTask=n.fromTask,e.resubmit=e.fromTask||e.editmode&&isNotEmpty(e.declarationId)&&0!=e.declarationId,e.submittext=e.resubmit?atrans("suretoresubmitdeclaration","Weet je zeker dat je deze declaratie opnieuw wilt indienen?"):atrans("suretosubmitdeclaration","Weet je zeker dat je deze declaratie wilt indienen?"),e.refreshText=atrans("refreshtext","Laat los om te verversen"),e.loading=!0,orderbyField={ctype:"5",defname:"itemtype_desc",dtype:"3",id:"itemtype_desc",name:"Type item"},f.updated("flexdeclarations-detail",function(t){e.year=t.year,e.period=t.period,e.periodtable=t.periodtable,e.declarationId=t.id,e.declarationCode=t.code,e.mode=t.mode,e.readonly=t.readonly,e.editmode=t.editmode,e.placement=t.placement,e.fromTask=t.fromTask,e.resubmit=e.fromTask||e.editmode&&e.declarationId,v()}),e.$on("$ionicView.enter",function(){e.loading=!0,n.fromTask&&(e.declarationId=n.id,e.fromTask=n.fromTask,e.action=n.action),v()}),e.refresh=function(){e.loading=!0,e.forceRefresh=!0,v()},e.editReaRow=function(t){for(i=0;i<e.reaRows.length;i++)if(e.reaRows[i]._id!=t._id&&e.reaRows[i].edit){var a=!0,n=i;if(!e.reaRows[n].isChanged)return e.reaRows[n].edit=!1,t.edit=!0,o(function(e,t){e(!1)});y.confirm({title:"De wijzigingen worden niet opgeslagen.<br /> Weet je zeker dat je door wilt gaan?",subTitle:"",okText:"Ja",cancelText:"Nee"}).then(function(a){return a?(F(e.reaRows[n]),e.reaRows[n].edit=!1,e.reaRows[n].isChanged=!1,t.edit=!0,!0):!1})}return a?o(function(e,t){e(!1)}):(t.edit=!0,o(function(e,t){e(!0)}))},e.cancelReaRow=function(e){F(e)},e.deleteReaRow=function(t){e.skipDelete?e.skipDelete=!1:t.mayedit&&y.confirm({title:"Weet je zeker dat je deze regel wilt verwijderen?",subTitle:"",okText:"Ja",cancelText:"Nee"}).then(function(a){a?(t.busy=!0,L.deleteSingleReaRow(t).then(function(t){t&&(SessionStorage.setItem("ReloadFlexDeclarations","1"),e.forceRefresh=!0,v())},function(a){e.skipDelete=!0,b.slide(t.mayedit?1:0,100)})["finally"](function(e){})):(e.skipDelete=!0,b.slide(t.mayedit?1:0,100))})},e.saveReaRow=function(t){e.editmode&&t.mayedit?(t.edit=!1,v()):cancelReaRow(t)},e.submitDeclaration=function(){e.resubmit?e.subject[0]&&e.subject[0].guid&&P.getWorkflowActions(e.subject[0].guid).then(function(a){for(var o=0;o<a.rows.length;o++)if(200===a.rows[o].ActionTypeId){var n=a.rows[o];break}if(n)if("NotMandatory"===n.ReactionMandatoryType){var i={taskid:e.subject[0].guid_task,action:n,workflowid:e.subject[0].guid_workflow,reactionType:{value:"I"}};S.executeAction(e.subject[0].guid,null,i).then(function(){s.goBack()})}else t.go("menu.subjectactions",{subjectId:e.subject[0].guid,actionId:n.actionId},{reload:!0})}):y.confirm({title:e.submittext,subTitle:"",okText:"Ja",cancelText:"Nee"}).then(function(t){t&&L.submitDeclaration(e.placement.placement_code,e.year,e.period).then(function(t){SessionStorage.setItem("ReloadFlexDeclarations","1"),f.isActive()?(e.year=null,e.period=null,e.declarationId=null,e.declarationCode=null,e.mode=null,e.editmode=null,e.placement=null,e.reaRows=null,e.gotoPage("menu.flexdeclarations")):s.goBack()})})},a.fromTemplateUrl("popoverOptions.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.openBookingScreen=function(a){a.mayedit&&(e.forceRefresh=!0,B.loadEntryLayouts(e,!0)["finally"](function(){e.sel&&e.sel.selectedLayout&&e.editReaRow(a).then(function(){var o={rowid:a._id,type:a.itemtype,mayDelete:a.mayedit,callback:function(t){SessionStorage.setItem("ReloadFlexDeclarations","1"),t===!0&&a.mayedit?y.confirm({title:"Weet je zeker dat je deze regel wilt verwijderen?",subTitle:"",okText:"Ja",cancelText:"Nee"}).then(function(t){t?(reaRow.busy=!0,L.deleteSingleReaRow(reaRow).then(function(e){})["finally"](function(t){e.previousPage()})):e.previousPage()}):e.previousPage()}};t.go("menu.timesheetswizard",{selection:o},{reload:!0})})}))},e.newReaRow=function(){B.loadEntryLayouts(e,!0)["finally"](function(){function a(a){r(function(){if(document.body.lastChild&&document.body.lastChild.firstChild){var e=window.getComputedStyle(document.body.lastChild.firstChild);"matrix(1, 0, 0, 1, 0, 0)"!=e["-webkit-transform"]&&(document.body.lastChild.firstChild.style["-webkit-transform"]="matrix(1, 0, 0, 1, 0, 0)")}},500),l.show({buttons:a,titleText:atrans("book","Boeken"),cancelText:atrans("cancel","Annuleren"),cancel:function(){},buttonClicked:function(o){e.forceRefresh=!0,g.getUser().then(function(n){var i={type:a[o].type,date:e.bookingDate?e.bookingDate:new Date,defaultFields:{EmId:{value:e.placement.employee_id,description:e.placement.employee_id},PcId:{value:e.placement.placement_id,extvalue:e.placement.placement_code,description:e.placement.organisation?e.placement.organisation:e.placement.description}},callback:function(){SessionStorage.setItem("ReloadFlexDeclarations","1"),e.previousPage(),v()},skipFields:["PrId"]};t.go("menu.timesheetswizard",{selection:i},{reload:!0})})}})}if(e.sel&&e.sel.selectedLayout){var o=e.sel.selectedLayout.info.settingFields.Cost.value,n=new Array({text:"<i class='icon iconHide'></i>"+atrans("bookinghours","Uren"),id:0,type:1});o&&n.push({text:"<i class='icon iconHide'></i>"+atrans("bookingcosts","Onkosten"),id:1,type:6}),e.maySelectLayout=e.sel.entryLayouts&&e.sel.entryLayouts.length>1,e.mayShowOptions=e.maySelectLayout,a(n)}else e.mayShowOptions=!1,y.alert({title:atrans("boentrylayout","Geen boekingslay-out"),template:atrans("noentrylayouts","Je hebt geen rechten op een boekingslay-out, of er is geen boekingslay-out ingesteld.<br>Neem contact op met je applicatiebeheerder.")})})}}]);