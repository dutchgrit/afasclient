function getContactHREF(e){switch(e.type){case"PER":case"PRS":case"ORG":return"#/menu/contact/"+encodeURIComponent(e.guid)}}function getSubjectHREF(e){return"#/menu/subject/"+encodeURIComponent(e.guid)+"/"}angular.module("contacts.controller",["AfasServices"]).factory("SharedContactService",["ContactServiceFactory",function(e){var t=e.getInstance();return{getContactService:function(){return t}}}]).factory("SharedContactListService",["ListServiceFactory",function(e){var t=e.getInstance();return t.getHREFCallback=getContactHREF,t.itemHeight="70",{getListService:function(){return t}}}]).controller("ContactsController",["$scope","$state","$ionicPopover","$templateCache","$ionicPopup","SharedContactService","SharedContactListService","ConfigService","SearchService","$timeout","maxTakeContacts","$ionicScrollDelegate","ConnectorService","MultipleViewsManager",function(e,t,n,o,a,c,s,r,i,l,d,u,p,g){e.query="",e.contacts=[],e.total=0,e.searched=!1,e.noresults=!1,e.noentry=!0,e.showhint=!0,o.put("modules/contact/contact.html"),e.searchplaceholder=atrans("contactsplaceholder","Zoek naar persoon, organisatie of postcode"),e.pageTitle=atrans("searchcontacts","Zoek naar contacten");var h=s.getListService(),f=c.getContactService();e.$on("$ionicView.beforeEnter",function(){e.landscape=e.isLandscape(),e.selectedGuid=void 0}),e.$on("$ionicView.enter",function(){e.searched||document.getElementById("searchbarContact").focus()}),e.ShowRecentSearches=function(){i.getSearchHistory("Contacts").then(function(t){e.recent=t,t.length>0&&(e.showhint=!1)})},e.HideRecentSearches=function(){l(function(){e.showhint=!0,e.recent=0},200)},e.clickRecent=function(t){e.query=t,e.searchContacts()},e.searchContacts=function(){""==e.query?(e.contacts=[],e.noentry=!0,e.noresults=!1):(e.noentry=!1,e.noresults=!1,e.moreresults=!1,e.skip=0,f.searchContacts(e.query).then(function(t){f.loadContactImages(t),t.length>0&&t.length%d===0&&(e.moreresults=!0,e.skip=t.length),e.contacts=h.divideList(t,1,"search_term"),e.total=t.length,e.filter.type="All",e.searched=!0,e.recent=null,i.setSearchHistory(e.query,"Contacts"),u.$getByHandle("contacts").scrollTop(),hideKeyboard()}))},e.gotoContactDetail=function(n){g.isActive()?(e.selectedGuid=n,g.updateView("contacts-detail",{contactId:n})):t.go("menu.contact",{contactId:n})},e.getContactCountText=function(){for(var t=0,n=atrans("generalcontact","contact"),o=atrans("generalcontacts","contacten"),a=0;a<e.contacts.length;a++)"DIVIDER"!=e.contacts[a].lineType&&t++;switch(e.filter.type){case"PER":n=atrans("person","~App~persoon"),o=atrans("persons","~App~personen");break;case"PRS":n=atrans("contact","~App~contactpersoon"),o=atrans("contacts","~App~contactpersonen");break;case"ORG":n=atrans("organisation","organisatie"),o=atrans("organisations","organisaties")}switch(t){case 0:return atrans("notfound","Geen {0} gevonden",n);case 1:return atrans("itemfound","1 {0} gevonden",n);default:return atrans("itemsfound","{0} {1} gevonden",t,o)}},e.getMoreContactsText=function(){for(var t=0,n="contacten",o=0;o<e.contacts.length;o++)"DIVIDER"!=e.contacts[o].lineType&&t++;switch(e.filter.type){case"PER":n=atrans("persons","~App~personen");break;case"PRS":n=atrans("contacts","~App~contactpersonen");break;case"ORG":n=atrans("organisations","organisaties")}return atrans("moreitemsfound","eerste {0} {1} gevonden ",t,n)},e.getMoreContacts=function(){e.skip>0&&f.searchContacts(e.query,e.skip).then(function(t){f.loadContactImages(t),e.moreresults=t.length>0&&t.length%d===0,e.contacts=h.divideList(t,1,"search_term"),e.total=t.length,e.filter.type="All",e.searched=!0,e.recent=null,e.skip=t.length})},e.clearContacts=function(){e.query="",e.contacts=[],e.noentry=!0,e.noresults=!1,e.searched=!1,e.total=0},e.filter={type:"All"},e.backToHome=function(){t.go("menu.home",{},{reload:!0})},e.changeFilter=function(t){if(e.contacts.length>=0)if(t==e.filter.type)e.filter.type="All",e.contacts=h.divideList(f.getCachedContacts(),1,"search_term");else{var n=f.getContactsByType(t);n.length>=0&&(e.filter.type=t,"PER"==t||"PRS"==t?e.contacts=h.divideList(n,1,"person"):e.contacts=h.divideList(n,1,"name"),u.$getByHandle("contacts").scrollTop())}},e.removeItem=function(e,t){e.preventDefault(),e.stopPropagation(),i.removeItem(t,"Contacts")}}]).controller("ContactController",["$scope","$stateParams","$ionicHistory","$state","$ionicPopover","$ionicTabsDelegate","$ionicScrollDelegate","$timeout","ConnectorService","ContactServiceFactory","SharedContactService","SubjectServiceFactory","PictureService","SharedContactListService","ListServiceFactory","SearchService","ConfigService","EnvConfigService","LocalStorageService","maxListTake","MultipleViewsManager",function(e,t,n,o,a,c,s,r,i,l,d,u,p,g,h,f,m,y,b,v,S){function C(t){R(),H=!1,P=!1,_.getContact(t).then(function(t){null!=t&&y.getEnvConfig().then(function(n){"0"==n.privatetabemp&&null!=t.employee_id&&(delete t.street,delete t.house_number,delete t.country,delete t.city,delete t.postal_code,delete t.phone_personal,delete t.mobile_personal,delete t.email_personal),t.descriptionmailto=atrans("contactperson","Contactpersoon")+" ",t.descriptionmailto+=": "+encodeURIComponent(t.name),b.getItem("loginkey").then(function(e){var n="https://www.afaspocket.nl/contact/"+t.guid+"?"+e;t.bodymailto=encodeURIComponent(atrans("openlinkcontact","Open deze contactpersoon door op de volgende link te klikken:")+"\r\n\r\n"+n+"\r\n\r\n"+atrans("noaccountemail","Nog geen Afas Pocket account? Meld je dan aan met je profit gebruikersnaam en omgevingsleutel {0}.",e.toUpperCase())),t.qrurl=n}),"PRS"==t.type?e.googleLink="https://google.com/search?q="+encodeURIComponent(t.person+" "+t.name):e.googleLink="https://google.com/search?q="+encodeURIComponent(t.name),e.googleLink=e.googleLink.replace("'","%27").replace('"',"%22"),_.getGoogleMapsLinkAndImage(e,t),void 0!=t.website&&(t.website.indexOf("http://")>=0&&(t.website=t.website.split("http://")[1]),-1==t.website.indexOf("https://")&&(t.website="https://"+t.website),t.website.indexOf("javascript:")>=0&&(t.website="invalid URL")),"ORG"==t.type&&(e.titleLinks=atrans("personsUpper","Personen")),"PER"==t.type&&(e.titleLinks=atrans("organizations","Organisaties")),"PRS"==t.type&&(e.titleLinks=atrans("links","Koppelingen")),e.contact=t,e.loaded=!0,"PER"!=t.type&&"ORG"!=t.type||!t.image_id?"PRS"==t.type&&(t.image_id_person?i.getImageData(t.image_id_person,2).then(function(t){e.contact.imageUrl=t.url}):t.image_person_guid&&t.image_person_filename&&i.getFileData(t,"image_person_guid","image_person_filename").then(function(t){e.contact.imageUrl="data:"+t.mimetype+";base64,"+t.filedata})):i.getImageData(t.image_id,2).then(function(t){e.contact.imageUrl=t.url});var o=0;void 0==t.city&&o++,void 0==t.phone_work&&o++,void 0==t.phone_personal&&o++,void 0==t.mobile_work&&o++,void 0==t.mobile_personal&&o++,void 0==t.email_work&&o++,void 0==t.email_personal&&o++,void 0==t.website&&o++,void 0==t.birth_date&&o++,void 0==t.contact.imageSrc&&o++,o>6&&(e.showgoogle=!0)})})}function R(){e.slider&&(null==n.forwardView()||"menu.subject"!=n.forwardView().stateName)&&(e.showType="general",r(function(){try{e.slider.slideTo(0,1,!1)}catch(t){}},400),c.$getByHandle("tabscontact").select(0))}var j=0;e.searchplaceholderSubject=atrans("subjectSearchplaceholder","Zoek naar een dossieritem"),e.searchplaceholderRelated=atrans("relatedSearchplaceholder","Zoek naar een contactpersoon"),e.refreshText=atrans("refreshtext","Laat los om te verversen"),e.showType="general",e.showmore_subjects=!1,e.loaded=!1,e.refreshing=!1,e.showgoogle=!1,e.titleGeneral=atrans("general","Algemeen"),e.titleSubject=atrans("subject","Dossier"),e.titleContacts=atrans("contactsUpper","~App~Contacten"),e.titleLinks=atrans("personsUpper","Personen");var w="",k=h.getInstance();k.itemHeight="90",k.getHREFCallback=getSubjectHREF;var _=d.getContactService(),I=g.getListService(),$=l.getInstance(),L=u.getInstance(),P=!1,H=!1;e.queryData={},e.$on("$ionicSlides.sliderInitialized",function(t,n){e.slider=n.slider}),e.$on("$ionicSlides.slideChangeStart",function(e,t){r(function(){c.$getByHandle("tabscontact").select(t.slider.activeIndex)},1)}),S.isActive()&&(e.showplaceholder=!0),S.updated("contacts-detail",function(t){var n=t.contactId;n&&(e.showplaceholder=!1,e.contact=null,C(n))}),e.$on("$ionicView.unloaded",function(){e.slider=void 0}),e.$on("$ionicView.enter",function(){null==n.forwardView()&&R(),S.isActive()&&e.slider&&r(function(){e.slider.onResize(!0)},400),m.getConfig().then(function(e){-1==e.modules.indexOf(3)?o.go("menu.home",{},{reload:!0}):t.contactId&&C(t.contactId)})}),a.fromTemplateUrl("popoverOptions.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.$on("$destroy",function(){e.popover.remove()}),e.scrollTop=function(){s.$getByHandle("contact").scrollTop(!0)},e.loadMoreSubjects=function(){e.loadingMore||(e.loadingMore=!0,""!=e.queryData.subjectQuery&&e.queryData.subjectQuery!=w?(w=e.queryData.subjectQuery,j=0,e.subjects=[]):j+=v,L.getSubjectsByContact(e.contact,w,j,v).then(function(t){e.showmore_subjects=t.length>=v;for(var n=0;n<t.length;n++)e.subjects.push(t[n]);e.subjects=k.divideList(e.subjects,3,"submitdate",2),e.$broadcast("scroll.infiniteScrollComplete")})["finally"](function(){e.loadingMore=!1,e.$broadcast("scroll.refreshComplete"),s.$getByHandle("contact").resize()}))},e.show=function(t){switch(t){case 0:e.showType="general";break;case 1:e.showType="subjects";break;case 2:e.showType="contacts"}e.slider&&e.slider.activeIndex!=t&&e.slider.slideTo(t),void 0!=e.contact&&(s.$getByHandle("contact").scrollTop(),"subjects"!=e.showType||P||(P=!0,getSubjects()),"contacts"!=e.showType||H||(H=!0,"PRS"!=e.contact.type?$.searchRelatedContacts(e.contact).then(function(t){_.loadContactImages(t),"ORG"==e.contact.type&&(e.relatedContacts=I.divideList(t,1,"person")),"PER"==e.contact.type&&(e.relatedContacts=I.divideList(t,1,"name")),e.totalrelatedcontacts=t.length}):$.getRelatedPRS(e.contact).then(function(t){_.loadContactImages(t);for(var n=0;n<t.length;n++)t[n].lineType="HREF";e.relatedContacts=t,e.totalrelatedcontacts=t.length})))},e.searchCachedSubjects=function(){e.HideRecentSearches("subjects"),j=0,w=e.queryData.subjectQuery,L.getSubjectsByContact(e.contact,e.queryData.subjectQuery,j,v).then(function(t){e.showmore_subjects=t.length>=v,e.subjects=k.divideList(t,3,"submitdate",2),e.totalsubjects=t.length,e.$broadcast("scroll.refreshComplete"),e.refreshing=!1,hideKeyboard()})},e.clearSubjects=function(){e.queryData.subjectQuery="",e.loadedSubjects=0,e.subjects=0,e.HideRecentSearches("subjects"),getSubjects()},e.searchRelatedContacts=function(){e.HideRecentSearches("relatedContacts"),$.searchCachedContacts(e.contact,e.queryData.relatedQuery).then(function(t){_.loadContactImages(t),"ORG"==e.contact.type&&(e.relatedContacts=I.divideList(t,1,"person")),"PER"==e.contact.type&&(e.relatedContacts=I.divideList(t,1,"name")),"PRS"==e.contact.type&&(e.relatedContacts=I.divideList(t,1,"person")),f.setSearchHistory(e.queryData.relatedQuery,"relatedContacts"),hideKeyboard()})},e.clearRelatedContacts=function(){e.queryData.relatedQuery="",e.HideRecentSearches("relatedContacts"),$.searchRelatedContacts(e.contact).then(function(t){"ORG"==e.contact.type&&(e.relatedContacts=I.divideList(t,1,"person")),"PER"==e.contact.type&&(e.relatedContacts=I.divideList(t,1,"name")),"PRS"==e.contact.type&&(e.relatedContacts=I.divideList(t,1,"person"))})},e.refreshSubjects=function(){"subjects"==e.showType&&(e.refreshing=!0,e.queryData.subjectQuery="",e.loadedSubjects=0,e.HideRecentSearches("subjects"),getSubjects())},getSubjects=function(){w="",e.queryData.subjectQuery="",L.getSubjectsByContact(e.contact,"",j,v).then(function(t){e.showmore_subjects=t.length>=v,e.subjects=k.divideList(t,3,"submitdate",2),e.totalsubjects=t.length,e.$broadcast("scroll.refreshComplete"),e.refreshing=!1})},e.saveContact=function(){e.popover.hide(),_.saveContact(e.contact)},e.sendSubject=function(){switch(e.popover.hide(),e.contact.type){case"PER":e.gotoPage("menu.newsubjects",{fillInData:{S_Bc:{id:e.contact.number_person,name:e.contact.name}}});break;case"PRS":e.gotoPage("menu.newsubjects",{fillInData:{S_Bc:{id:e.contact.organization_person_number,name:e.contact.name},S_Cd:{id:e.contact.guid,name:e.contact.person}}});break;case"ORG":e.gotoPage("menu.newsubjects",{fillInData:{S_Bc:{id:e.contact.organization_person_number,name:e.contact.name}}})}},e.goTo=function(e){o.go("menu.contacts.contact",{contactId:e},{reload:!1})},e.backToSearch=function(){o.go("menu.contacts.list",{},{reload:!1})},e.ShowRecentSearches=function(t){f.getSearchHistory(t).then(function(n){"subjects"==t&&(e.recentSubjects=n),"relatedContacts"==t&&(e.recentRelated=n)})},e.HideRecentSearches=function(e){"subjects"==e&&r(HideSub,200),"relatedContacts"==e&&r(HideRel,200)},HideSub=function(){e.recentSubjects=0},HideRel=function(){e.recentRelated=0},e.clickRecent=function(t,n){"relatedContacts"==n?(e.queryData.relatedQuery=t,e.searchRelatedContacts()):"subjects"==n&&(e.queryData.subjectQuery=t,e.searchCachedSubjects())},e.removeItem=function(e,t,n){e.preventDefault(),e.stopPropagation(),f.removeItem(t,n)}}]);