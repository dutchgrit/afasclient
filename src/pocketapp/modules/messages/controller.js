angular.module("messages.controller",["AfasServices"]).controller("MessagesController",["$scope","$ionicHistory","LocalStorageService","ConfigService","$state","$rootScope",function(e,t,s,n,o,a){e.showmore=!1,e.fetchData={},e.pageTitle=atrans("messages","Berichten"),e.loadingmore=!1,e.nodeviceregistered=a.nodeviceregistered,e.$on("$ionicView.beforeEnter",function(){e.refreshSenders()}),e.goToNewMessage=function(){o.go("menu.newmessage",{},{reload:!0})},e.gotoMessageBoard=function(e){o.go("menu.messageboard",{sender:e},{reload:!0})}}]).controller("MessageBoardController",["$scope","$state","$timeout","LocalStorageService","ConnectorService","$ionicScrollDelegate","maxMessages","$rootScope","question",function(e,t,s,n,o,a,r,i,l){e.pageTitle=atrans("messageboard","Berichten overzicht"),e.$on("$ionicView.beforeEnter",function(){null!=t.params.sender&&(e.sender=t.params.sender),e.form={},e.refreshMessages(),e.refreshSenders(),e.sender&&(e.chatback="__Profit__"!=e.sender.Id),s(function(){var e=a.$getByHandle("messages").getScrollView();e&&a.$getByHandle("messages").scrollTo(0,e.__content.scrollHeight)},10)}),e.$on("keyboardOpenEvent",function(){s(function(){var e=a.$getByHandle("messages").getScrollView();e&&a.$getByHandle("messages").scrollTo(0,e.__content.scrollHeight)},10)}),e.deleteall=function(){l(atrans("confirmdeletemessages","Weet je zeker dat je alle berichten wilt verwijderen?")).then(function(t){t&&e.deleteMessages(e.sender.Id)})},e.goToSender=function(){e.sender.TeamId?e.gotoPage("menu.team",{id:e.sender.TeamId}):"__Profit__"!=e.sender.Id&&e.gotoPage("menu.employee",{id:e.sender.Id})},e.sendText=function(){var t=e.form.messageText;if(e.form.messageText="",isNotEmpty(e.sender.Id)&&isNotEmpty(t)){var s=[];n.getItem("messages").then(function(e){isNotEmpty(e)&&(s=JSON.parse(e),s.length>r&&(s=s.splice(s.length-r)))})["finally"](function(){var a=new Date;a=getGMTDate(a);var i;i=e.sender.TeamId?{SendMessage:!0,Read:!0,Data:{message:t},ToTeamName:e.sender.Name,ToTeamId:e.sender.Id,Date:a}:{SendMessage:!0,Read:!0,Data:{message:t},ToEmployeeName:e.sender.Name,ToEmployeeId:e.sender.Id,ToEmployeeImageId:e.sender.ImageId,Date:a},s.push(i),s.length>r&&(s=s.splice(s.length-r)),n.setItem("messages",JSON.stringify(s)),e.refreshMessages(),e.sender.TeamId?o.executeData("PocketMessage",{fields:["OrgUnitId","Message"],values:[e.sender.Id,t]}).then(function(){},function(){i.Failed=!0,n.setItem("messages",JSON.stringify(s)),e.refreshMessages()}):o.executeData("PocketMessage",{fields:["EmployeeId","Message"],values:[e.sender.Id,t]}).then(function(){},function(){i.Failed=!0,n.setItem("messages",JSON.stringify(s)),e.refreshMessages()})})}}}]).controller("NewMessageController",["$scope","$state","$timeout","UserService","maxMessages","AvailabilityService","ConnectorService","EmployeeServiceFactory","LocalStorageService","ModalSearchService","SearchService",function(e,t,s,n,o,a,r,i,l,c,m){var d,g=i.getInstance();e.form={},e.pageTitle=atrans("newmessage","Nieuw bericht"),n.getUser().then(function(t){var s=t.employee_id;if("undefined"!=typeof s&&null!=s){var n=new Date,o=new Date;o.setDate(o.getDate()+7),a.getAvailability("1",n,o,s).then(function(t){e.orgunits=[];for(var n in t.Departments)t.Departments.hasOwnProperty(n)&&e.orgunits.push({id:n,description:t.Departments[n].Name});g.getEmployee(s).then(function(t){if(null!=t)for(var s=0;s<e.orgunits.length;s++)t.org_unit_id==e.orgunits[s].id&&(e.form.orgunit=e.orgunits[s])})})}}),e.employeePlaceholder=atrans("choosereplacementemployee","Vul hier een medewerkerscode in"),e.textplaceholder=atrans("messageplaceholder","Typ uw bericht hier..."),e.openModal=function(t){c.openModal(e,t)},e.closeModal=function(){e.modal.hide()},e.selectTab=function(t){e.modal&&!e.modal.loading&&(e.modal.showType=t)},e.loadMore=function(){c.loadMore(e)},e.search=function(t){c.search(e,t)},e.clearSearch=function(t){c.clearSearch(e)},e.clickRecent=function(t){e.modal.query=t,c.search(e,t)},e.ShowRecentSearches=function(){c.ShowRecentSearches(e)},e.HideRecentSearches=function(){c.HideRecentSearches(e)},e.validateEntry=function(t){d&&s.cancel(d),d=s(function(){e.form.employee=null,t.length>=1&&n.getUser().then(function(s){g.validateEntry(1,s.employee_id,t).then(function(t){e.selectEmployee(t)})}),d=null},500)},e.selectEmployee=function(t){e.form.employee=t,e.form.employee_entry=t.employee_id,m.setRecentlySelected(t,"recent_employees"),e.modal&&e.modal.hide()},e.sendText=function(){var s=e.form.messageText;if(e.form.messageText="",(isNotEmpty(e.form.employee_entry)||e.form.orgunit)&&isNotEmpty(s)){var n=[];l.getItem("messages").then(function(e){isNotEmpty(e)&&(n=JSON.parse(e),n.length>o&&(n=n.splice(n.length-o)))})["finally"](function(){var a,i=new Date;i=getGMTDate(i),a=e.form.sendtoorgunit?{SendMessage:!0,Read:!0,Data:{message:s},ToTeamName:e.form.orgunit.description,ToTeamId:e.form.orgunit.id,Date:i}:{SendMessage:!0,Read:!0,Data:{message:s},ToEmployeeName:e.form.employee.name,ToEmployeeId:e.form.employee_entry,ToEmployeeImageId:e.form.employee.image_id,Date:i},n.push(a),n.length>o&&(n=n.splice(n.length-o)),l.setItem("messages",JSON.stringify(n)),e.form.sendtoorgunit?r.executeData("PocketMessage",{fields:["OrgUnitId","Message"],values:[e.form.orgunit.id,s]}).then(function(){},function(){a.Failed=!0,l.setItem("messages",JSON.stringify(n)),e.refreshMessages()}):r.executeData("PocketMessage",{fields:["EmployeeId","Message"],values:[e.form.employee_entry,s]}).then(function(){},function(){a.Failed=!0,l.setItem("messages",JSON.stringify(n)),e.refreshMessages()}),t.go("menu.messages",{},{reload:!0})})}}}]);